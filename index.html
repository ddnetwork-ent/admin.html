<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDNetwork(Admin)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-card: #111111;
            --accent-primary: #3b82f6;
            --text-main: #ffffff;
            --text-secondary: #a1a1aa;
            --border-light: rgba(255,255,255,0.1);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --alert-bg: rgba(245, 158, 11, 0.1);
            --alert-border: #f59e0b;
        }
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* LOGIN SCREEN */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--bg-deep);
            z-index: 200;
        }
        .login-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 16px;
            border:1px solid var(--border-light);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-card h2 { margin-bottom:1.5rem; color: white; text-transform: uppercase; letter-spacing: 1px; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border:1px solid var(--border-light);
            border-radius: 8px;
            color: white;
            margin-bottom:1rem;
            font-family: inherit;
            box-sizing: border-box;
            transition: 0.2s;
        }
        textarea { height: 150px; resize: vertical; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-primary); outline: none; background: rgba(59, 130, 246, 0.05); }
        
        button {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            box-sizing: border-box;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.secondary { background: #333; }
        button.danger { background: var(--danger); }
        button.sm-btn { width: auto; padding: 6px 12px; font-size: 0.8rem; }
        button.success { background: var(--success); }

        /* DASHBOARD LAYOUT */
        #dashboard {
            display: none; 
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: row;
        }
        
        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right:1px solid var(--border-light);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }
        .brand {
            font-size:1.1rem;
            font-weight: 800;
            margin-bottom: 3rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 0.5rem;
        }
        .nav-item {
            padding: 12px 1rem;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }
        .logout-btn { margin-top: auto; color: var(--danger); }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-left: 3px solid var(--danger); }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* TABS & TABLES */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .section-header h2 { margin: 0; font-size: 1.5rem; color: white; }

        /* --- FILTER BUTTONS (NEW) --- */
        .ticket-filters {
            display: flex;
            gap: 10px;
            background: var(--bg-card);
            padding: 5px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }
        .filter-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            width: auto;
            margin: 0;
            transition: 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .filter-btn.active { background: var(--accent-primary); color: white; }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            background: var(--bg-card);
            border:1px solid var(--border-light);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Wider for Source column */
        }
        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom:1px solid var(--border-light);
            white-space: nowrap;
        }
        th { background: rgba(255,255,255,0.02); font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-paid, .status-completed { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-open { background: rgba(59, 130, 246, 0.2); color: var(--accent-primary); }
        .role-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }
        .role-admin { background: var(--warning); color: black; }
        .role-user { background: #333; color: var(--text-secondary); }

        .action-btn {
            background: none;
            border:1px solid var(--border-light);
            padding: 6px 12px;
            margin-right: 5px;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: 0.2s;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--text-secondary); }

        /* --- SOURCE BADGES (NEW) --- */
        .source-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-internal { 
            background: rgba(245, 158, 11, 0.15); 
            color: #f59e0b; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .badge-external { 
            background: rgba(59, 130, 246, 0.15); 
            color: #3b82f6; 
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .row-internal {
            background: rgba(245, 158, 11, 0.03); /* Very subtle tint for internal rows */
        }

        /* ADMIN CARDS */
        .admin-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            margin-bottom: 2rem;
        }
        .admin-card h3 { margin-bottom: 1rem; color: white; font-size: 1rem; margin-top: 0; }
        .form-row { margin-bottom: 1rem; text-align: left; }
        .form-row label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-secondary); }
        .helper-text { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }

        /* INTERNAL SUPPORT CARD SPECIFIC */
        .internal-support-card {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid var(--accent-primary);
        }
        .internal-support-card h3 {
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ALERTS */
        .alert-box {
            padding: 1rem;
            border-radius: 8px;
            background: var(--alert-bg);
            border-left: 4px solid var(--alert-border);
            margin-bottom: 1rem;
        }
        .alert-text { font-size: 0.9rem; color: white; font-weight: 600; }

        /* MODAL (GENERAL) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-light);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .modal-content h3 { margin-top: 0; color: white; margin-bottom: 1.5rem; }
        
        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            #dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 0.8rem;
                flex-direction: row;
                position: fixed;
                bottom: 0;
                left: 0;
                top: auto;
                right: 0;
                border-right: none;
                border-top: 1px solid var(--border-light);
                overflow-x: auto;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
                z-index: 50;
            }

            .brand { display: none; }
            .logout-btn { display: none; }

            .nav-item {
                flex: 0 0 auto;
                flex-direction: column;
                gap: 4px;
                margin-bottom: 0;
                padding: 8px 16px;
                font-size: 0.7rem;
                border-radius: 6px;
                border-left: 2px solid transparent;
            }
            .nav-item:hover, .nav-item.active {
                background: rgba(255,255,255,0.05);
                color: white;
                border-left: 2px solid var(--accent-primary);
            }
            .nav-item i { font-size: 1.3rem; color: var(--text-secondary); }
            .nav-item.active i { color: var(--accent-primary); }

            .main-content {
                padding: 1.5rem 1rem;
                margin-bottom: 70px;
            }

            .section-header h2 { font-size: 1.2rem; }
            button { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <div style="margin-bottom: 1.5rem;">
                <i class="ri-shield-keyhole-line" style="font-size: 3rem; color: var(--accent-primary);"></i>
            </div>
            <h2>Internal Portal</h2>
            <form onsubmit="handleAdminLogin(event)">
                <input type="email" id="admin-email" placeholder="Admin Email" required autocomplete="email">
                <input type="password" id="admin-password" placeholder="Password" required autocomplete="current-password">
                <button type="submit">Login</button>
            </form>
            <p id="login-error" style="color: var(--danger); font-size: 0.85rem; margin-top: 1rem; display: none;"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display: none;">
        <div class="sidebar">
            <div class="brand"><i class="ri-shield-user-fill"></i> DDN Admin</div>
            
            <div class="nav-item active" onclick="switchTab('orders')">
                <i class="ri-shopping-bag-3-line"></i> <span>Orders</span>
            </div>
            <div class="nav-item" onclick="switchTab('users')">
                <i class="ri-group-line"></i> <span>Users & Roles</span>
            </div>
            <div class="nav-item" onclick="switchTab('support')">
                <i class="ri-customer-service-2-line"></i> <span>Support</span>
            </div>
            <div class="nav-item" onclick="switchTab('vouchers')">
                <i class="ri-gift-line"></i> <span>Assign Vouchers</span>
            </div>
            <div class="nav-item" onclick="switchTab('promos')">
                <i class="ri-coupon-3-line"></i> <span>Promo</span>
            </div>
            <div class="nav-item" onclick="switchTab('maintenance')">
                <i class="ri-settings-4-line"></i> <span>Config</span>
            </div>
            <div class="nav-item" onclick="switchTab('content')">
                <i class="ri-file-list-3-line"></i> <span>Content</span>
            </div>
            
            <div class="nav-item logout-btn" onclick="handleLogout()">
                <i class="ri-logout-box-r-line"></i> <span>Logout</span>
            </div>
        </div>

        <div class="main-content">
            
            <!-- ORDERS TAB -->
            <div id="tab-orders" class="tab-content active">
                <div class="section-header">
                    <h2>Orders</h2>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        <i class="ri-refresh-line"></i> Live Updates
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Package</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- USERS TAB (UPDATED) -->
            <div id="tab-users" class="tab-content">
                <div class="section-header">
                    <h2>User Management</h2>
                    <p style="font-size: 0.8rem; color: var(--text-secondary);">Edit users and change roles here.</p>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUPPORT TAB (UPDATED: INTERNAL VS EXTERNAL) -->
            <div id="tab-support" class="tab-content">
                <div class="section-header">
                    <h2>Support Desk</h2>
                    <!-- FILTER BUTTONS -->
                    <div class="ticket-filters">
                        <button class="filter-btn active" onclick="filterTickets('all', this)">
                            <i class="ri-list-check"></i> All Tickets
                        </button>
                        <button class="filter-btn" onclick="filterTickets('internal', this)">
                            <i class="ri-bug-line"></i> Internal Team
                        </button>
                        <button class="filter-btn" onclick="filterTickets('external', this)">
                            <i class="ri-user-line"></i> Customers
                        </button>
                    </div>
                </div>

                <!-- INTERNAL REPORT FORM -->
                <div class="admin-card internal-support-card">
                    <h3><i class="ri-bug-line"></i> Report Internal Issue / Bug</h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                        Use this form to report issues with the portal, bugs, or IT requests.
                    </p>
                    
                    <form onsubmit="handleInternalTicketSubmit(event)">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                            <div>
                                <label>Admin Name</label>
                                <input type="text" id="internal-name" placeholder="Your Name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Admin Email (Auto-filled)</label>
                            <input type="email" id="internal-email" readonly style="background: rgba(0,0,0,0.3); cursor: not-allowed;">
                        </div>
                        <div class="form-row">
                            <label>Issue Type</label>
                            <select id="internal-type" required>
                                <option value="Internal Bug">Internal Bug (Portal/DB)</option>
                                <option value="Feature Request">Feature Request</option>
                                <option value="System Error">System Error</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Description</label>
                            <textarea id="internal-message" placeholder="Describe the issue in detail..." required></textarea>
                        </div>
                        <button type="submit" class="success">Submit Internal Ticket</button>
                    </form>
                </div>

                <!-- TICKETS TABLE (UPDATED WITH SOURCE COLUMN) -->
                <div class="table-responsive" style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1rem; color: var(--text-secondary); margin: 1rem 0 1rem 0;">Ticket List</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Case ID</th>
                                <th>Source</th> <!-- NEW COLUMN -->
                                <th>Issue Type</th>
                                <th>Customer</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VOUCHERS TAB -->
            <div id="tab-vouchers" class="tab-content">
                <div class="section-header">
                    <h2>Assign Voucher</h2>
                </div>
                
                <div class="admin-card">
                    <h3>Send Gift Voucher</h3>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                        <div style="grid-column: 1 / -1;">
                            <label>Select Customer</label>
                            <select id="voucher-user-select" style="margin-bottom: 0;">
                                <option value="" disabled selected>Loading Users...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Voucher Code</label>
                            <input type="text" id="voucher-code" placeholder="e.g. GIFT50">
                        </div>
                        <div>
                            <label>Value</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="voucher-val" placeholder="50" step="1">
                                <select id="voucher-type" style="width: auto;">
                                    <option value="fixed">RM</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button onclick="assignVoucher()" style="margin-top: 1rem;">Assign Voucher to User</button>
                </div>

                <div class="table-responsive" style="margin-top: 2rem;">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Recent Voucher Assignments</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Code</th>
                                <th>Value</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="voucher-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PROMOS TAB -->
            <div id="tab-promos" class="tab-content">
                <div class="section-header">
                    <h2>Promo Codes</h2>
                </div>
                
                <div class="admin-card">
                    <h3>Create Global Promo</h3>
                    <form onsubmit="event.preventDefault(); createPromo();">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                            <input type="text" id="new-promo-code" placeholder="Code (e.g. SUMMER)" style="margin:0;" required>
                            <input type="number" id="new-promo-val" placeholder="0.5 (50%)" step="0.01" style="margin:0;" required>
                            <button type="submit" style="width: auto; white-space: nowrap;">Add</button>
                        </div>
                    </form>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Discount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="promo-table-body">
                             <tr>
                                <td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading promos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MAINTENANCE TAB -->
            <div id="tab-maintenance" class="tab-content">
                <div class="section-header">
                    <h2>Site Configuration</h2>
                </div>

                <div class="admin-card">
                    <h3>Maintenance Mode</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">When enabled, users see a warning banner on main site.</p>
                    <div class="form-row">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <label>Enable Maintenance Mode</label>
                            <div style="width: 50px; height: 26px; background: #333; border-radius: 13px; position: relative; cursor: pointer;" onclick="toggleMaintenanceStatus()">
                                <div id="maintenance-toggle-circle" style="width: 20px; height: 20px; background: #555; border-radius: 50%; position: absolute; left: 3px; top: 3px; transition: 0.3s;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Maintenance Message (Red Banner)</label>
                        <input type="text" id="maintenance-msg" placeholder="e.g. Site Down for scheduled update.">
                    </div>
                    
                    <button onclick="saveMaintenanceConfig()" style="margin-top: 1rem;">Save Configuration</button>
                </div>

                <div class="admin-card">
                    <h3>Dynamic Pricing (Optional)</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Override base package prices without changing code.</p>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>HTML Price (RM)</label>
                            <input type="number" id="price-html" placeholder="199">
                        </div>
                        <div>
                            <label>Frontend Price (RM)</label>
                            <input type="number" id="price-frontend" placeholder="599">
                        </div>
                    </div>
                    <button onclick="savePricingConfig()" style="margin-top: 1rem;">Update Prices</button>
                </div>
            </div>

            <!-- CONTENT TAB -->
            <div id="tab-content" class="tab-content">
                <div class="section-header">
                    <h2>Package Details (Features)</h2>
                </div>

                <div class="admin-card">
                    <h3>Frontend Website Details</h3>
                    <p class="helper-text">Enter one feature per line.</p>
                    <div class="form-row">
                        <label>Features List</label>
                        <textarea id="details-frontend" placeholder="e.g. Up to 5 Pages"></textarea>
                    </div>
                    <button onclick="saveContentConfig()" style="margin-top: 1rem;">Save Details</button>
                </div>

                <div class="admin-card">
                    <h3>AI Powered Details</h3>
                    <p class="helper-text">Enter one feature per line.</p>
                    <div class="form-row">
                        <label>Features List</label>
                        <textarea id="details-ai" placeholder="e.g. AI Chatbot Integration"></textarea>
                    </div>
                    <button onclick="saveContentConfig()" style="margin-top: 1rem;">Save Details</button>
                </div>
            </div>

        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Manage User Role</h3>
                <i class="ri-close-line" onclick="closeModal('editUserModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <input type="hidden" id="edit-uid">
            <div class="form-row">
                <label>Full Name</label>
                <input type="text" id="edit-name" placeholder="John Doe">
            </div>
            <div class="form-row">
                <label>Phone Number</label>
                <input type="tel" id="edit-phone" placeholder="0123456789">
            </div>
            <div class="form-row">
                <label>Role (Permissions)</label>
                <select id="edit-role" style="width: 100%;">
                    <option value="user">Standard User</option>
                    <option value="admin">Admin (Full Access)</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveUser()" style="background: var(--success);">Update User</button>
                <button class="secondary" onclick="closeModal('editUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- TICKET MODAL -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Manage Support Ticket</h3>
                <i class="ri-close-line" onclick="closeModal('ticketModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <input type="hidden" id="ticket-id">
            <div class="form-row">
                <label>Ticket Status</label>
                <select id="ticket-status-select" style="width: 100%;">
                    <option value="Open">Open</option>
                    <option value="Resolved">Resolved</option>
                </select>
            </div>
            <div class="form-row">
                <label>Admin Note (Visible to User)</label>
                <textarea id="ticket-admin-note"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveTicket()" style="background: var(--success);">Update Ticket</button>
                <button class="secondary" onclick="closeModal('ticketModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ORDER MODAL -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Manage Order</h3>
                <i class="ri-close-line" onclick="closeModal('orderModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <input type="hidden" id="order-id">
            <div class="form-row">
                <label>Order Status</label>
                <select id="order-status-select" style="width: 100%;">
                    <option value="Pending">Pending</option>
                    <option value="Paid">Paid</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <div class="form-row">
                <label>Admin Notes (Internal)</label>
                <textarea id="order-admin-note"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveOrder()" style="background: var(--success);">Update Order</button>
                <button class="secondary" onclick="closeModal('orderModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
            authDomain: "ddnetwork-database.firebaseapp.com",
            projectId: "ddnetwork-database",
            storageBucket: "ddnetwork-database.firebasestorage.app",
            messagingSenderId: "699127560990",
            appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
        };

        let db, auth;
        let ticketFilter = 'all'; // 'all', 'internal', 'external'
        let ticketCache = []; // Store tickets locally for filtering

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch(e) {
            console.error("Firebase Error", e);
            alert("Error connecting to database.");
        }

        const ADMIN_EMAIL = "ddnetwork.one@outlook.com";
        let allUsers = []; 
        let siteConfig = { maintenance_active: false, message: '', prices: { html: 199, frontend: 599 }, packageDetails: {} };

        // Default Details (Used as fallback)
        const DEFAULT_DETAILS = {
            frontend: [
                "Up to 5 Pages",
                "Animations & Interactions",
                "Contact Forms",
                "WhatsApp Integration"
            ],
            ai: [
                "All Front-End Features",
                "AI Chatbot Integration",
                "Lead Auto-Response",
                "Smart Analytics"
            ]
        };

        // AUTH LOGIC (ROLE CHECK + SUPER ADMIN BOOTSTRAP)
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Fetch user data to check role
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists && doc.data().role === 'admin') {
                        // User is admin
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'flex';
                        
                        // Populate Internal Ticket Form
                        document.getElementById('internal-email').value = user.email;
                        
                        loadDashboardData();
                    } else {
                        // User is not admin
                        auth.signOut();
                        alert("ACCESS DENIED: You do not have permission to access this portal.");
                        document.getElementById('login-screen').style.display = 'flex';
                        document.getElementById('dashboard').style.display = 'none';
                    }
                }).catch((err) => {
                    console.error("Error checking role:", err);
                    alert("Error verifying permissions.");
                });
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;

                    // ==========================================
                    // ONE-TIME SETUP LOGIC (BOOTSTRAP)
                    // ==========================================
                    if (user.email.toLowerCase() === ADMIN_EMAIL) {
                        console.log("Main Admin detected. Bootstrapping Admin Role...");
                        
                        const userRef = db.collection("users").doc(user.uid);
                        
                        userRef.get().then((docSnapshot) => {
                            const currentData = docSnapshot.exists ? docSnapshot.data() : {};
                            
                            userRef.update({
                                role: 'admin',
                                name: currentData.name || "Admin",
                                phone: currentData.phone || "",
                                email: user.email
                            }, { merge: true }).then(() => {
                                alert("SUCCESS: Admin Role Applied Automatically!");
                                window.location.reload();
                            }).catch((err) => {
                                console.error("Bootstrap Error:", err);
                                alert("Error applying admin role: " + err.message);
                            });
                        });
                    } else {
                        console.warn("Unauthorized login attempt.");
                        alert("ACCESS DENIED: You do not have permission to access this portal.");
                        auth.signOut();
                    }
                })
                .catch((error) => {
                    const errBox = document.getElementById('login-error');
                    errBox.innerText = error.message;
                    errBox.style.display = 'block';
                });
        }

        function handleLogout() {
            if(confirm("Are you sure you want to logout?")) {
                auth.signOut();
            }
        }

        function loadDashboardData() {
            // Load Config
            db.collection("config").doc("site_settings").onSnapshot(doc => {
                if(doc.exists) {
                    siteConfig = doc.data();
                    updateMaintenanceUI();
                    updatePricingUI();
                    updateContentUI();
                }
            });

            // Load Orders
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                const tbody = document.getElementById('orders-table-body');
                tbody.innerHTML = '';
                if(snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">No orders found.</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : '-';
                    let statusClass = 'status-pending';
                    if(data.status === 'Paid' || data.status === 'Completed') statusClass = 'status-paid status-completed';
                    if(data.status === 'Cancelled') statusClass = 'status-cancelled';

                    const row = `
                        <tr>
                            <td style="color:var(--text-secondary); font-size:0.9rem;">${date}</td>
                            <td>
                                <div style="font-weight:600;">${data.customerName}</div>
                                <div style="font-size:0.8rem; color:var(--text-secondary);">${data.customerEmail}</div>
                            </td>
                            <td>${data.package}</td>
                            <td style="font-weight:700;">${data.total}</td>
                            <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                            <td>
                                <button class="action-btn" onclick="openOrderModal('${doc.id}', '${data.status}', '${data.adminNote || ''}')">Manage</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });

            // Load Users & Populate Dropdown
            db.collection("users").onSnapshot((snapshot) => {
                const tbody = document.getElementById('users-table-body');
                const select = document.getElementById('voucher-user-select');
                
                allUsers = []; 
                let optionsHTML = '<option value="" disabled selected>Select a User</option>';
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const role = data.role || 'user';
                    const roleClass = role === 'admin' ? 'role-admin' : 'role-user';
                    const roleLabel = role === 'admin' ? 'Admin' : 'User';

                    const userObj = { id: doc.id, ...data };
                    allUsers.push(userObj);

                    const row = `
                        <tr>
                            <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                            <td>${data.name}</td>
                            <td style="font-size:0.9rem;">${data.email}</td>
                            <td>${data.phone}</td>
                            <td>
                                <button class="action-btn" onclick="openEditUser('${doc.id}', '${data.name}', '${data.phone}', '${role}')">Edit / Role</button>
                                <button class="action-btn" onclick="resetUserPass('${data.email}')">Pwd</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                    optionsHTML += `<option value="${doc.id}">${data.name} (${data.email})</option>`;
                });
                select.innerHTML = optionsHTML;
                refreshVoucherTable();
            });

            // Load Tickets
            db.collection("tickets").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                ticketCache = []; // Clear cache and rebuild
                snapshot.forEach(doc => {
                    ticketCache.push({ id: doc.id, data: doc.data() });
                });
                renderTicketTable(); // Render based on filter
            });

            // Load Global Promos
            db.collection("promo_codes").onSnapshot((snapshot) => {
                const tbody = document.getElementById('promo-table-body');
                tbody.innerHTML = '';
                if(snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:2rem;">No promo codes found.</td></tr>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const discountPct = (data.discount * 100).toFixed(0);
                    const row = `
                        <tr>
                            <td style="font-weight:700; color: var(--accent-primary); font-size:1.1rem;">${doc.id}</td>
                            <td style="font-weight:700; color: var(--success);">${discountPct}%</td>
                            <td>
                                <button class="action-btn" style="color: var(--danger); border-color: var(--danger);" onclick="deletePromo('${doc.id}')">Del</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
        }

        // --- TICKET FILTERING & RENDERING (UPDATED) ---
        function filterTickets(type, btnElement) {
            ticketFilter = type;
            
            // Update Button Styles
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            
            renderTicketTable();
        }

        function renderTicketTable() {
            const tbody = document.getElementById('tickets-table-body');
            tbody.innerHTML = '';

            let visibleTickets = ticketCache;

            if (ticketFilter === 'internal') {
                visibleTickets = ticketCache.filter(t => t.data.type.toLowerCase().startsWith("internal"));
            } else if (ticketFilter === 'external') {
                visibleTickets = ticketCache.filter(t => !t.data.type.toLowerCase().startsWith("internal"));
            }

            if(visibleTickets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem; color:var(--text-secondary);">No tickets found for this filter.</td></tr>';
                return;
            }

            visibleTickets.forEach(item => {
                const doc = item;
                const data = item.data;
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : '-';
                let statusClass = 'status-open';
                if(data.status === 'Resolved') statusClass = 'status-paid';

                // DETERMINE SOURCE
                const isInternal = data.type.toLowerCase().startsWith("internal");
                const rowClass = isInternal ? "row-internal" : "";
                const sourceBadge = isInternal 
                    ? `<span class="source-badge badge-internal">Team</span>` 
                    : `<span class="source-badge badge-external">User</span>`;

                const row = `
                    <tr class="${rowClass}">
                        <td style="color:var(--text-secondary); font-size:0.9rem;">${date}</td>
                        <td><span style="font-family:monospace; font-size:0.8rem; color:var(--accent-primary); font-weight:700;">${doc.id}</span></td>
                        <td>${sourceBadge}</td>
                        <td style="font-weight:700;">${data.type}</td>
                        <td>
                            <div style="font-weight:600;">${data.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-secondary);">${data.email}</div>
                        </td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${data.message}</td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        <td>
                            <button class="action-btn" onclick="openTicketModal('${doc.id}', '${data.status}', '${data.adminNote || ''}')">Manage</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- CONTENT LOGIC ---
        function updateContentUI() {
            if(siteConfig.packageDetails) {
                const frontData = siteConfig.packageDetails.frontend || DEFAULT_DETAILS.frontend;
                const aiData = siteConfig.packageDetails.ai || DEFAULT_DETAILS.ai;

                document.getElementById('details-frontend').value = frontData.join('\n');
                document.getElementById('details-ai').value = aiData.join('\n');
            } else {
                document.getElementById('details-frontend').value = DEFAULT_DETAILS.frontend.join('\n');
                document.getElementById('details-ai').value = DEFAULT_DETAILS.ai.join('\n');
            }
        }

        function saveContentConfig() {
            const frontText = document.getElementById('details-frontend').value;
            const aiText = document.getElementById('details-ai').value;

            const frontArray = frontText.split('\n').filter(line => line.trim() !== '');
            const aiArray = aiText.split('\n').filter(line => line.trim() !== '');

            siteConfig.packageDetails = {
                frontend: frontArray,
                ai: aiArray
            };

            db.collection("config").doc("site_settings").set({
                packageDetails: siteConfig.packageDetails
            }, { merge: true }).then(() => {
                alert("Package Details Updated Successfully!");
            }).catch(err => alert("Error: " + err.message));
        }

        // --- MAINTENANCE LOGIC ---
        function updateMaintenanceUI() {
            const toggleCircle = document.getElementById('maintenance-toggle-circle');
            const inputMsg = document.getElementById('maintenance-msg');
            
            if(siteConfig.maintenance_active) {
                toggleCircle.style.left = '27px';
                toggleCircle.style.background = '#10b981';
                inputMsg.value = siteConfig.message || "Site is currently under maintenance.";
            } else {
                toggleCircle.style.left = '3px';
                toggleCircle.style.background = '#555';
                inputMsg.value = "";
            }
        }

        function toggleMaintenanceStatus() {
            siteConfig.maintenance_active = !siteConfig.maintenance_active;
            updateMaintenanceUI();
        }

        function saveMaintenanceConfig() {
            const msg = document.getElementById('maintenance-msg').value;
            siteConfig.message = msg;
            
            db.collection("config").doc("site_settings").set({
                maintenance_active: siteConfig.maintenance_active,
                message: msg
            }, { merge: true }).then(() => {
                alert("Configuration Saved Successfully!");
            });
        }

        // --- PRICING LOGIC ---
        function updatePricingUI() {
            if(siteConfig.prices) {
                document.getElementById('price-html').value = siteConfig.prices.html || 199;
                document.getElementById('price-frontend').value = siteConfig.prices.frontend || 599;
            }
        }

        function savePricingConfig() {
            const htmlPrice = parseFloat(document.getElementById('price-html').value);
            const frontendPrice = parseFloat(document.getElementById('price-frontend').value);

            siteConfig.prices = {
                html: htmlPrice,
                frontend: frontendPrice
            };

            db.collection("config").doc("site_settings").update({
                prices: siteConfig.prices
            }).then(() => {
                alert("Prices updated successfully!");
            });
        }

        // --- TAB NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            
            const navItems = document.querySelectorAll('.nav-item');
            if(tabId === 'orders') navItems[0].classList.add('active');
            if(tabId === 'users') navItems[1].classList.add('active');
            if(tabId === 'support') navItems[2].classList.add('active');
            if(tabId === 'vouchers') navItems[3].classList.add('active');
            if(tabId === 'promos') navItems[4].classList.add('active');
            if(tabId === 'maintenance') navItems[5].classList.add('active');
            if(tabId === 'content') navItems[6].classList.add('active');
        }

        // --- USER MANAGEMENT (ROLE LOGIC) ---
        function openEditUser(uid, name, phone, role) {
            document.getElementById('edit-uid').value = uid;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-phone').value = phone;
            
            const roleSelect = document.getElementById('edit-role');
            roleSelect.value = role || 'user';
            
            document.getElementById('editUserModal').classList.add('open');
        }

        function saveUser() {
            const uid = document.getElementById('edit-uid').value;
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const role = document.getElementById('edit-role').value;

            if(!name || !phone) return alert("Fields cannot be empty");

            db.collection("users").doc(uid).update({ 
                name: name, 
                phone: phone,
                role: role
            })
                .then(() => {
                    closeModal('editUserModal');
                    alert("User updated successfully");
                })
                .catch(err => alert("Error updating: " + err.message));
        }

        function resetUserPass(email) {
            if(confirm(`Send password reset email to ${email}?`)) {
                auth.sendPasswordResetEmail(email)
                    .then(() => alert("Reset email sent."))
                    .catch(err => alert("Error: " + err.message));
            }
        }

        // --- ORDER MANAGEMENT ---
        function openOrderModal(orderId, currentStatus, note) {
            document.getElementById('order-id').value = orderId;
            document.getElementById('order-status-select').value = currentStatus || 'Pending';
            document.getElementById('order-admin-note').value = note || '';
            document.getElementById('orderModal').classList.add('open');
        }

        function saveOrder() {
            const id = document.getElementById('order-id').value;
            const status = document.getElementById('order-status-select').value;
            const note = document.getElementById('order-admin-note').value;
            
            db.collection("orders").doc(id).update({ 
                status: status,
                adminNote: note
            })
            .then(() => {
                closeModal('orderModal');
                alert("Order status updated");
            })
            .catch(err => alert("Error updating: " + err.message));
        }

        // --- TICKET MANAGEMENT ---
        function openTicketModal(ticketId, currentStatus, note) {
            document.getElementById('ticket-id').value = ticketId;
            document.getElementById('ticket-status-select').value = currentStatus;
            document.getElementById('ticket-admin-note').value = note || '';
            document.getElementById('ticketModal').classList.add('open');
        }

        function saveTicket() {
            const id = document.getElementById('ticket-id').value;
            const status = document.getElementById('ticket-status-select').value;
            const note = document.getElementById('ticket-admin-note').value;
            
            db.collection("tickets").doc(id).update({ 
                status: status,
                adminNote: note
            })
            .then(() => {
                closeModal('ticketModal');
                alert("Ticket status updated");
            })
            .catch(err => alert("Error updating: " + err.message));
        }

        // --- VOUCHER LOGIC ---
        function assignVoucher() {
            const uid = document.getElementById('voucher-user-select').value;
            const code = document.getElementById('voucher-code').value.trim().toUpperCase();
            const val = parseFloat(document.getElementById('voucher-val').value);
            const type = document.getElementById('voucher-type').value;

            if(!uid) return alert("Please select a user.");
            if(!code || isNaN(val)) return alert("Invalid Voucher Details.");

            const voucherData = {
                code: code,
                value: val,
                type: type
            };

            db.collection("users").doc(uid).update({ 
                personalVoucher: voucherData 
            }).then(() => {
                alert(`Voucher ${code} assigned to user!`);
                refreshVoucherTable();
            }).catch(err => alert("Error: " + err.message));
        }

        function refreshVoucherTable() {
            const tbody = document.getElementById('voucher-table-body');
            tbody.innerHTML = '';

            const usersWithVouchers = allUsers.filter(u => u.personalVoucher);

            if(usersWithVouchers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1rem; color:var(--text-secondary);">No personal vouchers assigned yet.</td></tr>';
                return;
            }

            usersWithVouchers.forEach(u => {
                const v = u.personalVoucher;
                const displayVal = v.type === 'fixed' ? `RM ${v.value}` : `${v.value * 100}%`;
                const row = `
                    <tr>
                        <td style="font-weight:600;">${u.name}</td>
                        <td style="color:var(--accent-primary);">${v.code}</td>
                        <td style="color:var(--success);">${displayVal}</td>
                        <td>
                            <button class="action-btn" style="color:var(--danger);" onclick="deleteUserVoucher('${u.id}')">Remove</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function deleteUserVoucher(uid) {
            if(confirm("Remove this voucher from user?")) {
                db.collection("users").doc(uid).update({
                    personalVoucher: firebase.firestore.FieldValue.delete()
                });
            }
        }

        // --- PROMO MANAGEMENT ---
        function createPromo() {
            const code = document.getElementById('new-promo-code').value.trim().toUpperCase();
            const val = parseFloat(document.getElementById('new-promo-val').value);

            if(!code || isNaN(val)) return alert("Invalid input");
            if(val <= 0 || val >= 1) return alert("Discount must be between 0 and 1");

            db.collection("promo_codes").doc(code).set({ discount: val })
                .then(() => {
                    document.getElementById('new-promo-code').value = '';
                    document.getElementById('new-promo-val').value = '';
                    alert("Promo Code Created!");
                })
                .catch(err => alert("Error: " + err.message));
        }

        function deletePromo(code) {
            if(confirm(`Delete code ${code}?`)) {
                db.collection("promo_codes").doc(code).delete();
            }
        }

        // --- UTILS ---
        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }
    </script>
</body>
</html>
