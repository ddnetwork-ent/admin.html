<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDNetwork(Admin)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-card: #111111;
            --accent-primary: #3b82f6;
            --text-main: #ffffff;
            --text-secondary: #a1a1aa;
            --border-light: rgba(255,255,255,0.1);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --alert-bg: rgba(245, 158, 11, 0.1);
            --alert-border: #f59e0b;
        }
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* LOGIN SCREEN */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--bg-deep);
            z-index: 200;
        }
        .login-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 16px;
            border:1px solid var(--border-light);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-card h2 { margin-bottom:1.5rem; color: white; text-transform: uppercase; letter-spacing: 1px; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border:1px solid var(--border-light);
            border-radius: 8px;
            color: white;
            margin-bottom:1rem;
            font-family: inherit;
            box-sizing: border-box;
            transition: 0.2s;
        }
        input:disabled, select:disabled, textarea:disabled {
            background: rgba(0,0,0,0.3);
            color: var(--text-secondary);
            cursor: not-allowed;
            border-color: transparent;
        }
        textarea { height: 150px; resize: vertical; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-primary); outline: none; background: rgba(59, 130, 246, 0.05); }
        
        button {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            box-sizing: border-box;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.secondary { background: #333; }
        button.danger { background: var(--danger); }
        button.sm-btn { width: auto; padding: 6px 12px; font-size: 0.8rem; }
        button.success { background: var(--success); }

        /* DASHBOARD LAYOUT */
        #dashboard {
            display: none; 
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: row;
        }
        
        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right:1px solid var(--border-light);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }
        .brand {
            font-size:1rem;
            margin-bottom: 3rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-left: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 1.5rem;
        }
        .brand-icon {
            font-size: 1.5rem;
            color: var(--accent-primary);
        }
        .brand-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        .brand-name {
            font-weight: 700;
            font-size: 1rem;
        }
        .brand-job {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .nav-item {
            padding: 12px 1rem;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }
        .logout-btn { margin-top: auto; color: var(--danger); }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-left: 3px solid var(--danger); }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* Ensure scrolling works on mobile */
            height: 100vh; 
            box-sizing: border-box;
        }

        /* MOBILE HEADER (Sticky) */
        .mobile-brand-header {
            display: none; 
            align-items: center;
            justify-content: space-between;
            padding-bottom:1rem;
            margin-bottom:1rem;
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--bg-deep); /* Opaque to cover content behind */
            padding-top: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        /* TABS & TABLES */
        .tab-content { display: none; animation: fadeIn 0.3s ease; padding-bottom: 2rem; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .section-header h2 { margin: 0; font-size: 1.5rem; color: white; }
        .section-header-actions { display: flex; gap: 0.5rem; }

        /* SEARCH BAR */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        .search-container input {
            margin-bottom: 0;
            padding-left: 2.5rem;
            background: rgba(255,255,255,0.05);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* --- FILTER BUTTONS --- */
        .ticket-filters {
            display: flex;
            gap: 10px;
            background: var(--bg-card);
            padding: 5px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }
        .filter-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            width: auto;
            margin: 0;
            transition: 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .filter-btn.active { background: var(--accent-primary); color: white; }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            background: var(--bg-card);
            border:1px solid var(--border-light);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom:1px solid var(--border-light);
            white-space: nowrap;
        }
        th { background: rgba(255,255,255,0.02); font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }
        .status-pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-paid, .status-completed { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-open { background: rgba(59, 130, 246, 0.2); color: var(--accent-primary); }
        .role-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }
        .role-admin { background: var(--warning); color: black; }
        .role-superadmin { background: var(--accent-primary); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .role-user { background: #333; color: var(--text-secondary); }

        .action-btn {
            background: none;
            border:1px solid var(--border-light);
            padding: 6px 12px;
            margin-right: 5px;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: 0.2s;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--text-secondary); }

        /* --- SOURCE BADGES --- */
        .source-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-internal { 
            background: rgba(245, 158, 11, 0.15); 
            color: #f59e0b; 
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .badge-external { 
            background: rgba(59, 130, 246, 0.15); 
            color: #3b82f6; 
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .row-internal { background: rgba(245, 158, 11, 0.03); }

        /* --- LOGS TAB STYLES --- */
        .log-entry {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-timestamp {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 150px;
        }
        .log-admin {
            font-weight: 600;
            color: var(--accent-primary);
            min-width: 150px;
        }
        .log-action {
            flex: 1;
            font-size: 0.9rem;
            color: white;
        }
        .log-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ADMIN CARDS */
        .admin-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            margin-bottom: 2rem;
            scroll-margin-top: 100px; /* For smooth scroll from search */
        }
        .admin-card h3 { margin-bottom: 1rem; color: white; font-size: 1rem; margin-top: 0; }
        .form-row { margin-bottom: 1rem; text-align: left; }
        .form-row label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--text-secondary); }
        .helper-text { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* ALERTS */
        .alert-box {
            padding: 1rem;
            border-radius: 8px;
            background: var(--alert-bg);
            border-left: 4px solid var(--alert-border);
            margin-bottom: 1rem;
        }
        .alert-text { font-size: 0.9rem; color: white; font-weight: 600; }

        /* MODAL (GENERAL) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-light);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .modal-content h3 { margin-top: 0; color: white; margin-bottom: 1.5rem; }
        
        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            #dashboard { flex-direction: column; }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 0.8rem;
                flex-direction: row;
                position: fixed;
                bottom: 0; left: 0; top: auto; right: 0;
                border-right: none;
                border-top: 1px solid var(--border-light);
                overflow-x: auto;
                box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
                z-index: 100; /* Above everything */
            }
            
            .brand { display: none; } /* Hide Sidebar Brand */
            .logout-btn { display: none; } /* Hide Sidebar Logout */

            /* Show Mobile Header */
            .mobile-brand-header {
                display: flex;
            }
            .mobile-brand-header .brand-name { font-size: 1.1rem; }
            .mobile-brand-header .brand-job { font-size: 0.85rem; }

            .nav-item {
                flex: 0 0 auto;
                flex-direction: column;
                gap: 4px;
                margin-bottom: 0;
                padding: 8px 16px;
                font-size: 0.7rem;
                border-radius: 6px;
                border-left: 2px solid transparent;
            }
            .nav-item:hover, .nav-item.active {
                background: rgba(255,255,255,0.05);
                color: white;
                border-left: 2px solid var(--accent-primary);
            }
            .nav-item i { font-size: 1.3rem; color: var(--text-secondary); }
            .nav-item.active i { color: var(--accent-primary); }
            
            /* Main Content Scroll Adjustments */
            .main-content { 
                padding: 0.5rem 1rem 90px 1rem; /* Extra bottom padding for nav */
                margin-bottom: 0;
            }
            
            .section-header { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .section-header h2 { font-size: 1.2rem; }
            button { font-size: 0.9rem; }
            
            /* Sticky Header Padding adjustment */
            .tab-content { padding-top: 1rem; }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <div style="margin-bottom: 1.5rem;">
                <i class="ri-shield-keyhole-line" style="font-size: 3rem; color: var(--accent-primary);"></i>
            </div>
            <h2>Internal Portal</h2>
            <form onsubmit="handleAdminLogin(event)">
                <input type="email" id="admin-email" placeholder="Admin Email" required autocomplete="email">
                <input type="password" id="admin-password" placeholder="Password" required autocomplete="current-password">
                <button type="submit">Login</button>
            </form>
            <p id="login-error" style="color: var(--danger); font-size: 0.85rem; margin-top: 1rem; display: none;"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display: none;">
        <div class="sidebar">
            <!-- DESKTOP BRAND -->
            <div class="brand">
                <i class="ri-shield-user-fill brand-icon"></i>
                <div class="brand-info">
                    <span id="sidebar-name" class="brand-name">DDN Admin</span>
                    <span id="sidebar-jobtitle" class="brand-job">Super Admin</span>
                </div>
            </div>
            
            <div class="nav-item active" onclick="switchTab('orders')">
                <i class="ri-shopping-bag-3-line"></i> <span>Orders</span>
            </div>
            <div class="nav-item" onclick="switchTab('users')">
                <i class="ri-group-line"></i> <span>Users</span>
            </div>
            <div class="nav-item" onclick="switchTab('support')">
                <i class="ri-customer-service-2-line"></i> <span>Support</span>
            </div>
            <div class="nav-item" onclick="switchTab('vouchers')">
                <i class="ri-gift-line"></i> <span>Vouchers</span>
            </div>
            <div class="nav-item" onclick="switchTab('promos')">
                <i class="ri-coupon-3-line"></i> <span>Promo</span>
            </div>
            <!-- LOGS TAB -->
            <div class="nav-item" id="nav-logs" onclick="switchTab('logs')">
                <i class="ri-file-history-line"></i> <span>System Logs</span>
            </div>
            <div class="nav-item" onclick="switchTab('maintenance')">
                <i class="ri-settings-4-line"></i> <span>Config</span>
            </div>
            <div class="nav-item" onclick="switchTab('content')">
                <i class="ri-file-list-3-line"></i> <span>Content</span>
            </div>
            
            <div class="nav-item logout-btn" onclick="handleLogout()">
                <i class="ri-logout-box-r-line"></i> <span>Logout</span>
            </div>
        </div>

        <div class="main-content">
            
            <!-- MOBILE PROFILE HEADER (Sticky) -->
            <div class="mobile-brand-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="ri-shield-user-fill brand-icon"></i>
                    <div class="brand-info">
                        <span id="mobile-name" class="brand-name">DDN Admin</span>
                        <span id="mobile-jobtitle" class="brand-job">Super Admin</span>
                    </div>
                </div>
                <button class="action-btn sm-btn" onclick="handleLogout()" style="color:var(--danger); border-color:var(--danger);">Logout</button>
            </div>

            <!-- ORDERS TAB -->
            <div id="tab-orders" class="tab-content active">
                <div class="section-header">
                    <h2>Orders</h2>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        <i class="ri-refresh-line"></i> Live Updates
                    </div>
                </div>
                
                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-orders" placeholder="Search Name, ID, Company..." onkeyup="handleSearch('orders', this.value)">
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Company</th>
                                <th>Package</th>
                                <th>Voucher</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- USERS TAB -->
            <div id="tab-users" class="tab-content">
                <div class="section-header">
                    <h2>User Management</h2>
                    <div class="section-header-actions">
                        <button class="action-btn success" style="color:white; border:none; width:auto;" onclick="openCreateUserModal()">
                            <i class="ri-user-add-line"></i> Create New User
                        </button>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-users" placeholder="Search Name, Email, Phone..." onkeyup="handleSearch('users', this.value)">
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Name</th>
                                <th>Job Title</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUPPORT TAB -->
            <div id="tab-support" class="tab-content">
                <div class="section-header">
                    <h2>Support Desk</h2>
                    <div class="section-header-actions">
                         <button class="action-btn success" style="color:white; border:none; width:auto;" onclick="openInternalTicketModal()">
                            <i class="ri-add-box-line"></i> Create Ticket
                        </button>
                        <div class="ticket-filters">
                            <button class="filter-btn active" onclick="filterTickets('all', this)">
                                <i class="ri-list-check"></i> All
                            </button>
                            <button class="filter-btn" onclick="filterTickets('internal', this)">
                                <i class="ri-bug-line"></i> Internal
                            </button>
                            <button class="filter-btn" onclick="filterTickets('external', this)">
                                <i class="ri-user-line"></i> External
                            </button>
                        </div>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-support" placeholder="Search Name, Type, Message..." onkeyup="handleSearch('support', this.value)">
                </div>

                <!-- TICKETS TABLE -->
                <div class="table-responsive" style="margin-bottom: 2rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Case ID</th>
                                <th>Source</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th id="th-internal-note" style="display:none;">Internal Notes</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VOUCHERS TAB -->
            <div id="tab-vouchers" class="tab-content">
                <div class="section-header">
                    <h2>Assign Voucher</h2>
                </div>
                
                <div class="admin-card">
                    <h3>Send Gift Voucher</h3>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                        <div style="grid-column: 1 / -1;">
                            <label>Select Customer</label>
                            <select id="voucher-user-select" style="margin-bottom: 0;">
                                <option value="" disabled selected>Loading Users...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Code</label>
                            <input type="text" id="voucher-code" placeholder="e.g. GIFT50">
                        </div>
                        <div>
                            <label>Value</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="voucher-val" placeholder="50" step="1">
                                <select id="voucher-type" style="width: auto;">
                                    <option value="fixed">RM</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button onclick="assignVoucher()" style="margin-top: 1rem;">Assign Voucher</button>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-vouchers" placeholder="Search Code or User..." onkeyup="handleSearch('vouchers', this.value)">
                </div>

                <div class="table-responsive" style="margin-top: 2rem;">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Recent Assignments</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Code</th>
                                <th>Value</th>
                                <th id="th-created-by" style="display:none;">Created By</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="voucher-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PROMOS TAB -->
            <div id="tab-promos" class="tab-content">
                <div class="section-header">
                    <h2>Promo Codes</h2>
                </div>
                
                <div class="admin-card">
                    <h3>Create Global Promo</h3>
                    <form onsubmit="event.preventDefault(); createPromo();">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                            <input type="text" id="new-promo-code" placeholder="Code" style="margin:0;" required>
                            <input type="number" id="new-promo-val" placeholder="0.5" step="0.01" style="margin:0;" required>
                            <button type="submit" style="width: auto; white-space: nowrap;">Add</button>
                        </div>
                    </form>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-promos" placeholder="Search Code..." onkeyup="handleSearch('promos', this.value)">
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Discount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="promo-table-body">
                             <tr>
                                <td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading promos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SYSTEM LOGS TAB -->
            <div id="tab-logs" class="tab-content">
                <div class="section-header">
                    <h2>System Logs</h2>
                    <p style="font-size: 0.8rem; color: var(--text-secondary);">Audit trail of recent administrative actions.</p>
                </div>

                <div class="admin-card">
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; overflow-x: auto;">
                        <button id="btn-log-all" class="sm-btn secondary active" onclick="loadLogsTab('all')">All Activity</button>
                        <button id="btn-log-tickets" class="sm-btn secondary" onclick="loadLogsTab('tickets')">Tickets</button>
                        <button id="btn-log-vouchers" class="sm-btn secondary" onclick="loadLogsTab('vouchers')">Vouchers</button>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-logs" placeholder="Search Admin, Action..." onkeyup="handleSearch('logs', this.value)">
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Admin</th>
                                <th>Action Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MAINTENANCE TAB (Config) -->
            <div id="tab-maintenance" class="tab-content">
                <div class="section-header">
                    <h2>Site Configuration</h2>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-config" placeholder="Jump to section (e.g. Maintenance, Pricing)..." onkeyup="handleSearch('config', this.value)">
                </div>

                <div class="admin-card" id="config-maintenance">
                    <h3>Maintenance Mode</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Toggle warning banner on main site.</p>
                    <div class="form-row">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <label>Enable Maintenance</label>
                            <div style="width: 50px; height: 26px; background: #333; border-radius: 13px; position: relative; cursor: pointer;" onclick="toggleMaintenanceStatus()">
                                <div id="maintenance-toggle-circle" style="width: 20px; height: 20px; background: #555; border-radius: 50%; position: absolute; left: 3px; top: 3px; transition: 0.3s;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Banner Message</label>
                        <input type="text" id="maintenance-msg" placeholder="e.g. Site Down for update.">
                    </div>
                    
                    <button onclick="saveMaintenanceConfig()" style="margin-top: 1rem;">Save Config</button>
                </div>

                <div class="admin-card" id="config-pricing">
                    <h3>Dynamic Pricing</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Override base prices.</p>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>HTML Price (RM)</label>
                            <input type="number" id="price-html" placeholder="199">
                        </div>
                        <div>
                            <label>Frontend Price (RM)</label>
                            <input type="number" id="price-frontend" placeholder="599">
                        </div>
                    </div>
                    <button onclick="savePricingConfig()" style="margin-top: 1rem;">Update Prices</button>
                </div>
            </div>

            <!-- CONTENT TAB -->
            <div id="tab-content" class="tab-content">
                <div class="section-header">
                    <h2>Package Details</h2>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-content" placeholder="Jump to section (e.g. Frontend, AI)..." onkeyup="handleSearch('content', this.value)">
                </div>

                <div class="admin-card" id="content-frontend">
                    <h3>Frontend Details</h3>
                    <p class="helper-text">One feature per line.</p>
                    <div class="form-row">
                        <label>Features List</label>
                        <textarea id="details-frontend" placeholder="e.g. Up to 5 Pages"></textarea>
                    </div>
                    <button onclick="saveContentConfig()" style="margin-top: 1rem;">Save Details</button>
                </div>

                <div class="admin-card" id="content-ai">
                    <h3>AI Powered Details</h3>
                    <p class="helper-text">One feature per line.</p>
                    <div class="form-row">
                        <label>Features List</label>
                        <textarea id="details-ai" placeholder="e.g. AI Chatbot"></textarea>
                    </div>
                    <button onclick="saveContentConfig()" style="margin-top: 1rem;">Save Details</button>
                </div>
            </div>

        </div>
    </div>

    <!-- EDIT USER MODAL -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Manage User</h3>
                <i class="ri-close-line" onclick="closeModal('editUserModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <input type="hidden" id="edit-uid">
            <div class="form-row">
                <label>Full Name</label>
                <input type="text" id="edit-name" placeholder="John Doe">
            </div>
            <div class="form-row">
                <label>Job Title</label>
                <input type="text" id="edit-jobtitle" placeholder="e.g. CEO">
                <span id="jobtitle-helper" style="font-size:0.7em; color:var(--accent-primary); display:none;">(SuperAdmin Only)</span>
            </div>
            <div class="form-row">
                <label>Phone Number</label>
                <input type="tel" id="edit-phone" placeholder="0123456789">
            </div>
            <div class="form-row">
                <label>Role</label>
                <select id="edit-role" style="width: 100%;">
                    <option value="user">Standard User</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                </select>
            </div>
            <div id="edit-restriction-msg" style="display:none; color:var(--warning); font-size:0.8rem; margin-bottom:1rem;">
                <!-- Message injected via JS -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveUser()" style="background: var(--success);">Update User</button>
                <button class="secondary" onclick="closeModal('editUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- INTERNAL TICKET MODAL (POPUP) -->
    <div id="internalTicketModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Create Internal Ticket</h3>
                <i class="ri-close-line" onclick="closeModal('internalTicketModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>

            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>Type</label>
                    <select id="ticket-type" style="width: 100%;">
                        <option value="Internal Bug">Internal Bug</option>
                        <option value="Feature Request">Feature Request</option>
                        <option value="System Error">System Error</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label>Target User (Optional)</label>
                    <select id="ticket-target-user-select" style="width: 100%;">
                        <option value="">General (Myself)</option>
                        <!-- Populated dynamically via JS -->
                    </select>
                    <input type="text" id="ticket-target-user-input" placeholder="Search user..." style="margin-top: 5px; display: none;">
                </div>
            </div>

            <div class="form-group">
                <div>
                    <label>Message</label>
                    <textarea id="ticket-message" placeholder="Describe issue or task..." required></textarea>
                </div>
                <div>
                    <label>Target User Name</label>
                    <input type="text" id="ticket-target-user-name" placeholder="Auto-filled if user selected" readonly style="background: rgba(0,0,0,0.3);">
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="submitInternalTicket()" style="background: var(--success);">Create Ticket</button>
                <button class="secondary" onclick="closeModal('internalTicketModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CREATE USER MODAL -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Create New User</h3>
                <i class="ri-close-line" onclick="closeModal('createUserModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <div class="form-row">
                <label>Full Name</label>
                <input type="text" id="create-name" placeholder="John Doe">
            </div>
            <div class="form-row">
                <label>Email Address</label>
                <input type="email" id="create-email" placeholder="user@example.com">
            </div>
            <div class="form-row">
                <label>Initial Password</label>
                <input type="password" id="create-password" placeholder="At least 6 characters">
            </div>
            <div class="form-row">
                <label>Phone Number</label>
                <input type="tel" id="create-phone" placeholder="0123456789">
            </div>
            <div class="form-row">
                <label>Assign Role</label>
                <select id="create-role" style="width: 100%;">
                    <option value="user">Standard User</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="createNewUser()" style="background: var(--success);">Create User</button>
                <button class="secondary" onclick="closeModal('createUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- TICKET MODAL -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Manage Ticket</h3>
                <i class="ri-close-line" onclick="closeModal('ticketModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <input type="hidden" id="ticket-id">
            <div class="form-row">
                <label>Status</label>
                <select id="ticket-status-select" style="width: 100%;">
                    <option value="Open">Open</option>
                    <option value="Resolved">Resolved</option>
                </select>
            </div>
            <div class="form-row">
                <label>Admin Note</label>
                <textarea id="ticket-admin-note"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveTicket()" style="background: var(--success);">Update Ticket</button>
                <button class="secondary" onclick="closeModal('ticketModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ORDER MODAL (UPDATED) -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3 style="margin:0;">Manage Order</h3>
                <i class="ri-close-line" onclick="closeModal('orderModal')" style="cursor:pointer; color:var(--text-secondary); font-size:1.5rem;"></i>
            </div>
            <input type="hidden" id="order-id">
            
            <!-- Company Name -->
            <div class="form-row">
                <label>Company Name (Optional)</label>
                <input type="text" id="order-company-name" placeholder="e.g. ABC Corp">
            </div>

            <!-- Package Select -->
            <div class="form-row">
                <label>Package</label>
                <select id="order-package">
                    <option value="HTML">Standard HTML</option>
                    <option value="Frontend">Advanced Frontend</option>
                    <option value="AI">AI Powered Website</option>
                    <option value="Custom">Custom Package</option>
                </select>
            </div>

            <!-- Total Input -->
            <div class="form-row">
                <label>Total (RM)</label>
                <input type="number" id="order-total" step="0.01" placeholder="0.00">
            </div>

            <!-- Voucher Read Only -->
            <div class="form-row">
                <label>Voucher Applied</label>
                <input type="text" id="order-voucher" readonly style="background: rgba(255,255,255,0.05); color: var(--text-secondary);" placeholder="-">
            </div>

            <!-- Status -->
            <div class="form-row">
                <label>Order Status</label>
                <select id="order-status-select" style="width: 100%;">
                    <option value="Pending">Pending</option>
                    <option value="Paid">Paid</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>

            <!-- Admin Note -->
            <div class="form-row">
                <label>Admin Notes</label>
                <textarea id="order-admin-note"></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveOrder()" style="background: var(--success);">Update Order</button>
                <button class="secondary" onclick="closeModal('orderModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
            authDomain: "ddnetwork-database.firebaseapp.com",
            projectId: "ddnetwork-database",
            storageBucket: "ddnetwork-database.firebasestorage.app",
            messagingSenderId: "699127560990",
            appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
        };

        let db, auth;
        let ticketFilter = 'all';
        let ticketCache = []; 
        let orderCache = []; // Added for Orders Search
        let promoCache = []; // Added for Promo Search
        let currentAdminUID = ""; 
        let isSuperAdmin = false; 
        let currentAdminEmail = "";
        let currentLogFilter = 'all'; // Default to All

        // Search State
        let searchStates = {
            orders: "",
            users: "",
            support: "",
            vouchers: "",
            promos: "",
            logs: "",
            config: "",
            content: ""
        };

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch(e) {
            console.error("Firebase Error", e);
            alert("Error connecting to database.");
        }

        let allUsers = []; 
        let siteConfig = { maintenance_active: false, message: '', prices: { html: 199, frontend: 599 }, packageDetails: {} };

        const DEFAULT_DETAILS = {
            frontend: ["Up to 5 Pages", "Animations", "Contact Forms"],
            ai: ["All Frontend Features", "AI Chatbot", "Analytics"]
        };

        // AUTH LOGIC
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentAdminUID = user.uid;
                currentAdminEmail = user.email;
                
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const role = data.role || 'user';

                        if (role === 'admin' || role === 'superadmin') {
                            document.getElementById('login-screen').style.display = 'none';
                            document.getElementById('dashboard').style.display = 'flex';
                            
                            isSuperAdmin = (role === 'superadmin');

                            loadDashboardData();
                            loadSidebarProfile(); 
                            adjustUIForSuperAdmin();
                        } else {
                            auth.signOut();
                            alert("ACCESS DENIED: You do not have permission to access this portal.");
                            document.getElementById('login-screen').style.display = 'flex';
                            document.getElementById('dashboard').style.display = 'none';
                        }
                    }
                }).catch((err) => {
                    alert("Error verifying permissions.");
                });
            } else {
                currentAdminUID = "";
                isSuperAdmin = false;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        function adjustUIForSuperAdmin() {
            if(isSuperAdmin) {
                document.getElementById('th-internal-note').style.display = 'table-cell';
                document.getElementById('th-created-by').style.display = 'table-cell';
                if(document.getElementById('nav-logs')) document.getElementById('nav-logs').style.display = 'flex';
            } else {
                document.getElementById('th-internal-note').style.display = 'none';
                document.getElementById('th-created-by').style.display = 'none';
                // HIDE CREATE USER BUTTON
                const createUserBtn = document.querySelector('button[onclick="openCreateUserModal()"]');
                if(createUserBtn) createUserBtn.style.display = 'none';
                
                // RESTRICT LOGS TAB ENTIRELY
                if(document.getElementById('nav-logs')) document.getElementById('nav-logs').style.display = 'none';
                if(document.getElementById('tab-logs')) document.getElementById('tab-logs').style.display = 'none';
            }
        }

        function loadSidebarProfile() {
            if(currentAdminUID) {
                db.collection("users").doc(currentAdminUID).onSnapshot((doc) => {
                    if(doc.exists) {
                        const data = doc.data();
                        const name = data.name || "DDN Admin";
                        const title = data.jobTitle || (isSuperAdmin ? "Super Admin" : "Admin");

                        document.getElementById('sidebar-name').innerText = name;
                        document.getElementById('sidebar-jobtitle').innerText = title;
                        document.getElementById('mobile-name').innerText = name;
                        document.getElementById('mobile-jobtitle').innerText = title;
                    }
                });
            }
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    const userRef = db.collection("users").doc(user.uid);
                    userRef.get().then((docSnapshot) => {
                        if (!docSnapshot.exists) {
                            userRef.set({
                                email: user.email,
                                role: 'user',
                                name: "New User",
                                phone: ""
                            }).then(() => alert("Account created. Please contact admin for access."))
                            .catch(err => alert(err.message));
                        }
                    });
                })
                .catch((error) => {
                    const errBox = document.getElementById('login-error');
                    errBox.innerText = error.message;
                    errBox.style.display = 'block';
                });
        }

        function handleLogout() {
            if(confirm("Logout?")) auth.signOut();
        }

        function openCreateUserModal() {
            document.getElementById('create-name').value = '';
            document.getElementById('create-email').value = '';
            document.getElementById('create-password').value = '';
            document.getElementById('create-phone').value = '';
            document.getElementById('create-role').value = 'user';
            document.getElementById('createUserModal').classList.add('open');
        }

        function openInternalTicketModal() {
            // Clear fields
            document.getElementById('ticket-message').value = '';
            document.getElementById('ticket-target-user-select').value = '';
            document.getElementById('ticket-target-user-input').value = '';
            document.getElementById('ticket-target-user-name').value = '';
            document.getElementById('ticket-type').value = 'Internal Bug';

            // Populate Target User Select
            const select = document.getElementById('ticket-target-user-select');
            let optionsHTML = '<option value="">General (Myself)</option>';
            allUsers.forEach(u => {
                optionsHTML += `<option value="${u.id}" data-name="${u.name}" data-email="${u.email}" data-phone="${u.phone}">${u.name}</option>`;
            });
            select.innerHTML = optionsHTML;

            document.getElementById('internalTicketModal').classList.add('open');
        }

        // Sync Target User Name when Dropdown Changes
        document.getElementById('ticket-target-user-select').addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const name = selectedOption.getAttribute('data-name');
            document.getElementById('ticket-target-user-name').value = name || "";
        });

        function submitInternalTicket() {
            const type = document.getElementById('ticket-type').value;
            const message = document.getElementById('ticket-message').value;
            const targetUserId = document.getElementById('ticket-target-user-select').value;
            const targetName = document.getElementById('ticket-target-user-name').value;
            
            // If Target User is not empty, get their details
            let targetEmail = currentAdminEmail; // Default self
            let targetPhone = "";
            let source = "internal";
            
            if (targetUserId) {
                const targetUser = allUsers.find(u => u.id === targetUserId);
                if(targetUser) {
                    targetEmail = targetUser.email;
                    targetPhone = targetUser.phone;
                }
            }

            const ticketData = {
                name: currentAdminEmail,
                email: currentAdminEmail,
                phone: "", 
                type: type,
                message: message,
                status: 'Open',
                source: "internal",
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                adminNote: '',
                targetName: targetName || "",
                targetEmail: targetEmail,
                targetPhone: targetPhone,
                adminEmail: currentAdminEmail 
            };

            db.collection("tickets").add(ticketData).then(() => {
                closeModal('internalTicketModal');
                alert("Internal Ticket Created Successfully!");
            }).catch(err => alert("Error creating ticket: " + err.message));
        }

        function createNewUser() {
            const name = document.getElementById('create-name').value;
            const email = document.getElementById('create-email').value;
            const password = document.getElementById('create-password').value;
            const phone = document.getElementById('create-phone').value;
            const role = document.getElementById('create-role').value;

            if(!name || !email || !password) return alert("Name, Email, and Password are required.");

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return db.collection("users").doc(user.uid).set({
                        name: name,
                        email: email,
                        phone: phone,
                        role: role,
                        jobTitle: role === 'superadmin' ? 'Super Admin' : '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    closeModal('createUserModal');
                    alert("User Created Successfully!");
                })
                .catch((error) => {
                    alert("Error creating user: " + error.message);
                });
        }

        // SEARCH HANDLER
        function handleSearch(tab, value) {
            searchStates[tab] = value.toLowerCase();
            
            // Trigger specific render functions
            if (tab === 'orders') renderOrdersTable();
            if (tab === 'users') renderUsersTable();
            if (tab === 'support') renderTicketsTable();
            if (tab === 'vouchers') renderVoucherTable();
            if (tab === 'promos') renderPromoTable();
            if (tab === 'logs') renderLogsTable();
            if (tab === 'config') scrollToSection('config', value);
            if (tab === 'content') scrollToSection('content', value);
        }

        function scrollToSection(context, text) {
            const textLower = text.toLowerCase();
            if (!textLower) return;
            
            // Define mapping for context tabs
            const sections = [];
            if (context === 'config') {
                sections.push({ id: 'config-maintenance', keywords: ['maintenance', 'banner', 'mode'] });
                sections.push({ id: 'config-pricing', keywords: ['pricing', 'price', 'html', 'frontend'] });
            } else if (context === 'content') {
                sections.push({ id: 'content-frontend', keywords: ['frontend', 'features', 'standard'] });
                sections.push({ id: 'content-ai', keywords: ['ai', 'artificial', 'intelligence', 'chatbot'] });
            }

            for (let sec of sections) {
                if (sec.keywords.some(k => textLower.includes(k))) {
                    const el = document.getElementById(sec.id);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Flash effect
                        el.style.transition = 'background 0.3s';
                        el.style.background = 'rgba(59, 130, 246, 0.2)';
                        setTimeout(() => { el.style.background = 'var(--bg-card)'; }, 500);
                        break;
                    }
                }
            }
        }

        function loadDashboardData() {
            db.collection("config").doc("site_settings").onSnapshot(doc => {
                if(doc.exists) {
                    siteConfig = doc.data();
                    updateMaintenanceUI();
                    updatePricingUI();
                    updateContentUI();
                }
            });

            db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                orderCache = []; 
                snapshot.forEach(doc => orderCache.push({ id: doc.id, data: doc.data() }));
                renderOrdersTable();
            });

            db.collection("users").onSnapshot((snapshot) => {
                const select = document.getElementById('voucher-user-select');
                allUsers = []; 
                let optionsHTML = '<option value="" disabled selected>Select a User</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allUsers.push({ id: doc.id, ...data });
                    optionsHTML += `<option value="${doc.id}">${data.name} (${data.email})</option>`;
                });
                select.innerHTML = optionsHTML;
                renderUsersTable();
                refreshVoucherTable();
            });

            db.collection("tickets").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                ticketCache = []; 
                snapshot.forEach(doc => ticketCache.push({ id: doc.id, data: doc.data() }));
                renderTicketsTable();
                // Refresh logs if tickets updated and logs tab is active
                if(currentLogFilter && document.getElementById('tab-logs').classList.contains('active')) {
                    renderLogsTable();
                }
            });

            db.collection("promo_codes").onSnapshot((snapshot) => {
                promoCache = [];
                snapshot.forEach(doc => promoCache.push({ id: doc.id, data: doc.data() }));
                renderPromoTable();
            });
        }

        // --- RENDER FUNCTIONS WITH SEARCH ---

        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';
            
            let visibleOrders = orderCache;
            // Apply Search
            const s = searchStates.orders;
            if(s) {
                visibleOrders = visibleOrders.filter(o => {
                    const d = o.data;
                    const str = `${d.customerName} ${d.customerEmail} ${d.companyName || ''} ${o.id}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visibleOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem;">No orders found.</td></tr>';
                return;
            }

            visibleOrders.forEach(doc => {
                const data = doc.data;
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : '-';
                let statusClass = 'status-pending';
                if(data.status === 'Paid' || data.status === 'Completed') statusClass = 'status-paid status-completed';
                if(data.status === 'Cancelled') statusClass = 'status-cancelled';
                
                // Safe string escaping
                const safeCompany = (data.companyName || '').replace(/'/g, "\\'");
                const safePackage = (data.package || '').replace(/'/g, "\\'");
                const safeTotal = (data.total || '').replace(/'/g, "\\'");
                const safeVoucher = (data.voucherCode || '').replace(/'/g, "\\'");
                const safeNote = (data.adminNote || '').replace(/'/g, "\\'");

                tbody.innerHTML += `
                    <tr>
                        <td style="color:var(--text-secondary); font-size:0.9rem;">${date}</td>
                        <td><div style="font-weight:600;">${data.customerName}</div><div style="font-size:0.8rem; color:var(--text-secondary);">${data.customerEmail}</div></td>
                        <td style="color:var(--text-secondary); font-size:0.85rem;">${data.companyName || '-'}</td>
                        <td>${data.package || '-'}</td>
                        <td style="color:var(--success); font-weight:600;">${data.voucherCode || '-'}</td>
                        <td style="font-weight:700;">${data.total || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        <td><button class="action-btn" onclick="openOrderModal('${doc.id}', '${data.status}', '${safeNote}', '${safeCompany}', '${safePackage}', '${safeTotal}', '${safeVoucher}')">Manage</button></td>
                    </tr>`;
            });
        }

        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            let visibleUsers = allUsers;
            // Apply Search
            const s = searchStates.users;
            if(s) {
                visibleUsers = visibleUsers.filter(u => {
                    const str = `${u.name} ${u.email} ${u.phone}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visibleUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">No users found.</td></tr>';
                return;
            }

            visibleUsers.forEach(u => {
                const role = u.role || 'user';
                let roleClass = 'role-user';
                let roleLabel = 'User';
                
                if(role === 'admin') { roleClass = 'role-admin'; roleLabel = 'Admin'; }
                if(role === 'superadmin') { roleClass = 'role-superadmin'; roleLabel = 'Super Admin'; }

                tbody.innerHTML += `
                    <tr>
                        <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                        <td>${u.name}</td>
                        <td style="color:var(--text-secondary); font-size:0.9rem;">${u.jobTitle || '-'}</td>
                        <td style="font-size:0.9rem;">${u.email}</td>
                        <td>${u.phone}</td>
                        <td>
                            <button class="action-btn" onclick="openEditUser('${u.id}', '${(u.name || '').replace(/'/g, "\\'")}', '${(u.phone || '').replace(/'/g, "\\'")}', '${role}', '${(u.jobTitle || '').replace(/'/g, "\\'")}')">Edit</button>
                            <button class="action-btn" onclick="resetUserPass('${u.email}')">Pwd</button>
                        </td>
                    </tr>`;
            });
        }

        function filterTickets(type, btnElement) {
            ticketFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            renderTicketsTable();
        }

        function renderTicketsTable() {
            const tbody = document.getElementById('tickets-table-body');
            tbody.innerHTML = '';
            let visibleTickets = ticketCache;
            
            // 1. Filter by Category (Internal/External)
            if (ticketFilter === 'internal') visibleTickets = visibleTickets.filter(t => t.data.source === "internal");
            else if (ticketFilter === 'external') visibleTickets = visibleTickets.filter(t => t.data.source !== "internal");

            // 2. Filter by Search Text
            const s = searchStates.support;
            if(s) {
                visibleTickets = visibleTickets.filter(t => {
                    const d = t.data;
                    const str = `${d.name} ${d.type} ${d.message} ${t.id}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visibleTickets.length === 0) {
                const colspan = isSuperAdmin ? 9 : 8;
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center; padding:2rem;">No tickets.</td></tr>`;
                return;
            }
            visibleTickets.forEach(item => {
                const doc = item;
                const data = item.data;
                const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : '-';
                let statusClass = data.status === 'Resolved' ? 'status-paid' : 'status-open';
                
                // Badges
                const isInternal = data.source === "internal";
                const rowClass = isInternal ? "row-internal" : "";
                const sourceBadge = isInternal ? `<span class="source-badge badge-internal">Team</span>` : `<span class="source-badge badge-external">User</span>`;
                
                // Target Info
                const targetInfo = data.targetName ? `<div style="font-size:0.7rem; color:var(--text-secondary); margin-top:4px;">Target: <b>${data.targetName}</b></div>` : '';
                
                const internalNoteCell = isSuperAdmin ? `<td style="max-width: 200px; font-size:0.8rem; color:var(--text-secondary);">${data.adminNote || '-'}</td>` : '';

                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td style="color:var(--text-secondary); font-size:0.9rem;">${date}</td>
                        <td><span style="font-family:monospace; font-size:0.8rem; color:var(--accent-primary); font-weight:700;">${doc.id.substring(0,8)}...</span></td>
                        <td>${sourceBadge}</td>
                        <td style="font-weight:700;">${data.type}</td>
                        <td><div style="font-weight:600;">${data.name}</div><div style="font-size:0.8rem; color:var(--text-secondary);">${data.email}</div></td>
                        <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; position: relative;">
                            ${data.message}
                            ${targetInfo}
                        </td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        ${internalNoteCell}
                        <td><button class="action-btn" onclick="openTicketModal('${doc.id}', '${data.status}', '${(data.adminNote || '').replace(/'/g, "\\'")}')">Manage</button></td>
                    </tr>`;
            });
        }

        function renderVoucherTable() {
            const tbody = document.getElementById('voucher-table-body');
            tbody.innerHTML = '';
            const usersWithVouchers = allUsers.filter(u => u.personalVoucher);
            
            let visibleVouchers = usersWithVouchers;
            // Apply Search
            const s = searchStates.vouchers;
            if(s) {
                visibleVouchers = visibleVouchers.filter(u => {
                    const v = u.personalVoucher;
                    const str = `${u.name} ${v.code}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visibleVouchers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1rem; color:var(--text-secondary);">No vouchers.</td></tr>';
                return;
            }
            visibleVouchers.forEach(u => {
                const v = u.personalVoucher;
                const displayVal = v.type === 'fixed' ? `RM ${v.value}` : `${v.value * 100}%`;
                const createdBy = v.voucherCreatedBy || '-';

                const createdByCell = isSuperAdmin ? `<td style="font-size:0.8rem;">${createdBy}</td>` : '';

                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:600;">${u.name}</td>
                        <td style="color:var(--accent-primary);">${v.code}</td>
                        <td style="color:var(--success);">${displayVal}</td>
                        ${createdByCell}
                        <td><button class="action-btn" style="color:var(--danger);" onclick="deleteUserVoucher('${u.id}')">Remove</button></td>
                    </tr>`;
            });
        }

        function renderPromoTable() {
            const tbody = document.getElementById('promo-table-body');
            tbody.innerHTML = '';
            
            let visiblePromos = promoCache;
            // Apply Search
            const s = searchStates.promos;
            if(s) {
                visiblePromos = visiblePromos.filter(p => {
                    const str = `${p.id}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visiblePromos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:2rem;">No promos found.</td></tr>';
                return;
            }
            visiblePromos.forEach(doc => {
                const data = doc.data;
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:700; color: var(--accent-primary);">${doc.id}</td>
                        <td style="font-weight:700; color: var(--success);">${(data.discount * 100).toFixed(0)}%</td>
                        <td><button class="action-btn" style="color: var(--danger);" onclick="deletePromo('${doc.id}')">Del</button></td>
                    </tr>`;
            });
        }

        // SYSTEM LOGS LOGIC
        function loadLogsTab(type) {
            // Update UI buttons
            const buttons = document.querySelectorAll('#tab-logs .sm-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            let activeBtnId = 'btn-log-all';
            if(type === 'tickets') activeBtnId = 'btn-log-tickets';
            if(type === 'vouchers') activeBtnId = 'btn-log-vouchers';
            
            const activeBtn = document.getElementById(activeBtnId);
            if(activeBtn) activeBtn.classList.add('active');

            currentLogFilter = type;
            renderLogsTable();
        }

        function renderLogsTable() {
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';
            
            let logEntries = [];

            // 1. GENERATE LOGS FROM DATA
            // Vouchers
            allUsers.filter(u => u.personalVoucher).forEach(u => {
                const v = u.personalVoucher;
                const date = v.voucherTimestamp ? new Date(v.voucherTimestamp.toDate()).toLocaleString() : '-';
                logEntries.push({
                    timestamp: date,
                    admin: v.voucherCreatedBy || 'Admin',
                    action: 'Assigned Voucher',
                    detail: `Code: ${v.code} to ${u.name}`,
                    type: 'voucher'
                });
            });

            // Tickets (Resolved)
            ticketCache.filter(t => t.data.status === 'Resolved').slice(0, 20).forEach(t => {
                const date = t.data.timestamp ? new Date(t.data.timestamp.toDate()).toLocaleString() : '-';
                const note = t.data.adminNote || '';
                const adminMatch = note.match(/Updated by: (.*?)\s/);
                const admin = adminMatch ? adminMatch[1] : 'Admin';
                logEntries.push({
                    timestamp: date,
                    admin: admin,
                    action: 'Resolved Ticket',
                    detail: `Case #${t.id.substring(0,6)}: ${t.data.name} (${note ? note : ''})`,
                    type: 'ticket'
                });
            });

            // Sort by timestamp descending
            logEntries.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            // 2. Filter by Category
            if(currentLogFilter !== 'all') {
                if(currentLogFilter === 'vouchers') logEntries = logEntries.filter(l => l.type === 'voucher');
                if(currentLogFilter === 'tickets') logEntries = logEntries.filter(l => l.type === 'ticket');
            }

            // 3. Filter by Search Text
            const s = searchStates.logs;
            if(s) {
                logEntries = logEntries.filter(l => {
                    const str = `${l.admin} ${l.action} ${l.detail}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(logEntries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:2rem; color:var(--text-secondary);">No logs found.</td></tr>`;
                return;
            }

            logEntries.forEach(log => {
                tbody.innerHTML += `
                    <tr class="log-entry">
                        <td class="log-timestamp">${log.timestamp}</td>
                        <td class="log-admin">${log.admin}</td>
                        <td style="font-weight:600; font-size:0.85rem;">${log.action}</td>
                        <td class="log-detail">${log.detail}</td>
                    </tr>`;
            });
        }

        function updateContentUI() {
            if(siteConfig.packageDetails) {
                const frontData = siteConfig.packageDetails.frontend || DEFAULT_DETAILS.frontend;
                const aiData = siteConfig.packageDetails.ai || DEFAULT_DETAILS.ai;
                document.getElementById('details-frontend').value = frontData.join('\n');
                document.getElementById('details-ai').value = aiData.join('\n');
            } else {
                document.getElementById('details-frontend').value = DEFAULT_DETAILS.frontend.join('\n');
                document.getElementById('details-ai').value = DEFAULT_DETAILS.ai.join('\n');
            }
        }

        function saveContentConfig() {
            const frontText = document.getElementById('details-frontend').value;
            const aiText = document.getElementById('details-ai').value;
            siteConfig.packageDetails = {
                frontend: frontText.split('\n').filter(line => line.trim() !== ''),
                ai: aiText.split('\n').filter(line => line.trim() !== '')
            };
            db.collection("config").doc("site_settings").set({ packageDetails: siteConfig.packageDetails }, { merge: true }).then(() => alert("Details Updated!")).catch(err => alert(err.message));
        }

        function updateMaintenanceUI() {
            const toggleCircle = document.getElementById('maintenance-toggle-circle');
            if(siteConfig.maintenance_active) {
                toggleCircle.style.left = '27px'; toggleCircle.style.background = '#10b981';
                document.getElementById('maintenance-msg').value = siteConfig.message || "Site is under maintenance.";
            } else {
                toggleCircle.style.left = '3px'; toggleCircle.style.background = '#555';
                document.getElementById('maintenance-msg').value = "";
            }
        }

        function toggleMaintenanceStatus() {
            siteConfig.maintenance_active = !siteConfig.maintenance_active;
            updateMaintenanceUI();
        }

        function saveMaintenanceConfig() {
            const msg = document.getElementById('maintenance-msg').value;
            siteConfig.message = msg;
            db.collection("config").doc("site_settings").set({ maintenance_active: siteConfig.maintenance_active, message: msg }, { merge: true }).then(() => alert("Saved!"));
        }

        function updatePricingUI() {
            if(siteConfig.prices) {
                document.getElementById('price-html').value = siteConfig.prices.html || 199;
                document.getElementById('price-frontend').value = siteConfig.prices.frontend || 599;
            }
        }

        function savePricingConfig() {
            const htmlPrice = parseFloat(document.getElementById('price-html').value);
            const frontendPrice = parseFloat(document.getElementById('price-frontend').value);
            siteConfig.prices = { html: htmlPrice, frontend: frontendPrice };
            db.collection("config").doc("site_settings").update({ prices: siteConfig.prices }).then(() => alert("Prices updated!"));
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Highlight correct nav item
            const navItems = document.querySelectorAll('.nav-item');
            if(tabId === 'orders') navItems[0].classList.add('active');
            if(tabId === 'users') navItems[1].classList.add('active');
            if(tabId === 'support') navItems[2].classList.add('active');
            if(tabId === 'vouchers') navItems[3].classList.add('active');
            if(tabId === 'promos') navItems[4].classList.add('active');
            if(tabId === 'logs') navItems[5].classList.add('active');
            if(tabId === 'maintenance') navItems[6].classList.add('active');
            if(tabId === 'content') navItems[7].classList.add('active');

            // Automatically load logs if Logs tab is opened
            if(tabId === 'logs') {
                loadLogsTab(currentLogFilter || 'all');
            }
        }

        function openEditUser(uid, name, phone, role, jobTitle) {
            document.getElementById('edit-uid').value = uid;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-phone').value = phone;
            document.getElementById('edit-role').value = role || 'user';
            
            const roleSelect = document.getElementById('edit-role');
            const jobTitleInput = document.getElementById('edit-jobtitle');
            const nameInput = document.getElementById('edit-name');
            const phoneInput = document.getElementById('edit-phone');
            const helperLabel = document.getElementById('jobtitle-helper');
            const restrictionMsg = document.getElementById('edit-restriction-msg');

            const isTargetSuperAdmin = (role === 'superadmin');

            if (!isSuperAdmin) {
                // CURRENT USER IS STANDARD ADMIN
                if (isTargetSuperAdmin) {
                    nameInput.disabled = true;
                    phoneInput.disabled = true;
                    roleSelect.disabled = true;
                    jobTitleInput.disabled = true;
                    restrictionMsg.style.display = 'block';
                    restrictionMsg.innerText = "Standard Admins cannot edit SuperAdmin accounts.";
                    restrictionMsg.style.color = 'var(--warning)';
                    helperLabel.style.display = 'none';
                } else {
                    nameInput.disabled = false;
                    phoneInput.disabled = false;
                    roleSelect.disabled = true; 
                    jobTitleInput.disabled = true; 
                    restrictionMsg.style.display = 'none';
                    helperLabel.style.display = 'none';
                }
            } else {
                // SUPER ADMIN PRIVILEGES
                nameInput.disabled = false;
                phoneInput.disabled = false;
                roleSelect.disabled = false;
                jobTitleInput.disabled = false;
                jobTitleInput.value = jobTitle || "";
                helperLabel.style.display = 'inline';
                restrictionMsg.style.display = 'none';
            }
            document.getElementById('editUserModal').classList.add('open');
        }

        function saveUser() {
            const uid = document.getElementById('edit-uid').value;
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const role = document.getElementById('edit-role').value;
            
            if (!isSuperAdmin && role === 'superadmin') {
                alert("You do not have permission to modify SuperAdmin accounts.");
                return;
            }

            if(!name || !phone) return alert("Fields cannot be empty");
            
            const updateData = { 
                name: name, 
                phone: phone, 
                role: role
            };

            if (isSuperAdmin) {
                updateData.jobTitle = document.getElementById('edit-jobtitle').value;
            }

            db.collection("users").doc(uid).update(updateData).then(() => { closeModal('editUserModal'); alert("User updated"); }).catch(err => alert(err.message));
        }

        function resetUserPass(email) {
            if(confirm(`Reset password for ${email}?`)) {
                auth.sendPasswordResetEmail(email).then(() => alert("Reset email sent.")).catch(err => alert(err.message));
            }
        }

        function openOrderModal(orderId, currentStatus, note, companyName, pkg, total, voucher) {
            document.getElementById('order-id').value = orderId;
            document.getElementById('order-status-select').value = currentStatus || 'Pending';
            document.getElementById('order-admin-note').value = note || '';
            document.getElementById('order-company-name').value = companyName || ''; 
            document.getElementById('order-package').value = pkg || ''; 
            document.getElementById('order-total').value = total || ''; 
            document.getElementById('order-voucher').value = voucher || '-'; 
            document.getElementById('orderModal').classList.add('open');
        }

        function saveOrder() {
            const id = document.getElementById('order-id').value;
            const status = document.getElementById('order-status-select').value;
            const note = document.getElementById('order-admin-note').value;
            const companyName = document.getElementById('order-company-name').value; 
            const pkg = document.getElementById('order-package').value;
            const total = document.getElementById('order-total').value;

            db.collection("orders").doc(id).update({ 
                status: status, 
                adminNote: note,
                companyName: companyName,
                package: pkg,
                total: total
            }).then(() => { closeModal('orderModal'); alert("Order updated"); }).catch(err => alert(err.message));
        }

        function openTicketModal(ticketId, currentStatus, note) {
            document.getElementById('ticket-id').value = ticketId;
            document.getElementById('ticket-status-select').value = currentStatus;
            document.getElementById('ticket-admin-note').value = note || '';
            document.getElementById('ticketModal').classList.add('open');
        }

        function saveTicket() {
            const id = document.getElementById('ticket-id').value;
            const status = document.getElementById('ticket-status-select').value;
            const note = document.getElementById('ticket-admin-note').value;
            db.collection("tickets").doc(id).update({ status: status, adminNote: note }).then(() => { closeModal('ticketModal'); alert("Ticket updated"); }).catch(err => alert(err.message));
        }

        function assignVoucher() {
            const uid = document.getElementById('voucher-user-select').value;
            const code = document.getElementById('voucher-code').value.trim().toUpperCase();
            const val = parseFloat(document.getElementById('voucher-val').value);
            const type = document.getElementById('voucher-type').value;
            if(!uid) return alert("Please select a user.");
            if(!code || isNaN(val)) return alert("Invalid Voucher Details.");

            const voucherData = {
                code: code,
                value: val,
                type: type,
                voucherCreatedBy: currentAdminEmail,
                voucherTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("users").doc(uid).update({ personalVoucher: voucherData }).then(() => {
                alert(`Voucher ${code} assigned!`);
                refreshVoucherTable();
            }).catch(err => alert(err.message));
        }

        function refreshVoucherTable() {
            renderVoucherTable();
        }

        function deleteUserVoucher(uid) {
            if(confirm("Remove voucher?")) db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
        }

        function createPromo() {
            const code = document.getElementById('new-promo-code').value.trim().toUpperCase();
            const val = parseFloat(document.getElementById('new-promo-val').value);
            if(!code || isNaN(val)) return alert("Invalid input");
            if(val <= 0 || val >= 1) return alert("Discount must be between 0 and 1");
            db.collection("promo_codes").doc(code).set({ discount: val }).then(() => { document.getElementById('new-promo-code').value = ''; document.getElementById('new-promo-val').value = ''; alert("Promo Code Created!"); }).catch(err => alert(err.message));
        }

        function deletePromo(code) {
            if(confirm(`Delete code ${code}?`)) db.collection("promo_codes").doc(code).delete();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }
    </script>
</body>
</html>
