<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DDNetwork(Admin)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Dark Mode (Default) - Optimized Contrast */
            --bg-body: #050505;
            --bg-card: #121212;
            --bg-input: rgba(255,255,255,0.07);
            --bg-input-focus: rgba(59, 130, 246, 0.15);
            --bg-sidebar: #0f0f0f;
            
            --text-main: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            
            --border-color: rgba(255,255,255,0.12);
            --border-focus: #3b82f6;
            
            --accent-primary: #3b82f6;
            --accent-hover: #2563eb;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-modal: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            
            --nav-height-mobile: 70px;
            --header-height-mobile: 60px;
        }

        [data-theme="light"] {
            /* Light Mode - Clean White & High Contrast */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --bg-input-focus: #eff6ff;
            --bg-sidebar: #ffffff;

            --text-main: #0f172a; /* Dark Navy */
            --text-secondary: #64748b; /* Slate Gray */
            --text-muted: #94a3b8;

            --border-color: #e2e8f0; /* Light Gray borders */
            --border-focus: #3b82f6;
            
            --shadow-card: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-modal: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-float: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Global Reset & Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            height:100%;
            width:100%;
            margin:0;
            padding:0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- LOADER ANIMATION --- */
        .loader-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding:3rem 0;
            gap:1rem;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-bottom-color: var(--accent-primary);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }
        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            border:1px solid var(--border-color);
            box-shadow: var(--shadow-float);
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 14px;
            min-width: 300px;
            position: relative;
            overflow: hidden;
            pointer-events: auto;
            transform-origin: right center;
            animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .toast::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            width: 100%;
            background: var(--border-color);
            animation: toastProgress 4s linear forwards;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--accent-primary); }
        .toast i { font-size: 1.35rem; flex-shrink: 0; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.info i { color: var(--accent-primary); }
        @keyframes toastIn {
            from { transform: translateX(100%) scale(0.9); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        @keyframes toastOut {
            to { transform: translateX(100%) scale(0.9); opacity: 0; }
        }
        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: fixed;
            top: 0; left: 0;
            background: var(--bg-body);
            z-index: 200;
            overflow-y: auto;
            padding: 20px;
        }
        .login-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 20px;
            border:1px solid var(--border-color);
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-modal);
            position: relative;
        }
        .login-card h2 { margin-bottom:0.5rem; color: var(--text-main); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .login-card p { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 2rem; }
        
        /* Inputs & Buttons */
        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-input);
            border:1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-main);
            margin-bottom:1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            -webkit-appearance: none; 
        }
        input:disabled, select:disabled, textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-body);
            border-color: transparent;
        }
        textarea { height: 120px; resize: vertical; line-height: 1.5; }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--border-focus); 
            outline: none; 
            background: var(--bg-input-focus); 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 10px -1px rgba(59, 130, 246, 0.3); }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        button.secondary { background: var(--text-muted); color: var(--text-main); box-shadow: none; }
        button.secondary:hover { background: var(--text-secondary); }
        button.danger { background: var(--danger); box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2); }
        button.danger:hover { box-shadow: 0 6px 10px -1px rgba(239, 68, 68, 0.3); }
        button.sm-btn { width: auto; padding: 8px 16px; font-size: 0.8rem; }
        button.success { background: var(--success); box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
        button.success:hover { box-shadow: 0 6px 10px -1px rgba(16, 185, 129, 0.3); }
        button.warning { background: var(--warning); color: black; box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.2); }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard {
            display: none; 
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: row;
        }
        
        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right:1px solid var(--border-color);
            padding: 2rem 1.25rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            height: 100%;
        }

        .sidebar-scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            margin-top:1rem;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        .sidebar-scroll-area::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll-area::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scroll-area::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 20px; }

        .sidebar-close-btn {
            display: none; 
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            margin-left: auto; 
            font-size: 1.5rem;
            line-height: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
        }
        .sidebar-close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            transform: rotate(90deg);
        }

        .brand {
            font-size:1rem;
            margin-bottom: 0.5rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            width: 100%;
            flex-shrink: 0;
        }
        .brand-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-logo {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .brand-icon {
            font-size: 1.2rem;
            color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
            padding: 6px;
            border-radius: 8px;
        }
        .brand-info {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
            flex: 1;
            text-align: left;
            margin-left: 10px;
        }
        .brand-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .brand-job {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: 2px;
        }

        /* Nav Items */
        .nav-item {
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
            border-left: 3px solid transparent;
        }
        .nav-item i { font-size: 1.1rem; }
        .nav-item:hover {
            background: rgba(59, 130, 246, 0.08); 
            color: var(--text-main);
        }
        .nav-item.active {
            background: var(--bg-input-focus);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
            font-weight: 600;
        }
        
        .logout-btn { margin-top: auto; color: var(--danger); flex-shrink: 0; }
        .logout-btn:hover { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-left-color: var(--danger); }

        .theme-toggle-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: auto;
            margin: 0;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle-btn:hover {
            background: var(--bg-input);
            color: var(--accent-primary);
            transform: scale(1.05);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: 100%; 
            position: relative;
            background-color: var(--bg-body);
        }

        /* --- MOBILE HEADER --- */
        .mobile-brand-header {
            display: none; 
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 1.2rem;
            margin: 0 -1rem; 
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 40;
            background: var(--bg-body); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .hamburger-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .hamburger-btn:active { transform: scale(0.95); background: var(--bg-input); }

        /* --- TABS & TABLES --- */
        .tab-content { display: none; animation: fadeIn 0.3s ease; padding-bottom: 2rem; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .section-header h2 { margin: 0; font-size: 1.75rem; color: var(--text-main); font-weight: 700; }

        .search-container { position: relative; margin-bottom: 1.5rem; }
        .search-container input { margin-bottom: 0; padding-left: 3rem; border-radius: 12px; }
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* --- STATS CARDS --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            box-shadow: var(--shadow-card);
            transition: transform 0.2s, border-color 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent-primary); }
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        
        .stat-info h3 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
        .stat-info p { margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- FILTER BUTTONS --- */
        .ticket-filters {
            display: flex;
            gap: 6px;
            background: var(--bg-card);
            padding: 6px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .filter-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            width: auto;
            margin: 0;
            transition: 0.2s;
            font-weight: 600;
        }
        .filter-btn:hover { background: var(--bg-input); color: var(--text-main); }
        .filter-btn.active { background: var(--accent-primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* --- TABLES (Improved) --- */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 16px;
            background: var(--bg-card);
            border:1px solid var(--border-color);
            box-shadow: var(--shadow-card);
            margin-bottom: 2rem;
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { text-align: left; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        th { 
            background: var(--bg-input); 
            font-size: 0.75rem; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--bg-input); }
        
        /* STATUS BADGES */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        .status-pending { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .status-paid, .status-completed { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status-cancelled { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .status-open { background: rgba(59, 130, 246, 0.15); color: var(--accent-primary); border: 1px solid rgba(59, 130, 246, 0.3); }
        .status-inactive { background: rgba(100, 100, 100, 0.15); color: #999; border: 1px solid rgba(100, 100, 100, 0.3); }
        .status-expired { background: rgba(255, 255, 255, 0.05); color: #94a3b8; border: 1px solid #94a3b8; text-decoration: line-through; } 

        /* PLAN BADGES */
        .plan-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
        }
        .plan-frontend { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .plan-ai { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); }
        .plan-html { background: rgba(100, 116, 139, 0.15); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.3); }
        .plan-expired { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }

        /* ROLE BADGES */
        .role-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        .role-admin { background: var(--accent-primary); color: white; } 
        .role-superadmin { background: var(--warning); color: black; border: 1px solid rgba(0,0,0,0.1); } 
        .role-user { background: var(--text-muted); color: var(--text-main); } 

        /* ACTION BUTTONS */
        .action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 8px 14px;
            margin-right: 6px;
            font-size: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-main);
            transition: 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-btn:hover { background: var(--bg-input); border-color: var(--text-secondary); }
        
        /* Payment specific styles */
        .pay-url-text {
            max-width: 250px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            display: inline-block; 
            vertical-align: middle;
            font-family: monospace;
        }

        /* --- SOURCE BADGES --- */
        .source-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-internal { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-external { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        .row-internal { background: rgba(245, 158, 11, 0.03); }

        /* ADMIN CARDS */
        .admin-card {
            background: var(--bg-card);
            padding: 1.75rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            scroll-margin-top: 100px; 
            transition: background 0.3s, border-color 0.3s;
            box-shadow: var(--shadow-card);
        }
        .admin-card h3 { margin-bottom: 1rem; color: var(--text-main); font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
        .form-row { margin-bottom: 1.2rem; text-align: left; }
        .form-row label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 600;}
        .helper-text { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .form-group { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

        /* ALERTS */
        .alert-box {
            padding: 1rem;
            border-radius: 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            margin-bottom: 1.5rem;
        }
        .alert-text { font-size: 0.9rem; color: var(--warning); font-weight: 600; line-height: 1.5; }

        /* --- MODAL --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        
        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-modal);
            max-height: 90vh;
            overflow-y: auto;
            color: var(--text-main);
            position: relative;
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
            z-index: 5;
        }
        .modal-close-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        .modal-content h3 { margin-top: 0; color: var(--text-main); margin-bottom: 1.5rem; padding-right: 2rem; }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            #dashboard { flex-direction: column; }
            .sidebar {
                position: fixed;
                top: 0; left: 0; bottom: 0;
                width: 85%;
                max-width: 320px;
                transform: translateX(-100%);
                border-right: 1px solid var(--border-color);
                z-index: 100;
                padding: 1.5rem;
                box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            }
            .sidebar.mobile-open { transform: translateX(0); }
            .sidebar-close-btn { display: flex; }
            .brand { margin-top: 0; margin-bottom: 1.5rem; border-bottom: none; }
            .logout-btn { margin-bottom: 0; }
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 90;
                backdrop-filter: blur(2px);
            }
            .sidebar-overlay.active { display: block; }
            .mobile-brand-header { display: flex; }
            
            .nav-item { padding: 16px 12px; font-size: 1rem; border-radius: 10px; border-left: none; }
            .nav-item.active { background: rgba(59, 130, 246, 0.15); color: var(--accent-primary); border-left: none; }
            .main-content { padding: 1rem; padding-bottom: 2rem; }
            .section-header { flex-direction: column; align-items: stretch; gap: 0.8rem; }
            .section-header h2 { font-size: 1.5rem; }
            
            .modal-overlay { padding: 0; align-items: flex-end; background: rgba(0,0,0,0.8); }
            .modal-content {
                width: 100%;
                max-width: 100%;
                max-height: 90vh;
                border-radius: 20px 20px 0 0;
                border: none;
                border-top: 1px solid var(--border-color);
                padding: 1.5rem;
                animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            }
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            .form-row input, .form-row select { font-size: 16px; }
        }
    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <button class="theme-toggle-btn" style="position: absolute; top: 20px; right: 20px; z-index: 201;" onclick="toggleTheme()" aria-label="Toggle Theme">
            <i id="theme-icon-login" class="ri-moon-line"></i>
        </button>

        <div class="login-card">
            <div style="margin-bottom: 1.5rem;">
                <img src="https://raw.githubusercontent.com/ddnetwork-ent/DDN-One/refs/heads/main/DD-LOGO.JPEG" alt="DDN Logo" style="width: 80px; height: 80px; object-fit: cover; border-radius: 12px; border: 2px solid var(--border-color);">
            </div>
            <h2>Internal Portal</h2>
            <p>Access Control System</p>
            <form onsubmit="handleAdminLogin(event)">
                <input type="text" id="admin-email" placeholder="Email or Employee ID" required autocomplete="username">
                <input type="password" id="admin-password" placeholder="Password" required autocomplete="current-password">
                <button type="submit">Secure Login</button>
            </form>
            <p id="login-error" style="color: var(--danger); font-size: 0.85rem; margin-top: 1rem; display: none;"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display: none;">
        
        <!-- SIDEBAR OVERLAY (Mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="brand">
                <div class="brand-left">
                    <img src="https://raw.githubusercontent.com/ddnetwork-ent/DDN-One/refs/heads/main/DD-LOGO.JPEG" alt="DDN Logo" class="brand-logo">
                    <div class="brand-info">
                        <!-- IDs added here to update dynamically -->
                        <span id="sidebar-name" class="brand-name">Loading...</span>
                        <span id="sidebar-jobtitle" class="brand-job">Loading...</span>
                    </div>
                </div>
                
                <button class="sidebar-close-btn" onclick="toggleSidebar()" aria-label="Close Menu">
                    <i class="ri-close-line"></i>
                </button>
            </div>

            <!-- SCROLLABLE AREA WRAPPER -->
            <div class="sidebar-scroll-area">
                <div class="nav-item active" onclick="switchTab('dashboard')">
                    <i class="ri-dashboard-line"></i> <span>Overview</span>
                </div>
                <div class="nav-item" onclick="switchTab('orders')">
                    <i class="ri-shopping-bag-3-line"></i> <span>Orders</span>
                </div>
                <div class="nav-item" onclick="switchTab('users')">
                    <i class="ri-group-line"></i> <span>Users</span>
                </div>
                <div class="nav-item" onclick="switchTab('tasks')">
                    <i class="ri-task-line"></i> <span>Tasks</span>
                </div>
                <div class="nav-item" onclick="switchTab('support')">
                    <i class="ri-customer-service-2-line"></i> <span>Support</span>
                </div>
                <div class="nav-item" onclick="switchTab('vouchers')">
                    <i class="ri-gift-line"></i> <span>Vouchers</span>
                </div>
                <div class="nav-item" onclick="switchTab('promos')">
                    <i class="ri-coupon-3-line"></i> <span>Promo</span>
                </div>
                <!-- CONTENT REQUESTS -->
                <div class="nav-item" onclick="switchTab('content-requests')">
                    <i class="ri-file-text-line"></i> <span>Content Req</span>
                </div>
                <div class="nav-item" id="nav-logs" onclick="switchTab('logs')">
                    <i class="ri-file-history-line"></i> <span>Logs</span>
                </div>
                <div class="nav-item" onclick="switchTab('maintenance')">
                    <i class="ri-settings-4-line"></i> <span>Config</span>
                </div>
                <div class="nav-item" onclick="switchTab('content')">
                    <i class="ri-file-list-3-line"></i> <span>Content</span>
                </div>
            </div>

            <div class="nav-item logout-btn" onclick="handleLogout()">
                <i class="ri-logout-box-r-line"></i> <span>Logout</span>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            
            <!-- MOBILE PROFILE HEADER -->
            <div class="mobile-brand-header">
                <div style="display:flex; gap:15px; align-items:center;">
                    <button class="hamburger-btn" onclick="toggleSidebar()">
                        <i class="ri-menu-2-line"></i>
                    </button>
                    <div>
                        <span id="mobile-name" style="display:block; font-weight:700; font-size:0.95rem;">Loading...</span>
                        <span id="mobile-jobtitle" style="display:block; font-size:0.75rem; color:var(--text-secondary);">Loading...</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="Toggle Theme">
                        <i id="theme-icon-mobile" class="ri-moon-line"></i>
                    </button>
                    <button class="action-btn sm-btn" onclick="handleLogout()" style="color:var(--danger); border-color:var(--danger); padding: 8px 12px;" aria-label="Logout">
                        <i class="ri-logout-box-line" style="font-size: 1.2rem;"></i>
                    </button>
                </div>
            </div>

            <!-- DASHBOARD TAB (OVERVIEW) -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <div style="font-size: 0.8rem; color: var(--success); display: flex; align-items: center; gap: 6px;">
                        <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success);"></span>
                        System Operational
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="ri-ticket-2-line"></i></div>
                        <div class="stat-info">
                            <h3 id="stat-pending-tickets">0</h3>
                            <p>Pending Tickets</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="ri-time-line"></i></div>
                        <div class="stat-info">
                            <h3 id="stat-pending-orders">0</h3>
                            <p>Pending Requests</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="ri-user-smile-line"></i></div>
                        <div class="stat-info">
                            <h3 id="stat-total-clients">0</h3>
                            <p>Total Clients</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="ri-admin-line"></i></div>
                        <div class="stat-info">
                            <h3 id="stat-total-admins">0</h3>
                            <p>Total Admins</p>
                        </div>
                    </div>
                </div>

                <div class="admin-card" style="margin-top: 2rem;">
                    <h3><i class="ri-pulse-line" style="color: var(--accent-primary);"></i> Recent Activity</h3>
                    <div id="dashboard-logs-list" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- ORDERS TAB -->
            <div id="tab-orders" class="tab-content">
                <div class="section-header">
                    <h2>Orders</h2>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        <i class="ri-refresh-line"></i> Live Updates
                    </div>
                </div>
                
                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-orders" placeholder="Search Name, ID, Company..." onkeyup="handleSearch('orders', this.value)">
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Company</th>
                                <th>Package</th>
                                <th>Voucher Used</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- USERS TAB -->
            <div id="tab-users" class="tab-content">
                <div class="section-header">
                    <h2>User Management</h2>
                    <div class="section-header-actions" style="display:flex; gap: 10px; flex-wrap:wrap;">
                        <button class="action-btn warning" style="border-color: var(--warning); color: white;" onclick="requestAdminReset()">
                            <i class="ri-lock-password-line"></i> Request My Pwd Reset
                        </button>
                        <button class="action-btn success" style="color:white; border:none;" onclick="openCreateUserModal()">
                            <i class="ri-user-add-line"></i> Create New User
                        </button>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-users" placeholder="Search ID, Name, Company, Email..." onkeyup="handleSearch('users', this.value)">
                </div>

                <!-- EMPLOYEES TABLE -->
                <h3 style="margin: 2rem 0 1rem 0; font-size: 1.1rem; color: var(--accent-primary); display: flex; align-items: center; gap: 8px;">
                    <i class="ri-briefcase-4-line"></i> Employees (Admin & SuperAdmin)
                </h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Emp ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Job Title</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employees-table-body">
                            <!-- Populated JS -->
                        </tbody>
                    </table>
                </div>

                <!-- CLIENTS TABLE (Improved) -->
                <h3 style="margin: 2rem 0 1rem 0; font-size: 1.1rem; color: var(--success); display: flex; align-items: center; gap: 8px;">
                    <i class="ri-user-heart-line"></i> Clients
                </h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Client ID</th>
                                <th>Customer Name</th>
                                <th>Company</th>
                                <th>Subscription</th>
                                <th>Expiry</th>
                                <th>Website Link</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body">
                            <!-- Populated JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TASKS TAB -->
            <div id="tab-tasks" class="tab-content">
                <div class="section-header">
                    <h2>Task Management</h2>
                    <div id="task-create-btn-container" style="display:none;">
                        <button class="action-btn success" style="color:white; border:none;" onclick="openCreateTaskModal()">
                            <i class="ri-add-line"></i> Assign Task
                        </button>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-tasks" placeholder="Search Tasks..." onkeyup="handleSearch('tasks', this.value)">
                </div>

                <!-- Reassignment Queue (SuperAdmin Only) -->
                <div id="task-reassign-queue" class="admin-card" style="border-color: var(--warning); display:none;">
                    <h3 style="color: var(--warning);"><i class="ri-shuffle-line"></i> Pending Reassignments</h3>
                    <div id="reassign-list-container"></div>
                </div>

                <!-- Tasks List -->
                <div id="tasks-list-container">
                    <!-- Dynamic Task Cards injected here -->
                </div>
            </div>

            <!-- SUPPORT TAB -->
            <div id="tab-support" class="tab-content">
                <div class="section-header">
                    <h2>Support Desk</h2>
                    <div class="section-header-actions">
                         <button class="action-btn success" style="color:white; border:none;" onclick="openInternalTicketModal()">
                            <i class="ri-add-box-line"></i> Create Ticket
                        </button>
                        <div class="ticket-filters">
                            <button class="filter-btn active" onclick="filterTickets('all', this)">All</button>
                            <button class="filter-btn" onclick="filterTickets('internal', this)">Internal</button>
                            <button class="filter-btn" onclick="filterTickets('external', this)">External</button>
                        </div>
                    </div>
                </div>
                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-support" placeholder="Search Name, Type, Message..." onkeyup="handleSearch('support', this.value)">
                </div>
                <div class="table-responsive" style="margin-bottom: 2rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Case ID</th>
                                <th>Source</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Assigned To</th>
                                <th>Status</th>
                                <th>Resolved By</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VOUCHERS TAB -->
            <div id="tab-vouchers" class="tab-content">
                <div class="section-header">
                    <h2>Assign Voucher</h2>
                </div>
                
                <!-- Create Form -->
                <div id="voucher-create-wrapper" class="admin-card">
                    <h3>Send Gift Voucher</h3>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                        <div style="grid-column: 1 / -1;">
                            <label>Select Customer</label>
                            <select id="voucher-user-select" style="margin-bottom: 0;">
                                <option value="" disabled selected>Loading Users...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Code</label>
                            <input type="text" id="voucher-code" placeholder="e.g. GIFT50">
                        </div>
                        <div>
                            <label>Value</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="voucher-val" placeholder="50" step="1">
                                <select id="voucher-type" style="width: auto;">
                                    <option value="fixed">RM</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Expiry Date Input -->
                    <div class="form-row">
                         <label>Expiry Date (Optional)</label>
                         <input type="date" id="voucher-expiry-date">
                         <p class="helper-text">Leave empty for no expiry.</p>
                    </div>

                    <p class="helper-text" id="voucher-helper-text">
                        As an Admin, this voucher will be created as <b>Pending</b> until SuperAdmin approval.
                    </p>

                    <button onclick="assignVoucher()" style="margin-top: 1rem;">Assign Voucher</button>
                </div>

                <!-- Pending Requests Queue -->
                <div id="voucher-approval-queue" class="admin-card" style="border-color: var(--warning);">
                    <h3 style="color: var(--warning);"><i class="ri-alert-line"></i> <span id="voucher-queue-title">Pending Voucher Requests</span></h3>
                    <div class="table-responsive" style="margin-bottom: 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Code</th>
                                    <th>Value</th>
                                    <th>Created By</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pending-vouchers-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-vouchers" placeholder="Search Code or User..." onkeyup="handleSearch('vouchers', this.value)">
                </div>

                <div class="table-responsive" style="margin-top: 2rem;">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Active Assignments</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Code</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="voucher-table-body"></tbody>
                    </table>
                </div>

                <!-- NEW TABLE: REDEMPTION & HISTORY -->
                <div class="table-responsive" style="margin-top: 2rem;">
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        <i class="ri-history-line"></i> Redemption & History
                    </h3>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Code</th>
                                <th>Value</th>
                                <th>Status</th>
                                <th>Expiry</th>
                            </tr>
                        </thead>
                        <tbody id="voucher-history-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- PROMOS TAB -->
            <div id="tab-promos" class="tab-content">
                <div class="section-header">
                    <h2>Promo Codes</h2>
                </div>
                
                <div id="promo-create-wrapper" class="admin-card">
                    <h3>Create Global Promo</h3>
                    <form onsubmit="event.preventDefault(); createPromo();">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px;">
                            <input type="text" id="new-promo-code" placeholder="Code" style="margin:0;" required>
                            <input type="number" id="new-promo-val" placeholder="0.5" step="0.01" style="margin:0;" required>
                            <button type="submit" style="width: auto; white-space: nowrap;">Add</button>
                        </div>
                    </form>
                    <p class="helper-text" id="promo-helper-text">
                        As an Admin, this promo will be created as <b>Pending</b> until SuperAdmin approval.
                    </p>
                </div>

                <div id="promo-approval-queue" class="admin-card" style="border-color: var(--warning);">
                    <h3 style="color: var(--warning);"><i class="ri-alert-line"></i> <span id="promo-queue-title">Pending Promo Requests</span></h3>
                    <div class="table-responsive" style="margin-bottom: 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Discount</th>
                                    <th>Created By</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pending-promos-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-promos" placeholder="Search Code..." onkeyup="handleSearch('promos', this.value)">
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Discount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="promo-table-body">
                             <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading promos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CONTENT REQUESTS TAB (UPDATED) -->
            <div id="tab-content-requests" class="tab-content">
                <div class="section-header">
                    <h2>Content Requests</h2>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">Client change requests (Menu, Photos, Text)</div>
                </div>
                
                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-content-req" placeholder="Search Customer, Section..." onkeyup="handleSearch('content-requests', this.value)">
                </div>

                <div class="table-responsive" style="margin-bottom: 2rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Section</th>
                                <th>Details</th>
                                <th>Status</th>
                                <th>Price Quote</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="content-requests-table-body">
                            <!-- Populated by JS -->
                            <tr><td colspan="8" style="text-align:center; padding:2rem;">Loading requests...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SYSTEM LOGS TAB -->
            <div id="tab-logs" class="tab-content">
                <div class="section-header">
                    <h2>System Logs</h2>
                    <p style="font-size: 0.8rem; color: var(--text-secondary);">Audit trail of recent administrative actions.</p>
                </div>
                <div class="admin-card">
                    <div style="display: flex; gap: 10px; margin-bottom: 1rem; overflow-x: auto;">
                        <button id="btn-log-all" class="sm-btn secondary active" onclick="loadLogsTab('all')">All Activity</button>
                        <button id="btn-log-tickets" class="sm-btn secondary" onclick="loadLogsTab('tickets')">Tickets</button>
                        <button id="btn-log-vouchers" class="sm-btn secondary" onclick="loadLogsTab('vouchers')">Vouchers</button>
                    </div>
                </div>
                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-logs" placeholder="Search Admin, Action..." onkeyup="handleSearch('logs', this.value)">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Admin</th>
                                <th>Action Type</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Loading logs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MAINTENANCE TAB (Config) -->
            <div id="tab-maintenance" class="tab-content">
                <div class="section-header">
                    <h2>Site Configuration</h2>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-config" placeholder="Jump to section..." onkeyup="handleSearch('config', this.value)">
                </div>

                <!-- PLAN DISCOUNT CONFIG -->
                <div class="admin-card" id="config-discount">
                    <h3>Global Plan Discount</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Activate a discount badge displayed on main website pricing tables.</p>
                    
                    <div class="form-row">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <label>Enable Plan Discount</label>
                            <div style="width: 50px; height: 26px; background: #333; border-radius: 13px; position: relative; cursor: pointer;" onclick="toggleDiscountStatus()">
                                <div id="discount-toggle-circle" style="width: 20px; height: 20px; background: #555; border-radius: 50%; position: absolute; left: 3px; top: 3px; transition: 0.3s;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Discount Percentage (%)</label>
                        <input type="number" id="discount-value" placeholder="e.g. 20">
                    </div>
                    
                    <button onclick="saveDiscountConfig()" style="margin-top: 1rem;">Save Discount Config</button>
                </div>

                <div class="admin-card" id="config-maintenance">
                    <h3>Maintenance Mode</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Toggle warning banner on main site.</p>
                    <div class="form-row">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <label>Enable Maintenance</label>
                            <div style="width: 50px; height: 26px; background: #333; border-radius: 13px; position: relative; cursor: pointer;" onclick="toggleMaintenanceStatus()">
                                <div id="maintenance-toggle-circle" style="width: 20px; height: 20px; background: #555; border-radius: 50%; position: absolute; left: 3px; top: 3px; transition: 0.3s;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Banner Message</label>
                        <input type="text" id="maintenance-msg" placeholder="e.g. Site Down for update.">
                    </div>
                    
                    <button onclick="saveMaintenanceConfig()" style="margin-top: 1rem;">Save Config</button>
                </div>

                <div class="admin-card" id="config-pricing">
                    <h3>Dynamic Pricing</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Override base prices.</p>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>HTML Price (RM)</label>
                            <input type="number" id="price-html" placeholder="199">
                        </div>
                        <div>
                            <label>Frontend Price (RM)</label>
                            <input type="number" id="price-frontend" placeholder="599">
                        </div>
                        <div>
                            <label>AI Price (RM)</label>
                            <input type="number" id="price-ai" placeholder="999">
                        </div>
                    </div>
                    <button onclick="savePricingConfig()" style="margin-top: 1rem;">Update Prices</button>
                </div>

                <!-- PAYMENT METHODS CONFIG -->
                <div class="admin-card" id="config-payments">
                    <h3>Payment Gateways</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Manage available payment methods, links, and status.</p>
                    
                    <div style="background: var(--bg-input); padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; border: 1px dashed var(--border-color);">
                        <div style="font-weight: 700; margin-bottom: 15px; color: var(--text-main); display:flex; align-items:center; gap:8px;">
                            <i class="ri-add-circle-line" style="color:var(--accent-primary)"></i> Add New Gateway
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <input type="text" id="new-pay-name" placeholder="Display Name (e.g. GrabPay)" style="margin:0;">
                            <input type="text" id="new-pay-id" placeholder="Internal ID (e.g. grab)" style="margin:0;">
                        </div>
                        <input type="text" id="new-pay-url" placeholder="Redirect URL (https://...)" style="margin-bottom: 15px;">
                        <button class="success" onclick="addPaymentMethod()" style="width:100%; padding: 12px;">Add Method</button>
                    </div>
                    <div id="payment-methods-list"></div>
                </div>

            </div>

            <!-- CONTENT TAB -->
            <div id="tab-content" class="tab-content">
                <div class="section-header">
                    <h2>Package Details</h2>
                </div>

                <div class="search-container">
                    <i class="ri-search-line search-icon"></i>
                    <input type="text" id="search-content" placeholder="Jump to section..." onkeyup="handleSearch('content', this.value)">
                </div>

                <div class="admin-card" id="content-frontend">
                    <h3>Frontend Details</h3>
                    <p class="helper-text">One feature per line.</p>
                    <div class="form-row">
                        <label>Features List</label>
                        <textarea id="details-frontend" placeholder="e.g. Up to 5 Pages"></textarea>
                    </div>
                    <button onclick="saveContentConfig()" style="margin-top: 1rem;">Save Details</button>
                </div>

                <div class="admin-card" id="content-ai">
                    <h3>AI Powered Details</h3>
                    <p class="helper-text">One feature per line.</p>
                    <div class="form-row">
                        <label>Features List</label>
                        <textarea id="details-ai" placeholder="e.g. AI Chatbot"></textarea>
                    </div>
                    <button onclick="saveContentConfig()" style="margin-top: 1rem;">Save Details</button>
                </div>
            </div>

        </div>
    </div>

    <!-- EDIT USER MODAL (UPDATED) -->
    <div id="editUserModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('editUserModal')"><i class="ri-close-line"></i></div>
            <h3>Manage User</h3>
            <div id="edit-permission-warning" class="alert-box" style="display:none;"></div>
            <input type="hidden" id="edit-uid">
            
            <div class="form-row">
                <label>Employee ID</label>
                <input type="text" id="edit-emp-id" placeholder="e.g. 001">
            </div>
            <div class="form-row">
                <label>Full Name</label>
                <input type="text" id="edit-name" placeholder="John Doe">
            </div>
            
            <!-- COMPANY NAME FIELD -->
            <div class="form-row" id="edit-company-name-wrapper" style="display:none;">
                <label>Company Name</label>
                <input type="text" id="edit-company-name" placeholder="e.g. Acme Corp">
            </div>

            <div class="form-row">
                <label>Job Title</label>
                <input type="text" id="edit-jobtitle" placeholder="e.g. CEO">
                <span id="jobtitle-helper" style="font-size:0.7em; color:var(--accent-primary); display:none;">(SuperAdmin Only)</span>
            </div>
            <div class="form-row">
                <label>Phone Number</label>
                <input type="tel" id="edit-phone" placeholder="0123456789">
            </div>
            <div class="form-row">
                <label>Role</label>
                <select id="edit-role" style="width: 100%;">
                    <option value="user">Client / Customer</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                </select>
            </div>

            <!-- SUBSCRIPTION MANAGEMENT (NEW) -->
            <div id="edit-subscription-management" style="display:none; border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--accent-primary);">Subscription Settings</h4>
                
                <div class="form-row">
                    <label>Plan Type</label>
                    <select id="edit-plan-type">
                        <option value="frontend">Frontend Standard</option>
                        <option value="ai">AI Powered</option>
                        <option value="html">HTML Basic</option>
                    </select>
                </div>

                <div class="form-row">
                    <label>Expiry Date</label>
                    <input type="date" id="edit-expiry-date">
                    <p class="helper-text">Leave empty if inactive.</p>
                </div>
            </div>

            <!-- Website Link Management (For Clients) -->
            <div id="client-website-management" style="display:none; border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--accent-primary);">Internal Website Monitor</h4>
                
                <div class="form-row" id="input-link-row">
                    <label>Website URL</label>
                    <input type="url" id="edit-website-link" placeholder="https://client-website.com">
                    <p class="helper-text">For internal monitoring purposes.</p>
                </div>

                <div id="link-removal-status" style="display:none; margin-bottom: 1rem;">
                    <div style="padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; color: var(--warning); font-size: 0.85rem; display:flex; align-items:center; gap:8px;">
                        <i class="ri-alert-line"></i> Removal Requested
                    </div>
                </div>

                <div id="link-actions" style="display:flex; gap:10px;">
                    <button class="success sm-btn" onclick="saveUserLink()">Save Link</button>
                    <button id="btn-request-remove-link" class="warning sm-btn" onclick="requestLinkRemoval()">Request Remove</button>
                    <button id="btn-approve-remove-link" class="danger sm-btn" style="display:none;" onclick="approveLinkRemoval()">Approve Removal</button>
                </div>
            </div>

            <div id="edit-restriction-msg" style="display:none; color:var(--warning); font-size:0.8rem; margin-bottom:1rem;"></div>
            <div id="edit-user-actions" style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveUser()" style="background: var(--success);">Update User</button>
                <button class="secondary" onclick="closeModal('editUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- EDIT PAYMENT METHOD MODAL -->
    <div id="editPaymentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('editPaymentModal')"><i class="ri-close-line"></i></div>
            <h3>Edit Payment Gateway</h3>
            <input type="hidden" id="edit-pay-index">
            
            <div class="form-row">
                <label>Display Name</label>
                <input type="text" id="edit-pay-name" placeholder="e.g. GrabPay">
            </div>
            <div class="form-row">
                <label>Internal ID</label>
                <input type="text" id="edit-pay-id" placeholder="e.g. grab" readonly style="background:var(--bg-input); color:var(--text-tertiary); cursor:not-allowed;">
                <span style="font-size:0.7rem; color:var(--text-secondary); padding-top:14px;">(Cannot change ID)</span>
            </div>
            <div class="form-row">
                <label>Redirect URL</label>
                <input type="text" id="edit-pay-url" placeholder="https://...">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="updatePaymentMethod()" style="background: var(--success); flex: 1;">Update Gateway</button>
                <button class="secondary" onclick="closeModal('editPaymentModal')" style="width: auto;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MANAGE VOUCHER MODAL (UPDATED WITH EXPIRY & REDEEMED LOGIC) -->
    <div id="manageVoucherModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('manageVoucherModal')"><i class="ri-close-line"></i></div>
            <h3>Manage Voucher</h3>
            <input type="hidden" id="manage-voucher-uid">
            
            <div class="form-row">
                <label>Code</label>
                <input type="text" id="manage-voucher-code" readonly style="background:var(--bg-input); color:var(--text-muted);">
            </div>
            
            <div class="form-row">
                <label>Current Value</label>
                <div id="manage-voucher-value-display" style="font-weight:700; color:var(--text-main); margin-top:10px;"></div>
            </div>

            <!-- WARNING BOX FOR EXPIRED VOUCHERS -->
            <div id="voucher-expired-warning" class="alert-box" style="display:none; border-color:var(--warning); background:rgba(245, 158, 11, 0.05);">
                <i class="ri-time-line" style="color:var(--warning); margin-right:5px;"></i> 
                <span style="color:var(--warning); font-weight:600;">This voucher is expired.</span>
            </div>

            <div class="form-row" style="border-top:1px solid var(--border-color); padding-top:1rem;">
                <label>Status</label>
                <select id="manage-voucher-status" style="width: 100%;">
                    <option value="active">Active</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>

            <!-- NEW: REDEEMED CHECKBOX -->
            <div class="form-row">
                <label>Mark as Redeemed</label>
                <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                    <input type="checkbox" id="manage-voucher-redeemed" style="width:auto; margin:0;">
                    <span style="font-size:0.9rem; color:var(--text-secondary);">Check to mark as used</span>
                </div>
            </div>

            <!-- NEW: EXPIRY DATE EDITOR -->
            <div class="form-row">
                <label>Expiry Date</label>
                <input type="date" id="manage-voucher-expiry">
                <p class="helper-text">Set date to extend. Leave empty to remove expiry.</p>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveManagedVoucher()" style="background: var(--success); flex: 1;">Save Changes</button>
                <button class="secondary" onclick="closeModal('manageVoucherModal')" style="width: auto;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CREATE TASK MODAL -->
    <div id="createTaskModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('createTaskModal')"><i class="ri-close-line"></i></div>
            <h3>Assign New Task</h3>
            <div class="form-row">
                <label>Assign To (Admin)</label>
                <select id="task-assignee-select"></select>
            </div>
            <div class="form-row">
                <label>Task Title</label>
                <input type="text" id="task-title-input" placeholder="e.g. Update Client X">
            </div>
            <div class="form-row">
                <label>Description</label>
                <textarea id="task-desc-input" placeholder="Detailed instructions..."></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="createTask()" style="background: var(--success);">Assign Task</button>
                <button class="secondary" onclick="closeModal('createTaskModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- INTERNAL TICKET MODAL -->
    <div id="internalTicketModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('internalTicketModal')"><i class="ri-close-line"></i></div>
            <h3>Create Internal Ticket</h3>
            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>Type</label>
                    <select id="ticket-type" style="width: 100%;">
                        <option value="Internal Bug">Internal Bug</option>
                        <option value="Feature Request">Feature Request</option>
                        <option value="System Error">System Error</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label>Target User (Optional)</label>
                    <select id="ticket-target-user-select" style="width: 100%;">
                        <option value="">General (Myself)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div>
                    <label>Message</label>
                    <textarea id="ticket-message" placeholder="Describe issue or task..." required></textarea>
                </div>
                <div>
                    <label>Target User Name</label>
                    <input type="text" id="ticket-target-user-name" placeholder="Auto-filled if user selected" readonly style="background: rgba(0,0,0,0.1);">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="submitInternalTicket()" style="background: var(--success);">Create Ticket</button>
                <button class="secondary" onclick="closeModal('internalTicketModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- TICKET MODAL -->
    <div id="ticketModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('ticketModal')"><i class="ri-close-line"></i></div>
            <h3>Manage Ticket</h3>
            <input type="hidden" id="ticket-id">
            <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">Case ID</div>
                <div id="view-ticket-id" style="font-family: monospace; font-weight: 700; color: var(--accent-primary); margin-bottom: 8px;">-</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">Customer</div>
                <div id="view-ticket-customer" style="font-weight: 600; margin-bottom: 8px;">-</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px;">Message</div>
                <div id="view-ticket-message" style="font-size: 0.9rem; margin-bottom: 8px;">-</div>
                <div id="view-resolved-by-container" style="display: none; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px;">
                    <div style="font-size: 0.8rem; color: var(--success); margin-bottom: 4px;">Resolved By</div>
                    <div id="view-ticket-resolved-by" style="font-weight: 600;">-</div>
                    <div id="view-ticket-resolved-at" style="font-size: 0.75rem; color: var(--text-secondary);">-</div>
                </div>
            </div>
            <div class="form-row">
                <label>Status</label>
                <select id="ticket-status-select" style="width: 100%;">
                    <option value="Open">Open</option>
                    <option value="Resolved">Resolved</option>
                </select>
            </div>
            <!-- Assign To -->
            <div class="form-row">
                <label>Assign To (Employee)</label>
                <select id="ticket-assignee-select" style="width: 100%;">
                    <option value="">Unassigned</option>
                </select>
            </div>
            <div class="form-row">
                <label>Admin Note</label>
                <textarea id="ticket-admin-note"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveTicket()" style="background: var(--success);">Update Ticket</button>
                <button class="secondary" onclick="closeModal('ticketModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ORDER MODAL (UPDATED FOR RENEWAL & VOUCHER TYPE) -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('orderModal')"><i class="ri-close-line"></i></div>
            <h3>Manage Order</h3>
            <input type="hidden" id="order-id">
            
            <div class="form-row">
                <label>Company Name</label>
                <input type="text" id="order-company-name">
            </div>
            <div class="form-row">
                <label>Package</label>
                <input type="text" id="order-package">
            </div>
            <div class="form-row">
                <label>Total (RM)</label>
                <input type="text" id="order-total">
            </div>
            <div class="form-row">
                <label>Voucher Used</label>
                <input type="text" id="order-voucher" readonly style="background:var(--bg-input); color:var(--text-muted);">
                <!-- VOUCHER TYPE BADGE DISPLAY IN MODAL -->
                <div id="order-voucher-type-badge" style="margin-top: 5px; font-size: 0.8rem;"></div>
            </div>
            
            <div class="form-row">
                <label>Status</label>
                <select id="order-status-select">
                    <option value="Pending">Pending</option>
                    <option value="Paid">Paid</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>

            <div class="form-row">
                <label>Admin Note</label>
                <textarea id="order-admin-note" placeholder="Internal notes..."></textarea>
            </div>
            
            <div id="renewal-alert" style="background: rgba(16, 185, 129, 0.1); border:1px solid rgba(16, 185, 129, 0.3); padding:10px; border-radius:8px; margin-bottom:1rem; display:none;">
                <div style="font-size:0.85rem; color:var(--success); font-weight:700;"><i class="ri-refresh-line"></i> Auto-Renewal</div>
                <div style="font-size:0.8rem;">Setting status to Paid will renew client's subscription.</div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="saveOrder()" style="background: var(--success); flex: 1;">Save Order</button>
                <button class="secondary" onclick="closeModal('orderModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CREATE USER MODAL -->
    <div id="createUserModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="closeModal('createUserModal')"><i class="ri-close-line"></i></div>
            <h3>Create New User</h3>
            <div class="form-row">
                <label>Employee ID</label>
                <input type="text" id="create-emp-id" placeholder="e.g. 001" required onblur="checkEmpIdUnique(this.value)">
                <p id="emp-id-error" style="color:var(--danger); font-size:0.75rem; display:none; margin-top:-0.5rem;">ID already exists.</p>
            </div>
            <div class="form-row">
                <label>Full Name</label>
                <input type="text" id="create-name" placeholder="John Doe">
            </div>
            
            <!-- COMPANY NAME INPUT -->
            <div class="form-row" id="create-company-name-wrapper" style="display:none;">
                <label>Company Name</label>
                <input type="text" id="create-company-name" placeholder="e.g. Acme Corp">
            </div>

            <div class="form-row">
                <label>Email Address</label>
                <input type="email" id="create-email" placeholder="user@example.com">
            </div>
            <div class="form-row">
                <label>Initial Password</label>
                <input type="password" id="create-password" placeholder="At least 6 characters">
            </div>
            <div class="form-row">
                <label>Phone Number</label>
                <input type="tel" id="create-phone" placeholder="0123456789">
            </div>
            <div class="form-row">
                <label>Assign Role</label>
                <select id="create-role" style="width: 100%;" onchange="toggleCompanyField()">
                    <option value="user">Client / Customer</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Super Admin</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 1.5rem;">
                <button onclick="createNewUser()" style="background: var(--success);">Create User</button>
                <button class="secondary" onclick="closeModal('createUserModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
            authDomain: "ddnetwork-database.firebaseapp.com",
            projectId: "ddnetwork-database",
            storageBucket: "ddnetwork-database.firebasestorage.app",
            messagingSenderId: "699127560990",
            appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
        };

        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'ri-information-line';
            if (type === 'success') icon = 'ri-checkbox-circle-line';
            if (type === 'error') icon = 'ri-error-warning-line';

            toast.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.4s ease forwards';
                setTimeout(() => toast.remove(), 400);
            }, 4000); 
        }

        // --- THEME MANAGEMENT ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icons = document.querySelectorAll('#theme-icon-mobile, #theme-icon-login');
            icons.forEach(icon => {
                icon.className = theme === 'dark' ? 'ri-moon-line' : 'ri-sun-line';
            });
        }
        initTheme();

        // --- FIREBASE & APP LOGIC ---
        let db, auth;
        let ticketFilter = 'all';
        let ticketCache = []; 
        let orderCache = []; 
        let promoCache = []; 
        let taskCache = [];
        let contentReqCache = []; 
        let currentAdminUID = ""; 
        let isSuperAdmin = false; 
        let currentAdminEmail = "";
        let currentLogFilter = 'all'; 
        let currentPaymentEditIndex = -1; 
        let currentManageVoucherUID = null; // Tracks which user's voucher is being edited

        let searchStates = {
            dashboard: "", orders: "", users: "", support: "", vouchers: "", promos: "", logs: "", config: "", content: "", tasks: "", "content-requests": ""
        };

        const dataLoaded = {
            orders: false, users: false, tickets: false, promos: false, logs: false, tasks: false, contentReqs: false
        };

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch(e) {
            console.error("Firebase Error", e);
            showToast("Error connecting to database", "error");
        }

        let allUsers = []; 
        let siteConfig = { 
            maintenance_active: false, 
            message: '', 
            prices: { html: 199, frontend: 599, ai: 999 }, 
            packageDetails: {},
            discountActive: false, 
            discountPercent: 0,
            payment_methods: [] 
        };

        const DEFAULT_DETAILS = {
            frontend: ["Up to 5 Pages", "Animations", "Contact Forms"],
            ai: ["All Frontend Features", "AI Chatbot", "Analytics"]
        };

        const DEFAULT_PAYMENT_METHODS = [
            { id: 'tng', name: 'TNG eWallet', url: 'https://payment.tngdigital.com.my/sc/bDLob7YcpG', active: true },
            { id: 'fpx', name: 'Online Banking (FPX)', url: 'https://toyyibpay.com', active: true } 
        ];
        // AUTH LOGIC
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentAdminUID = user.uid;
                currentAdminEmail = user.email;
                
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const role = data.role || 'user';

                        if (role === 'admin' || role === 'superadmin') {
                            document.getElementById('login-screen').style.display = 'none';
                            document.getElementById('dashboard').style.display = 'flex';
                            
                            isSuperAdmin = (role === 'superadmin');

                            loadDashboardData();
                            loadSidebarProfile(); 
                            adjustUIForSuperAdmin();
                        } else {
                            auth.signOut();
                            showToast("ACCESS DENIED", "error");
                            document.getElementById('login-screen').style.display = 'flex';
                            document.getElementById('dashboard').style.display = 'none';
                        }
                    }
                }).catch((err) => {
                    showToast("Error verifying permissions.", "error");
                });
            } else {
                currentAdminUID = "";
                isSuperAdmin = false;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        async function handleAdminLogin(e) {
            e.preventDefault();
            const input = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;
            let emailToUse = input;

            if (!input.includes('@')) {
                try {
                    const snapshot = await db.collection('users').where('employeeId', '==', input).limit(1).get();
                    if (snapshot.empty) {
                        showToast("Employee ID not found.", "error");
                        return;
                    }
                    const userDoc = snapshot.docs[0];
                    emailToUse = userDoc.data().email;
                } catch (error) {
                    console.error("Error finding ID:", error);
                    showToast("Error verifying ID.", "error");
                    return;
                }
            }

            auth.signInWithEmailAndPassword(emailToUse, password)
                .then(() => {
                    document.getElementById('login-error').style.display = 'none';
                })
                .catch((error) => {
                    const errBox = document.getElementById('login-error');
                    errBox.innerText = error.message;
                    errBox.style.display = 'block';
                });
        }

        function adjustUIForSuperAdmin() {
            const planDiscountCard = document.getElementById('config-discount');
            const logsTab = document.getElementById('tab-logs');
            const logsNav = document.getElementById('nav-logs');
            const taskCreateBtn = document.getElementById('task-create-btn-container');
            const voucherQueueTitle = document.getElementById('voucher-queue-title');
            const promoQueueTitle = document.getElementById('promo-queue-title');
            const helperVoucher = document.getElementById('voucher-helper-text');
            const helperPromo = document.getElementById('promo-helper-text');

            if(isSuperAdmin) {
                if(planDiscountCard) planDiscountCard.style.display = 'block';
                if(logsNav) logsNav.style.display = 'flex';
                if(taskCreateBtn) taskCreateBtn.style.display = 'block';
                
                if(voucherQueueTitle) voucherQueueTitle.innerText = "Pending Voucher Approvals";
                if(promoQueueTitle) promoQueueTitle.innerText = "Pending Promo Approvals";
                
                if(helperVoucher) helperVoucher.style.display = 'none';
                if(helperPromo) helperPromo.style.display = 'none';

            } else {
                if(planDiscountCard) planDiscountCard.style.display = 'none';
                if(logsTab) logsTab.style.display = 'none';
                if(logsNav) logsNav.style.display = 'none';
                if(taskCreateBtn) taskCreateBtn.style.display = 'none';

                if(voucherQueueTitle) voucherQueueTitle.innerText = "My Pending Voucher Requests";
                if(promoQueueTitle) promoQueueTitle.innerText = "My Pending Promo Requests";

                if(helperVoucher) helperVoucher.style.display = 'block';
                if(helperPromo) helperPromo.style.display = 'block';
            }
            
            renderVoucherTable();
            renderPromoTable();
        }

        function loadSidebarProfile() {
            if(currentAdminUID) {
                db.collection("users").doc(currentAdminUID).onSnapshot((doc) => {
                    if(doc.exists) {
                        const data = doc.data();
                        const name = data.name || "DDN Admin";
                        let title = data.jobTitle;
                        if(!title) title = (data.role === 'superadmin') ? 'Super Admin' : (data.role === 'admin' ? 'Admin' : 'Client');

                        // UPDATES IDs IN HTML
                        document.getElementById('sidebar-name').innerText = name;
                        document.getElementById('sidebar-jobtitle').innerText = title;
                        document.getElementById('mobile-name').innerText = name;
                        document.getElementById('mobile-jobtitle').innerText = title;
                    }
                });
            }
        }

        function handleLogout() {
            if(confirm("Logout?")) auth.signOut();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // --- SEARCH ---
        function handleSearch(tab, value) {
            searchStates[tab] = value.toLowerCase();
            if (tab === 'orders') renderOrdersTable();
            if (tab === 'users') renderSplitUserTables();
            if (tab === 'support') renderTicketsTable();
            if (tab === 'vouchers') renderVoucherTable();
            if (tab === 'promos') renderPromoTable();
            if (tab === 'logs') renderLogsTable();
            if (tab === 'config') scrollToSection('config', value);
            if (tab === 'content') scrollToSection('content', value);
            if (tab === 'tasks') renderTasks();
            if (tab === 'content-requests') renderContentRequestsTable();
        }

        function scrollToSection(context, text) {
            const textLower = text.toLowerCase();
            if (!textLower) return;
            const sections = [];
            if (context === 'config') {
                sections.push({ id: 'config-discount', keywords: ['discount', 'sale', 'promo', 'badge'] });
                sections.push({ id: 'config-maintenance', keywords: ['maintenance', 'banner', 'mode'] });
                sections.push({ id: 'config-pricing', keywords: ['pricing', 'price', 'html', 'frontend'] });
                sections.push({ id: 'config-payments', keywords: ['payment', 'gateway', 'banking', 'tng'] });
            } else if (context === 'content') {
                sections.push({ id: 'content-frontend', keywords: ['frontend', 'features', 'standard'] });
                sections.push({ id: 'content-ai', keywords: ['ai', 'artificial', 'intelligence', 'chatbot'] });
            }
            for (let sec of sections) {
                if (sec.keywords.some(k => textLower.includes(k))) {
                    const el = document.getElementById(sec.id);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        break;
                    }
                }
            }
        }

        function formatDateTime(timestamp) {
            if(!timestamp) return '-';
            const date = timestamp.toDate();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() +1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // --- DATA LOADING ---
        function loadDashboardData() {
            db.collection("config").doc("site_settings").onSnapshot(doc => {
                if(doc.exists) {
                    siteConfig = doc.data();
                    updateMaintenanceUI();
                    updateDiscountUI(); 
                    updatePricingUI();
                    updateContentUI();
                    updatePaymentMethodsUI(); 
                }
            });

            db.collection("orders").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                orderCache = []; 
                snapshot.forEach(doc => orderCache.push({ id: doc.id, data: doc.data() }));
                dataLoaded.orders = true;
                renderOrdersTable();
                updateDashboardStats();
            });

            db.collection("users").onSnapshot((snapshot) => {
                const select = document.getElementById('voucher-user-select');
                const adminSelect = document.getElementById('task-assignee-select');
                const ticketAssignSelect = document.getElementById('ticket-assignee-select');
                
                allUsers = []; 
                let optionsHTML = '<option value="" disabled selected>Select a User</option>';
                let adminOptionsHTML = '<option value="" disabled selected>Select an Admin</option>';
                let employeeOptionsHTML = '<option value="">Unassigned</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allUsers.push({ id: doc.id, ...data });
                    optionsHTML += `<option value="${doc.id}">${data.name} (${data.email})</option>`;
                    
                    if(data.role === 'admin') {
                        adminOptionsHTML += `<option value="${doc.id}">${data.name} (Admin)</option>`;
                        employeeOptionsHTML += `<option value="${doc.id}">${data.name} (Admin)</option>`;
                    } else if (data.role === 'superadmin') {
                         employeeOptionsHTML += `<option value="${doc.id}">${data.name} (SuperAdmin)</option>`;
                    }
                });
                select.innerHTML = optionsHTML;
                if(adminSelect) adminSelect.innerHTML = adminOptionsHTML;
                if(ticketAssignSelect) ticketAssignSelect.innerHTML = employeeOptionsHTML;

                dataLoaded.users = true;
                renderSplitUserTables();
                refreshVoucherTable();
                updateDashboardStats();
            });

            db.collection("tickets").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                ticketCache = []; 
                snapshot.forEach(doc => ticketCache.push({ id: doc.id, data: doc.data() }));
                dataLoaded.tickets = true;
                renderTicketsTable();
                updateDashboardStats();
                if(currentLogFilter && document.getElementById('tab-logs').classList.contains('active')) {
                    renderLogsTable();
                }
            });

            db.collection("promo_codes").onSnapshot((snapshot) => {
                promoCache = [];
                snapshot.forEach(doc => promoCache.push({ id: doc.id, data: doc.data() }));
                dataLoaded.promos = true;
                renderPromoTable();
            });

            // CONTENT REQUESTS Listener
            db.collection("content_requests").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                contentReqCache = [];
                snapshot.forEach(doc => contentReqCache.push({ id: doc.id, data: doc.data() }));
                dataLoaded.contentReqs = true;
                renderContentRequestsTable();
            });

            // TASKS COLLECTION
            db.collection("admin_tasks").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
                taskCache = [];
                snapshot.forEach(doc => taskCache.push({ id: doc.id, data: doc.data() }));
                dataLoaded.tasks = true;
                renderTasks();
            });
        }

        // --- TASKS LOGIC (UPDATED) ---
        function openCreateTaskModal() {
            const modal = document.getElementById('createTaskModal');
            document.getElementById('task-title-input').value = '';
            document.getElementById('task-desc-input').value = '';
            modal.classList.add('open');
        }

        function createTask() {
            const assigneeId = document.getElementById('task-assignee-select').value;
            const title = document.getElementById('task-title-input').value;
            const desc = document.getElementById('task-desc-input').value;

            if(!assigneeId || !title || !desc) return showToast("Please fill all fields", "error");

            const taskData = {
                assignedTo: assigneeId,
                assignedBy: currentAdminUID,
                assignedByName: currentAdminEmail, 
                title: title,
                description: desc,
                status: 'pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("admin_tasks").add(taskData).then(() => {
                closeModal('createTaskModal');
                showToast("Task Assigned!", "success");
            }).catch(err => showToast(err.message, "error"));
        }

        function renderTasks() {
            const container = document.getElementById('tasks-list-container');
            const reassignQueue = document.getElementById('task-reassign-queue');
            const reassignList = document.getElementById('reassign-list-container');
            
            container.innerHTML = '';
            reassignList.innerHTML = '';
            reassignQueue.style.display = 'none';

            let visibleTasks = taskCache;
            const s = searchStates.tasks;
            if(s) {
                visibleTasks = visibleTasks.filter(t => {
                    const d = t.data;
                    return d.title.toLowerCase().includes(s) || d.description.toLowerCase().includes(s);
                });
            }

            let reassignTasks = [];
            
            if(!isSuperAdmin) {
                visibleTasks = visibleTasks.filter(t => t.data.assignedTo === currentAdminUID);
            } else {
                reassignTasks = visibleTasks.filter(t => t.data.requestedReassignTo);
                if(reassignTasks.length > 0) {
                    reassignQueue.style.display = 'block';
                    reassignTasks.forEach(t => {
                        const assignee = allUsers.find(u => u.id === t.data.assignedTo)?.name || "Unknown";
                        const requestedBy = allUsers.find(u => u.id === t.data.requestReassignBy)?.name || "Unknown";
                        const requestedTo = allUsers.find(u => u.id === t.data.requestedReassignTo)?.name || "Unknown";

                        reassignList.innerHTML += `
                        <div style="padding:10px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:600;">${t.data.title}</div>
                                <div style="font-size:0.8rem; color:var(--text-secondary);">From: ${assignee} &rarr; To: ${requestedTo} (Req by ${requestedBy})</div>
                            </div>
                            <button class="action-btn success" style="color:white; border:none;" onclick="approveTaskReassign('${t.id}')">Approve</button>
                        </div>`;
                    });
                }
            }

            if(visibleTasks.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-secondary);">No tasks found.</div>';
                return;
            }

            visibleTasks.forEach(task => {
                const d = task.data;
                let statusColor = 'var(--warning)';
                if(d.status === 'completed') statusColor = 'var(--success)';
                if(d.status === 'in_progress') statusColor = 'var(--accent-primary)';

                let assigneeName = "Me";
                let assignedByName = "";
                if(isSuperAdmin) {
                    const u = allUsers.find(u => u.id === d.assignedTo);
                    assigneeName = u ? u.name : "Unknown Admin";
                    if(d.assignedBy) {
                        const a = allUsers.find(u => u.id === d.assignedBy);
                        assignedByName = a ? a.name : "Unknown";
                    }
                } else {
                    if(d.assignedBy) {
                        const a = allUsers.find(u => u.id === d.assignedBy);
                        assignedByName = a ? a.name : "SuperAdmin";
                    }
                }

                let actionBtn = '';
                let reassignBtn = '';

                if(!isSuperAdmin) {
                    if(d.status === 'pending') {
                        actionBtn = `<button class="action-btn" onclick="updateTaskStatus('${task.id}', 'in_progress')">Start</button>`;
                    } else if(d.status === 'in_progress') {
                        actionBtn = `<button class="action-btn success" style="color:white; border:none;" onclick="updateTaskStatus('${task.id}', 'completed')">Complete</button>`;
                    }
                    
                    if(d.status !== 'completed' && !d.requestedReassignTo) {
                        reassignBtn = `<button class="action-btn warning" style="color:black; margin-left:5px;" onclick="openReassignModal('${task.id}')">Reassign</button>`;
                    }
                } else {
                    actionBtn = `<button class="action-btn danger" style="white;" onclick="deleteTask('${task.id}')">Delete</button>`;
                }

                const assignedByHtml = assignedByName ? `<div style="font-size:0.75rem; color:var(--text-secondary); margin-top:4px;">Assigned by: ${assignedByName}</div>` : '';

                const card = `
                <div class="admin-card" style="padding: 1.5rem; border-left:4px solid ${statusColor}; position:relative;">
                    ${d.requestedReassignTo ? '<div style="position:absolute; top:10px; right:10px; background:var(--warning); color:black; font-size:0.6rem; padding:2px 6px; border-radius:4px;">REASSIGN PENDING</div>' : ''}
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <h4 style="margin:0; font-size:1.1rem;">${d.title}</h4>
                        <span class="status-badge" style="background:${statusColor}20; color:${statusColor};">${d.status.toUpperCase().replace('_', ' ')}</span>
                    </div>
                    <p style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:1rem; line-height:1.5;">${d.description}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                        <div style="font-size:0.8rem; color:var(--text-secondary);">
                            Assigned to: <b>${assigneeName}</b> &bull; ${formatDateTime(d.timestamp)}
                            ${assignedByHtml}
                        </div>
                        <div>${actionBtn} ${reassignBtn}</div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        function updateTaskStatus(taskId, newStatus) {
            db.collection("admin_tasks").doc(taskId).update({ status: newStatus }).then(() => {
                showToast("Task updated", "success");
            }).catch(err => showToast(err.message, "error"));
        }

        function deleteTask(taskId) {
            if(confirm("Delete this task?")) {
                db.collection("admin_tasks").doc(taskId).delete();
            }
        }

        // Task Reassignment Logic
        let currentReassignTaskId = null;
        
        function openReassignModal(taskId) {
            currentReassignTaskId = taskId;
            const task = taskCache.find(t => t.id === taskId);
            if(!task) return;
            
            buildReassignModal(taskId);
        }
        
        function buildReassignModal(taskId) {
            const old = document.getElementById('dynamic-reassign-modal');
            if(old) old.remove();
            
            const modalHtml = `
            <div id="dynamic-reassign-modal" class="modal-overlay open" style="z-index:1001;">
                <div class="modal-content" style="max-width:400px;">
                    <div class="modal-close-btn" onclick="this.parentElement.parentElement.remove()"><i class="ri-close-line"></i></div>
                    <h3>Reassign Task</h3>
                    <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:1rem;">SuperAdmin approval required.</p>
                    <label>Select New Admin</label>
                    <select id="reassign-target-select" style="width:100%; margin-bottom:1rem;">
                        <option value="" disabled selected>Select...</option>
                    </select>
                    <div style="display:flex; gap:10px;">
                        <button class="success" onclick="confirmReassign('${taskId}')" style="flex:1;">Request Reassign</button>
                        <button class="secondary" onclick="document.getElementById('dynamic-reassign-modal').remove()">Cancel</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const select = document.getElementById('reassign-target-select');
            allUsers.forEach(u => {
                if(u.role === 'admin' && u.id !== currentAdminUID) {
                    select.innerHTML += `<option value="${u.id}">${u.name}</option>`;
                }
            });
        }
        
        function confirmReassign(taskId) {
            const targetId = document.getElementById('reassign-target-select').value;
            if(!targetId) return showToast("Please select an admin", "error");
            
            db.collection("admin_tasks").doc(taskId).update({
                requestedReassignTo: targetId,
                requestReassignBy: currentAdminUID,
                requestReassignTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('dynamic-reassign-modal').remove();
                showToast("Reassignment requested", "success");
            });
        }
        
        function approveTaskReassign(taskId) {
            const task = taskCache.find(t => t.id === taskId);
            if(!task || !task.data.requestedReassignTo) return;
            
            db.collection("admin_tasks").doc(taskId).update({
                assignedTo: task.data.requestedReassignTo,
                requestedReassignTo: firebase.firestore.FieldValue.delete(),
                requestReassignBy: firebase.firestore.FieldValue.delete(),
                requestReassignTimestamp: firebase.firestore.FieldValue.delete(),
                status: 'pending'
            }).then(() => {
                showToast("Task reassigned", "success");
            });
        }

        // --- DASHBOARD STATS ---
        function updateDashboardStats() {
            const pendingTickets = ticketCache.filter(t => t.data.status === 'Open').length;
            const pendingOrders = orderCache.filter(o => o.data.status === 'Pending').length;
            const totalClients = allUsers.filter(u => u.role === 'user').length;
            const totalAdmins = allUsers.filter(u => u.role === 'admin' || u.role === 'superadmin').length;

            document.getElementById('stat-pending-tickets').innerText = pendingTickets;
            document.getElementById('stat-pending-orders').innerText = pendingOrders;
            document.getElementById('stat-total-clients').innerText = totalClients;
            document.getElementById('stat-total-admins').innerText = totalAdmins;

            const logsList = document.getElementById('dashboard-logs-list');
            logsList.innerHTML = '';
            let logs = [];
            ticketCache.slice(0, 5).forEach(t => logs.push({ time: formatDateTime(t.data.timestamp), icon: t.data.source === 'internal' ? 'ri-bug-line' : 'ri-user-voice-line', text: `New Ticket: ${t.data.type}`, detail: t.data.name }));
            orderCache.slice(0, 3).forEach(o => logs.push({ time: formatDateTime(o.data.timestamp), icon: 'ri-shopping-bag-3-line', text: `New Order: ${o.data.package}`, detail: o.data.customerName }));
            taskCache.slice(0, 3).forEach(t => logs.push({ time: formatDateTime(t.data.timestamp), icon: 'ri-task-line', text: `Task Assigned: ${t.data.title}`, detail: isSuperAdmin ? t.data.assignedByName : 'Me' }));

            logs.sort((a,b) => new Date(b.time) - new Date(a.time)); 
            logs.slice(0, 5).forEach(log => {
                logsList.innerHTML += `
                    <div style="display:flex; gap:12px; align-items:center; padding-bottom:12px; border-bottom:1px solid var(--border-color);">
                        <div style="background:var(--bg-input); padding:10px; border-radius:10px; color:var(--accent-primary);"><i class="${log.icon}"></i></div>
                        <div style="flex:1;">
                            <div style="font-size:0.9rem; font-weight:600;">${log.text}</div>
                            <div style="font-size:0.75rem; color:var(--text-secondary);">${log.detail} &bull; <span style="font-family:monospace;">${log.time}</span></div>
                        </div>
                    </div>`;
            });
        }

        // --- ORDERS (UPDATED WITH RENEWAL LOGIC & VOUCHER SOURCE TYPE) ---
        function renderOrdersTable() {
            const tbody = document.getElementById('orders-table-body');
            if (!dataLoaded.orders) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="loader-container"><div class="loader"></div></div></td></tr>`;
                return;
            }
            tbody.innerHTML = '';
            let visibleOrders = orderCache;
            const s = searchStates.orders;
            if(s) {
                visibleOrders = visibleOrders.filter(o => {
                    const d = o.data;
                    const str = `${d.customerName} ${d.customerEmail} ${d.companyName || ''} ${o.id}`.toLowerCase();
                    return str.includes(s);
                });
            }
            if(visibleOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem;">No orders found.</td></tr>';
                return;
            }
            visibleOrders.forEach(doc => {
                const data = doc.data;
                const date = formatDateTime(data.timestamp);
                let statusClass = 'status-pending';
                if(data.status === 'Paid' || data.status === 'Completed') statusClass = 'status-paid status-completed';
                if(data.status === 'Cancelled') statusClass = 'status-cancelled';
                
                // Voucher Source Logic (Check if Assigned vs Global)
                let voucherDisplay = '-';
                if(data.voucherCode) {
                    // Find user to check if they have a matching personal voucher
                    const orderUser = allUsers.find(u => u.email === data.customerEmail);
                    let voucherType = 'Global'; // Default
                    
                    if (orderUser && orderUser.personalVoucher && orderUser.personalVoucher.code === data.voucherCode) {
                        voucherType = 'Assigned'; // User used their assigned voucher
                    }

                    // Style based on type
                    const typeIcon = voucherType === 'Assigned' ? 'ri-user-gift-line' : 'ri-global-line';
                    const typeColor = voucherType === 'Assigned' ? 'var(--accent-primary)' : 'var(--warning)';
                    const typeBg = voucherType === 'Assigned' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(245, 158, 11, 0.15)';
                    
                    voucherDisplay = `
                        <div style="display:flex; align-items:center; gap:4px;">
                            <span style="font-weight:600; color:var(--success);"><i class="ri-ticket-2-line"></i> ${data.voucherCode}</span>
                            <span class="source-badge" style="background:${typeBg}; color:${typeColor}; border-color:${typeColor}40;">
                                ${typeIcon} ${voucherType}
                            </span>
                        </div>
                    `;
                }

                // Delete Button (SuperAdmin Only)
                let deleteBtn = '';
                if(isSuperAdmin) {
                    deleteBtn = `<button class="action-btn danger" style="color:white; margin-left:5px;" onclick="deleteOrder('${doc.id}')"><i class="ri-delete-bin-line"></i></button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td style="color:var(--text-secondary); font-size:0.9rem;">${date}</td>
                        <td><div style="font-weight:600;">${data.customerName}</div><div style="font-size:0.8rem; color:var(--text-secondary);">${data.customerEmail}</div></td>
                        <td style="color:var(--text-secondary); font-size:0.85rem;">${data.companyName || '-'}</td>
                        <td>${data.package || '-'}</td>
                        <td>${voucherDisplay}</td>
                        <td style="font-weight:700;">${data.total || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        <td>
                            <button class="action-btn" onclick="openOrderModal('${doc.id}')">Manage</button>
                            ${deleteBtn}
                        </td>
                    </tr>`;
            });
        }

        function openOrderModal(orderId) {
            const orderObj = orderCache.find(o => o.id === orderId);
            if(!orderObj) return;
            const data = orderObj.data;

            document.getElementById('order-id').value = orderId;
            document.getElementById('order-status-select').value = data.status || 'Pending';
            document.getElementById('order-admin-note').value = data.adminNote || '';
            document.getElementById('order-company-name').value = data.companyName || ''; 
            document.getElementById('order-package').value = data.package || ''; 
            document.getElementById('order-total').value = data.total || ''; 
            document.getElementById('order-voucher').value = data.voucherCode || '-'; 

            // Show Voucher Source Type in Modal
            const badgeContainer = document.getElementById('order-voucher-type-badge');
            if(data.voucherCode) {
                const orderUser = allUsers.find(u => u.email === data.customerEmail);
                let voucherType = 'Global';
                if (orderUser && orderUser.personalVoucher && orderUser.personalVoucher.code === data.voucherCode) {
                    voucherType = 'Assigned';
                }
                badgeContainer.innerHTML = `<span style="background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; font-size:0.75rem;">Source: ${voucherType}</span>`;
            } else {
                badgeContainer.innerHTML = '';
            }
            
            const renewalAlert = document.getElementById('renewal-alert');
            renewalAlert.style.display = 'none';
            document.getElementById('orderModal').classList.add('open');
        }

        function saveOrder() {
            const id = document.getElementById('order-id').value;
            const status = document.getElementById('order-status-select').value;
            const note = document.getElementById('order-admin-note').value;
            const companyName = document.getElementById('order-company-name').value; 
            const pkg = document.getElementById('order-package').value;
            const total = document.getElementById('order-total').value;

            // RENEWAL LOGIC
            const orderObj = orderCache.find(o => o.id === id);
            const oldStatus = orderObj ? orderObj.data.status : '';

            let renewalPromise = Promise.resolve();

            if (status === 'Paid' && oldStatus !== 'Paid') {
                // Auto Renew Logic
                if(confirm("Mark as Paid? This will renew client's subscription.")) {
                    renewalPromise = autoRenewSubscription(orderObj.data.customerEmail, pkg);
                } else {
                    return; // Cancel save if they deny renewal
                }
            }

            db.collection("orders").doc(id).update({ 
                status: status, 
                adminNote: note,
                companyName: companyName,
                package: pkg,
                total: total
            }).then(() => { 
                closeModal('orderModal'); 
                showToast("Order updated", "success"); 
            }).catch(err => showToast(err.message, "error"));
        }

        function deleteOrder(orderId) {
            if(confirm("Are you sure you want to delete this order? This action cannot be undone.")) {
                db.collection("orders").doc(orderId).delete()
                    .then(() => showToast("Order deleted", "success"))
                    .catch(err => showToast(err.message, "error"));
            }
        }

        function autoRenewSubscription(email, packageRaw) {
            // Find user by email
            const user = allUsers.find(u => u.email === email);
            if(!user) {
                showToast("User not found for auto-renewal", "warning");
                return Promise.reject("User not found");
            }

            // Calculate New Date
            let newExpiry = new Date();
            newExpiry.setFullYear(newExpiry.getFullYear() + 1); // Add 1 year
            
            // Determine Plan Type
            let planType = 'frontend';
            if(packageRaw.toUpperCase().includes('AI')) planType = 'ai';
            if(packageRaw.toUpperCase().includes('HTML')) planType = 'html';

            return db.collection("users").doc(user.id).update({
                planType: planType,
                expiryDate: firebase.firestore.Timestamp.fromDate(newExpiry)
            }).then(() => {
                showToast(`Subscription renewed for ${user.name}`, "success");
            });
        }

        // --- USERS (UPDATED WITH SUBSCRIPTION) ---
        function renderSplitUserTables() {
            const empBody = document.getElementById('employees-table-body');
            const clientBody = document.getElementById('clients-table-body');

            if (!dataLoaded.users) {
                const loaderHTML = `<tr><td colspan="6"><div class="loader-container"><div class="loader"></div></div></td></tr>`;
                empBody.innerHTML = loaderHTML;
                clientBody.innerHTML = loaderHTML;
                return;
            }

            empBody.innerHTML = '';
            clientBody.innerHTML = '';
            let visibleUsers = allUsers;
            const s = searchStates.users;
            if(s) {
                visibleUsers = visibleUsers.filter(u => {
                    const str = `${u.employeeId || ''} ${u.name} ${u.email} ${u.phone} ${u.companyName || ''}`.toLowerCase();
                    return str.includes(s);
                });
            }

            visibleUsers.forEach(u => {
                const role = u.role || 'user';
                let roleClass = 'role-user';
                let roleLabel = 'Client';
                if(role === 'admin') { roleClass = 'role-admin'; roleLabel = 'Admin'; }
                if(role === 'superadmin') { roleClass = 'role-superadmin'; roleLabel = 'Super Admin'; }

                const rowHTML = `
                    <tr>
                        <td style="font-family:monospace; font-weight:600;">${u.employeeId || '-'}</td>
                        <td>${u.name}</td>
                        <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                        ${role !== 'user' ? `<td style="color:var(--text-secondary); font-size:0.9rem;">${u.jobTitle || '-'}</td>` : ''}
                        <td style="font-size:0.9rem;">${u.email}</td>
                        <td>
                            <button class="action-btn" onclick="openEditUser('${u.id}')">Edit</button>
                            ${role === 'user' ? `<button class="action-btn" onclick="resetUserPass('${u.email}')">Pwd</button>` : ''}
                        </td>
                    </tr>`;

                if (role === 'user') {
                    // SUBSCRIPTION & EXPIRY LOGIC
                    let planBadge = '<span class="plan-badge plan-expired">Inactive</span>';
                    let expiryDisplay = '-';
                    
                    if(u.expiryDate) {
                        const date = u.expiryDate.toDate();
                        expiryDisplay = date.toLocaleDateString();
                        
                        const now = new Date();
                        const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));

                        if(diffDays > 0) {
                            planBadge = '<span class="plan-badge plan-frontend">Active</span>';
                            if(u.planType === 'ai') planBadge = '<span class="plan-badge plan-ai">AI</span>';
                            if(diffDays < 30) planBadge += ` <span style="color:var(--warning); font-size:0.7rem;">(${diffDays}d)</span>`;
                        } else {
                            planBadge = '<span class="plan-badge plan-expired">Expired</span>';
                        }
                    }

                    // Website Link Logic
                    let linkHtml = '-';
                    if(u.websiteLink) {
                        linkHtml = `<a href="${u.websiteLink}" target="_blank" style="color:var(--accent-primary); text-decoration:none;"><i class="ri-external-link-line"></i> Visit</a>`;
                        if(u.linkStatus === 'pending_removal') {
                            linkHtml += ` <span style="font-size:0.7rem; color:var(--warning);">(Removal Req)</span>`;
                        }
                    }

                    const companyName = u.companyName || '<span style="color:var(--text-muted); font-style:italic; font-size:0.8rem;">No Company</span>';

                    const clientRowHTML = `
                    <tr>
                        <td style="font-family:monospace; font-weight:600;">${u.employeeId || '-'}</td>
                        <td><div style="font-weight:600;">${u.name}</div></td>
                        <td>${companyName}</td>
                        <td>${planBadge}</td>
                        <td style="font-size:0.9rem;">${expiryDisplay}</td>
                        <td>${linkHtml}</td>
                        <td style="font-size:0.9rem;">${u.email}</td>
                        <td>
                            <button class="action-btn" onclick="openEditUser('${u.id}')">Edit</button>
                            <button class="action-btn" onclick="resetUserPass('${u.email}')">Pwd</button>
                        </td>
                    </tr>`;
                    clientBody.innerHTML += clientRowHTML;
                } else {
                    empBody.innerHTML += rowHTML;
                }
            });
            
            if(empBody.innerHTML === '') empBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:2rem;">No employees found.</td></tr>';
            if(clientBody.innerHTML === '') clientBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem;">No clients found.</td></tr>';
        }

        // --- SUPPORT DESK (UPDATED WITH ASSIGNMENT) ---
        function filterTickets(type, btnElement) {
            ticketFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            renderTicketsTable();
        }

        function renderTicketsTable() {
            const tbody = document.getElementById('tickets-table-body');
            if (!dataLoaded.tickets) {
                tbody.innerHTML = `<tr><td colspan="9"><div class="loader-container"><div class="loader"></div></div></td></tr>`;
                return;
            }
            tbody.innerHTML = '';
            let visibleTickets = ticketCache;
            if (ticketFilter === 'internal') visibleTickets = visibleTickets.filter(t => t.data.source === "internal");
            else if (ticketFilter === 'external') visibleTickets = visibleTickets.filter(t => t.data.source !== "internal");

            const s = searchStates.support;
            if(s) {
                visibleTickets = visibleTickets.filter(t => {
                    const d = t.data;
                    const str = `${d.name} ${d.type} ${d.message} ${t.id}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visibleTickets.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:2rem;">No tickets.</td></tr>`;
                return;
            }
            visibleTickets.forEach(item => {
                const doc = item;
                const data = item.data;
                const date = formatDateTime(data.timestamp);
                let statusClass = data.status === 'Resolved' ? 'status-paid' : 'status-open';
                const isInternal = data.source === "internal";
                const rowClass = isInternal ? "row-internal" : "";
                const sourceBadge = isInternal ? `<span class="source-badge badge-internal">Team</span>` : `<span class="source-badge badge-external">User</span>`;
                const targetInfo = data.targetName ? `<div style="font-size:0.7rem; color:var(--text-secondary); margin-top:4px;">Target: <b>${data.targetName}</b></div>` : '';
                let resolvedByDisplay = '-';
                if(data.status === 'Resolved' && data.resolvedBy) {
                    resolvedByDisplay = `<span style="font-size:0.8rem; font-weight:600; color:var(--success);">${data.resolvedBy}</span>`;
                }
                
                // Assigned To Logic
                let assignedDisplay = '-';
                if(data.assignedTo) {
                    const u = allUsers.find(user => user.id === data.assignedTo);
                    assignedDisplay = u ? u.name : "Unknown";
                }
                
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td style="color:var(--text-secondary); font-size:0.8rem; font-family:monospace;">${date}</td>
                        <td><span style="font-family:monospace; font-size:0.8rem; color:var(--accent-primary); font-weight:700;">${doc.id.substring(0,8)}...</span></td>
                        <td>${sourceBadge}</td>
                        <td style="font-weight:700;">${data.type}</td>
                        <td><div style="font-weight:600;">${data.name}</div><div style="font-size:0.8rem; color:var(--text-secondary);">${data.email}</div></td>
                        <td style="font-weight:600; color:var(--text-main);">${assignedDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                        <td style="font-size:0.85rem;">${resolvedByDisplay}</td>
                        <td><button class="action-btn" onclick="openTicketModal('${doc.id}')">View</button></td>
                    </tr>`;
            });
        }

        // --- WEBSITE LINKS LOGIC ---
        function saveUserLink() {
            const uid = document.getElementById('edit-uid').value;
            const link = document.getElementById('edit-website-link').value.trim();
            
            if(!link) return showToast("Link cannot be empty", "error");
            
            db.collection("users").doc(uid).update({
                websiteLink: link,
                linkStatus: 'active'
            }).then(() => {
                showToast("Link updated", "success");
            }).catch(err => showToast(err.message, "error"));
        }

        function requestLinkRemoval() {
            const uid = document.getElementById('edit-uid').value;
            if(confirm("Request removal of this website link? SuperAdmin approval required.")) {
                db.collection("users").doc(uid).update({
                    linkStatus: 'pending_removal'
                }).then(() => {
                    showToast("Removal requested", "success");
                    openEditUser(uid); 
                });
            }
        }

        function approveLinkRemoval() {
            const uid = document.getElementById('edit-uid').value;
            db.collection("users").doc(uid).update({
                websiteLink: firebase.firestore.FieldValue.delete(),
                linkStatus: firebase.firestore.FieldValue.delete()
            }).then(() => {
                showToast("Link removed", "success");
                openEditUser(uid);
            });
        }

        // --- CONTENT REQUESTS LOGIC (UPDATED) ---
        function renderContentRequestsTable() {
            const tbody = document.getElementById('content-requests-table-body');
            if(!dataLoaded.contentReqs) {
                tbody.innerHTML = `<tr><td colspan="8"><div class="loader-container"><div class="loader"></div></div></td></tr>`;
                return;
            }
            tbody.innerHTML = '';
            
            let visible = contentReqCache;
            const s = searchStates['content-requests'];
            if(s) {
                visible = visible.filter(req => {
                    const r = req.data;
                    const str = `${r.customerName} ${r.section} ${r.requestType}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visible.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem;">No requests found.</td></tr>';
                return;
            }

            visible.forEach(req => {
                const r = req.data;
                const date = formatDateTime(r.timestamp);
                let statusBadge = '';
                if(r.status === 'pending') statusBadge = `<span class="status-badge status-pending">Pending</span>`;
                if(r.status === 'in_progress') statusBadge = `<span class="status-badge status-in_progress">In Progress</span>`;
                if(r.status === 'completed') statusBadge = `<span class="status-badge status-paid">Completed</span>`;
                if(r.status === 'rejected') statusBadge = `<span class="status-badge status-cancelled">Rejected</span>`;

                const priceQuote = r.priceQuote ? `<span style="font-weight:700; color:var(--accent-primary);">RM ${r.priceQuote}</span>` : '-';
                const adminNoteDisplay = r.adminNote ? `<i class="ri-chat-1-line" style="margin-left:5px; color:var(--text-secondary);" title="${r.adminNote}"></i>` : '';

                tbody.innerHTML += `
                    <tr>
                        <td style="font-size:0.8rem; color:var(--text-secondary);">${date}</td>
                        <td style="font-weight:600;">${r.customerName || 'Unknown'}</td>
                        <td><span class="source-badge badge-external">${r.requestType}</span></td>
                        <td>${r.pageSection || '-'}</td>
                        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.details}</td>
                        <td>${statusBadge}</td>
                        <td>${priceQuote}</td>
                        <td>
                            <button class="action-btn" onclick="openContentReqModal('${req.id}')">
                                Manage ${adminNoteDisplay}
                            </button>
                        </td>
                    </tr>`;
            });
        }

        function openContentReqModal(reqId) {
            const req = contentReqCache.find(r => r.id === reqId);
            if(!req) return;

            // Reuse Ticket Modal structure but adapt logic for Content Requests
            const data = req.data;
            document.getElementById('ticket-id').value = reqId; // Reuse hidden input
            document.getElementById('view-ticket-id').innerText = reqId;
            document.getElementById('view-ticket-customer').innerText = `${data.customerName} (${data.requestType})`;
            document.getElementById('view-ticket-message').innerText = `${data.pageSection ? 'Section: '+data.pageSection+'\n' : ''}${data.details}`;

            // Status Select adaptation
            const select = document.getElementById('ticket-status-select');
            select.innerHTML = '';
            select.innerHTML += `<option value="pending" ${data.status==='pending'?'selected':''}>Pending</option>`;
            select.innerHTML += `<option value="in_progress" ${data.status==='in_progress'?'selected':''}>In Progress</option>`;
            select.innerHTML += `<option value="completed" ${data.status==='completed'?'selected':''}>Completed</option>`;
            select.innerHTML += `<option value="rejected" ${data.status==='rejected'?'selected':''}>Rejected</option>`;

            // Note & Price
            document.getElementById('ticket-admin-note').value = data.adminNote || '';
            
            // Add Price Input temporarily
            const container = document.querySelector('#ticketModal .modal-content');
            let priceInput = document.getElementById('content-req-price');
            if(!priceInput) {
                const div = document.createElement('div');
                div.className = 'form-row';
                div.innerHTML = `<label>Price Quote (RM)</label><input type="number" id="content-req-price" placeholder="e.g. 50">`;
                // Insert before status select
                container.insertBefore(div, container.children[container.children.length - 3]);
            }
            priceInput = document.getElementById('content-req-price');
            priceInput.value = data.priceQuote || '';

            // Assign To (Optional for content requests)
            document.getElementById('ticket-assignee-select').parentElement.style.display = 'none';
            document.getElementById('view-resolved-by-container').style.display = 'none';

            document.getElementById('ticketModal').classList.add('open');
        }

        // Override Save Ticket for Content Requests
        function saveTicket() {
            const id = document.getElementById('ticket-id').value;
            const status = document.getElementById('ticket-status-select').value;
            const note = document.getElementById('ticket-admin-note').value;
            
            // Check if this is a Content Request or Support Ticket
            const isContentReq = contentReqCache.find(r => r.id === id);
            
            if(isContentReq) {
                const price = document.getElementById('content-req-price').value;
                const updateData = { status: status, adminNote: note };
                if(price) updateData.priceQuote = price;
                else updateData.priceQuote = firebase.firestore.FieldValue.delete();
                
                if(status === 'completed' || status === 'rejected') {
                    updateData.processedBy = currentAdminEmail;
                    updateData.processedAt = firebase.firestore.FieldValue.serverTimestamp();
                }

                db.collection("content_requests").doc(id).update(updateData).then(() => {
                    closeModal('ticketModal');
                    showToast("Request updated", "success");
                    // Reset modal for next use
                    document.getElementById('ticket-assignee-select').parentElement.style.display = 'block';
                    const priceInput = document.getElementById('content-req-price');
                    if(priceInput) priceInput.parentElement.remove();
                }).catch(err => showToast(err.message, "error"));
            } else {
                // Original Support Ticket Logic
                const assignedTo = document.getElementById('ticket-assignee-select').value;
                const updateData = { status: status, adminNote: note };
                
                if(assignedTo) {
                    updateData.assignedTo = assignedTo;
                } else {
                    updateData.assignedTo = firebase.firestore.FieldValue.delete();
                }

                if(status === 'Resolved') {
                    updateData.resolvedBy = currentAdminEmail;
                    updateData.resolvedAt = firebase.firestore.FieldValue.serverTimestamp();
                } else {
                    updateData.resolvedBy = firebase.firestore.FieldValue.delete();
                    updateData.resolvedAt = firebase.firestore.FieldValue.delete();
                }

                db.collection("tickets").doc(id).update(updateData).then(() => { closeModal('ticketModal'); showToast("Ticket updated", "success"); }).catch(err => showToast(err.message, "error"));
            }
        }

        // --- VOUCHERS (UPDATED WITH EXPIRY EDIT & MANUAL REDEEM) ---
        function renderVoucherTable() {
            const tbody = document.getElementById('voucher-table-body');
            const pendingTbody = document.getElementById('pending-vouchers-table-body');
            const historyBody = document.getElementById('voucher-history-body');
            const queueContainer = document.getElementById('voucher-approval-queue');
            
            tbody.innerHTML = '';
            if(pendingTbody) pendingTbody.innerHTML = '';
            if(historyBody) historyBody.innerHTML = '';
            if(queueContainer) queueContainer.style.display = 'none'; 

            const usersWithVouchers = allUsers.filter(u => u.personalVoucher);
            const now = new Date();

            // Helper to check if voucher is expired
            const isExpired = (v) => v.expiryDate && now > v.expiryDate.toDate();

            // Pending
            let pendingVouchers = usersWithVouchers.filter(u => u.personalVoucher.status === 'pending');
            
            // Active Logic
            let activeVouchers = usersWithVouchers.filter(u => {
                const v = u.personalVoucher;
                // Must be active or undefined, not redeemed, and not expired
                const isActive = (!v.status || v.status === 'active');
                const isRedeemed = !!v.isRedeemed;
                const expired = isExpired(v);
                
                return isActive && !isRedeemed && !expired;
            });

            // History Logic
            let historyVouchers = usersWithVouchers.filter(u => {
                const v = u.personalVoucher;
                const isRedeemed = !!v.isRedeemed;
                const isActive = (!v.status || v.status === 'active');
                const expired = isExpired(v);

                // History includes: Redeemed, Disabled, or Active but Expired
                if (isRedeemed || v.status === 'disabled') return true;
                if (isActive && expired) return true;
                return false;
            });

            if (!isSuperAdmin) {
                pendingVouchers = pendingVouchers.filter(u => u.personalVoucher.voucherCreatedBy === currentAdminUID);
            }

            if (pendingVouchers.length > 0) {
                if(queueContainer) queueContainer.style.display = 'block';
            }

            let visibleVouchers = activeVouchers;
            const s = searchStates.vouchers;
            if(s) {
                visibleVouchers = visibleVouchers.filter(u => {
                    const v = u.personalVoucher;
                    const str = `${u.name} ${v.code}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(visibleVouchers.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:1rem; color:var(--text-secondary);">No active vouchers.</td></tr>';
            
            visibleVouchers.forEach(u => {
                const v = u.personalVoucher;
                const displayVal = v.type === 'fixed' ? `RM ${v.value}` : `${v.value * 100}%`;
                
                let statusHtml = '<span class="status-badge status-active">Active</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:600;">${u.name}</td>
                        <td style="color:var(--accent-primary);">${v.code}</td>
                        <td style="color:var(--success);">${displayVal}</td>
                        <td style="font-size:0.85rem;">${statusHtml}</td>
                        <td>
                            <button class="action-btn" onclick="openManageVoucher('${u.id}')">Manage</button>
                        </td>
                    </tr>`;
            });

            pendingVouchers.forEach(u => {
                const v = u.personalVoucher;
                const displayVal = v.type === 'fixed' ? `RM ${v.value}` : `${v.value * 100}%`;
                
                let actionButtons = '';
                
                if (isSuperAdmin) {
                    actionButtons = `
                        <button class="action-btn success" style="border:none; color:white;" onclick="approveVoucher('${u.id}')"><i class="ri-check-line"></i> Approve</button>
                        <button class="action-btn danger" style="color:var(--danger);" onclick="deleteUserVoucher('${u.id}')"><i class="ri-close-line"></i></button>
                    `;
                } else {
                    actionButtons = `
                        <button class="action-btn warning" style="color:black;" onclick="deleteUserVoucher('${u.id}')">Cancel Request</button>
                    `;
                }

                pendingTbody.innerHTML += `
                    <tr>
                        <td style="font-weight:600;">${u.name}</td>
                        <td style="color:var(--accent-primary);">${v.code}</td>
                        <td style="color:var(--success);">${displayVal}</td>
                        <td style="font-size:0.8rem; color:var(--text-secondary);">${v.voucherCreatedByEmail || 'Unknown'}</td>
                        <td>${actionButtons}</td>
                    </tr>`;
            });

            // --- VOUCHER HISTORY TABLE (UPDATED) ---
            if(historyVouchers.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:1rem; color:var(--text-secondary);">No history found.</td></tr>';
            } else {
                historyVouchers.forEach(u => {
                    const v = u.personalVoucher;
                    const displayVal = v.type === 'fixed' ? `RM ${v.value}` : `${v.value * 100}%`;
                    let statusHtml = '';

                    // Determine Badge Logic for History
                    if(v.isRedeemed) {
                        statusHtml = '<span class="status-badge status-inactive">Redeemed</span>';
                    } else if(v.status === 'disabled') {
                        statusHtml = '<span class="status-badge status-cancelled">Disabled</span>';
                    } else if(isExpired(v)) {
                        // If it's here because it's active but expired
                        statusHtml = '<span class="status-badge status-expired">Expired</span>';
                    } else {
                        statusHtml = '<span class="status-badge status-inactive">Unknown</span>';
                    }

                    let expiryDisplay = '-';
                    if(v.expiryDate) {
                        expiryDisplay = formatDateTime(v.expiryDate).split(' ')[0]; // Date only
                    }

                    historyBody.innerHTML += `
                        <tr>
                            <td style="font-weight:600;">${u.name}</td>
                            <td style="color:var(--text-muted);">${v.code}</td>
                            <td style="color:var(--text-muted);">${displayVal}</td>
                            <td>${statusHtml}</td>
                            <td style="font-size:0.8rem; color:var(--text-muted);">${expiryDisplay}</td>
                            <td>
                                <button class="action-btn" onclick="openManageVoucher('${u.id}')">View/Edit</button>
                            </td>
                        </tr>`;
                });
            }
        }

        function assignVoucher() {
            const uid = document.getElementById('voucher-user-select').value;
            const code = document.getElementById('voucher-code').value.trim().toUpperCase();
            const val = parseFloat(document.getElementById('voucher-val').value);
            const type = document.getElementById('voucher-type').value;
            const expiryDateInput = document.getElementById('voucher-expiry-date').value;
            
            if(!uid || !code || isNaN(val)) return showToast("Invalid Voucher Details.", "error");

            const status = isSuperAdmin ? 'active' : 'pending';
            
            // Handle Expiry
            let expiryTs = null;
            if(expiryDateInput) {
                expiryTs = firebase.firestore.Timestamp.fromDate(new Date(expiryDateInput));
            }

            const voucherData = {
                code: code,
                value: val,
                type: type,
                status: status,
                isRedeemed: false,
                expiryDate: expiryTs,
                voucherCreatedBy: currentAdminUID,
                voucherCreatedByEmail: currentAdminEmail,
                voucherTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection("users").doc(uid).update({ personalVoucher: voucherData }).then(() => {
                showToast(`Voucher ${code} created! Status: ${status.toUpperCase()}`, status === 'active' ? 'success' : 'info');
                refreshVoucherTable();
            }).catch(err => showToast(err.message, "error"));
        }

        function approveVoucher(uid) {
            db.collection("users").doc(uid).update({
                "personalVoucher.status": "active"
            }).then(() => {
                showToast("Voucher Approved!", "success");
            });
        }

        function refreshVoucherTable() {
            renderVoucherTable();
        }

        function deleteUserVoucher(uid) {
            if(confirm("Remove voucher?")) db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
        }

        // --- MANAGE VOUCHER MODAL (UPDATED LOGIC) ---
        function openManageVoucher(uid) {
            const user = allUsers.find(u => u.id === uid);
            if(!user || !user.personalVoucher) return;
            const v = user.personalVoucher;
            
            currentManageVoucherUID = uid;
            document.getElementById('manage-voucher-code').value = v.code;
            
            const valDisplay = v.type === 'fixed' ? `RM ${v.value}` : `${v.value * 100}%`;
            document.getElementById('manage-voucher-value-display').innerText = valDisplay;
            
            document.getElementById('manage-voucher-status').value = v.status || 'active';
            
            // Set Redeemed Checkbox
            document.getElementById('manage-voucher-redeemed').checked = !!v.isRedeemed;
            
            // Format expiry for input (YYYY-MM-DD)
            if(v.expiryDate) {
                const d = v.expiryDate.toDate();
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() +1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                document.getElementById('manage-voucher-expiry').value = `${yyyy}-${mm}-${dd}`;
            } else {
                document.getElementById('manage-voucher-expiry').value = '';
            }

            // NEW: Check if currently expired
            const warningBox = document.getElementById('voucher-expired-warning');
            if(v.expiryDate && !v.isRedeemed && v.status === 'active') {
                const now = new Date();
                const exp = v.expiryDate.toDate();
                if(now > exp) {
                    warningBox.style.display = 'block';
                } else {
                    warningBox.style.display = 'none';
                }
            } else {
                warningBox.style.display = 'none';
            }

            document.getElementById('manageVoucherModal').classList.add('open');
        }

        function saveManagedVoucher() {
            const uid = currentManageVoucherUID;
            if(!uid) return;
            
            const newStatus = document.getElementById('manage-voucher-status').value;
            const isRedeemed = document.getElementById('manage-voucher-redeemed').checked;
            const newExpiryStr = document.getElementById('manage-voucher-expiry').value;
            
            // We must fetch full user object to avoid overwriting other fields
            const user = allUsers.find(u => u.id === uid);
            if(!user) return;
            
            const currentVoucher = user.personalVoucher;
            
            // Updates
            const updates = {
                "personalVoucher.status": newStatus,
                "personalVoucher.isRedeemed": isRedeemed
            };

            if(newExpiryStr) {
                updates["personalVoucher.expiryDate"] = firebase.firestore.Timestamp.fromDate(new Date(newExpiryStr));
            } else {
                updates["personalVoucher.expiryDate"] = firebase.firestore.FieldValue.delete();
            }
            
            db.collection("users").doc(uid).update(updates).then(() => {
                showToast("Voucher updated", "success");
                closeModal('manageVoucherModal');
            }).catch(err => showToast(err.message, "error"));
        }

        // --- PROMOS (WITH APPROVAL) ---
        function renderPromoTable() {
            const tbody = document.getElementById('promo-table-body');
            const pendingTbody = document.getElementById('pending-promos-table-body');
            const queueContainer = document.getElementById('promo-approval-queue');

            if (!dataLoaded.promos) {
                tbody.innerHTML = `<tr><td colspan="4"><div class="loader-container"><div class="loader"></div></div></td></tr>`;
                return;
            }

            tbody.innerHTML = '';
            if(pendingTbody) pendingTbody.innerHTML = '';
            if(queueContainer) queueContainer.style.display = 'none';

            let visiblePromos = promoCache;
            
            let pendingPromos = promoCache.filter(p => p.data.status === 'pending');
            const activePromos = promoCache.filter(p => !p.data.status || p.data.status === 'active');

            if (!isSuperAdmin) {
                pendingPromos = pendingPromos.filter(p => p.data.createdBy === currentAdminUID);
            }

            if (pendingPromos.length > 0) {
                if(queueContainer) queueContainer.style.display = 'block';
            }

            const s = searchStates.promos;
            if(s) {
                activePromos = activePromos.filter(p => p.id.toLowerCase().includes(s));
            }

            if(activePromos.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:2rem;">No active promos found.</td></tr>';
            
            activePromos.forEach(doc => {
                const data = doc.data;
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:700; color: var(--accent-primary);">${doc.id}</td>
                        <td style="font-weight:700; color: var(--success);">${(data.discount * 100).toFixed(0)}%</td>
                        <td><span class="status-badge status-active">Active</span></td>
                        <td><button class="action-btn" style="color: var(--danger);" onclick="deletePromo('${doc.id}')">Del</button></td>
                    </tr>`;
            });

            pendingPromos.forEach(doc => {
                const data = doc.data;

                let actionButtons = '';
                if (isSuperAdmin) {
                    actionButtons = `
                        <button class="action-btn success" style="border:none; color:white;" onclick="approvePromo('${doc.id}')"><i class="ri-check-line"></i> Approve</button>
                        <button class="action-btn danger" style="color:black;" onclick="deletePromo('${doc.id}')"><i class="ri-close-line"></i></button>
                    `;
                } else {
                    actionButtons = `
                        <button class="action-btn warning" style="color:black;" onclick="deletePromo('${doc.id}')">Cancel Request</button>
                    `;
                }

                pendingTbody.innerHTML += `
                    <tr>
                        <td style="font-weight:700; color: var(--accent-primary);">${doc.id}</td>
                        <td style="font-weight:700; color: var(--success);">${(data.discount * 100).toFixed(0)}%</td>
                        <td style="font-size:0.8rem; color:var(--text-secondary);">${data.createdByEmail || 'Unknown'}</td>
                        <td>${actionButtons}</td>
                    </tr>`;
            });
        }

        function createPromo() {
            const code = document.getElementById('new-promo-code').value.trim().toUpperCase();
            const val = parseFloat(document.getElementById('new-promo-val').value);
            if(!code || isNaN(val)) return showToast("Invalid input", "error");
            if(val <= 0 || val >= 1) return showToast("Discount must be between 0 and 1", "error");

            const status = isSuperAdmin ? 'active' : 'pending';

            db.collection("promo_codes").doc(code).set({ 
                discount: val, 
                status: status,
                createdBy: currentAdminUID,
                createdByEmail: currentAdminEmail,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { 
                document.getElementById('new-promo-code').value = ''; 
                document.getElementById('new-promo-val').value = ''; 
                showToast(`Promo created! Status: ${status.toUpperCase()}`, status === 'active' ? 'success' : 'info'); 
            }).catch(err => showToast(err.message, "error"));
        }

        function approvePromo(code) {
            db.collection("promo_codes").doc(code).update({ status: 'active' }).then(() => {
                showToast("Promo Approved!", "success");
            });
        }

        function deletePromo(code) {
            if(confirm(`Delete code ${code}?`)) db.collection("promo_codes").doc(code).delete();
        }

        // --- LOGS ---
        function loadLogsTab(type) {
            const buttons = document.querySelectorAll('#tab-logs .sm-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            let activeBtnId = 'btn-log-all';
            if(type === 'tickets') activeBtnId = 'btn-log-tickets';
            if(type === 'vouchers') activeBtnId = 'btn-log-vouchers';
            const activeBtn = document.getElementById(activeBtnId);
            if(activeBtn) activeBtn.classList.add('active');
            currentLogFilter = type;
            renderLogsTable();
        }

        function renderLogsTable() {
            const tbody = document.getElementById('logs-table-body');
            if (!dataLoaded.tickets || !dataLoaded.users) {
                 tbody.innerHTML = `<tr><td colspan="4"><div class="loader-container"><div class="loader"></div></div></td></tr>`;
                 return;
            }
            tbody.innerHTML = '';
            let logEntries = [];

            allUsers.filter(u => u.personalVoucher).forEach(u => {
                const v = u.personalVoucher;
                const date = v.voucherTimestamp ? new Date(v.voucherTimestamp.toDate()).toLocaleString() : '-';
                logEntries.push({
                    timestamp: date,
                    admin: v.voucherCreatedByEmail || 'Admin',
                    action: 'Assigned Voucher',
                    detail: `Code: ${v.code} to ${u.name}`,
                    type: 'voucher'
                });
            });

            ticketCache.filter(t => t.data.status === 'Resolved').slice(0, 20).forEach(t => {
                const date = t.data.timestamp ? new Date(t.data.timestamp.toDate()).toLocaleString() : '-';
                const resolvedBy = t.data.resolvedBy || (t.data.adminNote ? t.data.adminNote.split(' ')[0] : 'Admin');
                logEntries.push({
                    timestamp: date,
                    admin: resolvedBy,
                    action: 'Resolved Ticket',
                    detail: `Case #${t.id.substring(0,6)}: ${t.data.name}`,
                    type: 'ticket'
                });
            });

            logEntries.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            if(currentLogFilter !== 'all') {
                if(currentLogFilter === 'vouchers') logEntries = logEntries.filter(l => l.type === 'voucher');
                if(currentLogFilter === 'tickets') logEntries = logEntries.filter(l => l.type === 'ticket');
            }

            const s = searchStates.logs;
            if(s) {
                logEntries = logEntries.filter(l => {
                    const str = `${l.admin} ${l.action} ${l.detail}`.toLowerCase();
                    return str.includes(s);
                });
            }

            if(logEntries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:2rem; color:var(--text-secondary);">No logs found.</td></tr>`;
                return;
            }

            logEntries.forEach(log => {
                tbody.innerHTML += `
                    <tr>
                        <td class="log-timestamp">${log.timestamp}</td>
                        <td class="log-admin">${log.admin}</td>
                        <td style="font-weight:600; font-size:0.85rem;">${log.action}</td>
                        <td class="log-detail">${log.detail}</td>
                    </tr>`;
            });
        }

        // --- CONFIG & CONTENT ---
        function updateContentUI() {
            if(siteConfig.packageDetails) {
                const frontData = siteConfig.packageDetails.frontend || DEFAULT_DETAILS.frontend;
                const aiData = siteConfig.packageDetails.ai || DEFAULT_DETAILS.ai;
                document.getElementById('details-frontend').value = frontData.join('\n');
                document.getElementById('details-ai').value = aiData.join('\n');
            } else {
                document.getElementById('details-frontend').value = DEFAULT_DETAILS.frontend.join('\n');
                document.getElementById('details-ai').value = DEFAULT_DETAILS.ai.join('\n');
            }
        }

        function saveContentConfig() {
            const frontText = document.getElementById('details-frontend').value;
            const aiText = document.getElementById('details-ai').value;
            siteConfig.packageDetails = {
                frontend: frontText.split('\n').filter(line => line.trim() !== ''),
                ai: aiText.split('\n').filter(line => line.trim() !== '')
            };
            db.collection("config").doc("site_settings").set({ packageDetails: siteConfig.packageDetails }, { merge: true }).then(() => showToast("Details Updated!", "success")).catch(err => showToast(err.message, "error"));
        }

        function updateDiscountUI() {
            const toggleCircle = document.getElementById('discount-toggle-circle');
            const isActive = siteConfig.discountActive || false;
            const percent = siteConfig.discountPercent || 0;

            if (isActive) {
                toggleCircle.style.left = '27px'; toggleCircle.style.background = '#10b981';
                document.getElementById('discount-value').value = (percent * 100).toFixed(0);
            } else {
                toggleCircle.style.left = '3px'; toggleCircle.style.background = '#555';
                document.getElementById('discount-value').value = "";
            }
        }

        function toggleDiscountStatus() {
            siteConfig.discountActive = !siteConfig.discountActive;
            updateDiscountUI();
        }

        function saveDiscountConfig() {
            const inputVal = parseFloat(document.getElementById('discount-value').value);
            const isActive = siteConfig.discountActive;

            if (isActive && (isNaN(inputVal) || inputVal <=0)) return showToast("Invalid Discount Value", "error");

            const decimalVal = inputVal / 100;
            const update = { discountActive: isActive, discountPercent: decimalVal };

            db.collection("config").doc("site_settings").update(update)
                .then(() => showToast("Discount Config Saved!", "success"))
                .catch(err => showToast(err.message, "error"));
        }

        function updateMaintenanceUI() {
            const toggleCircle = document.getElementById('maintenance-toggle-circle');
            if(siteConfig.maintenance_active) {
                toggleCircle.style.left = '27px'; toggleCircle.style.background = '#10b981';
                document.getElementById('maintenance-msg').value = siteConfig.message || "Site is under maintenance.";
            } else {
                toggleCircle.style.left = '3px'; toggleCircle.style.background = '#555';
                document.getElementById('maintenance-msg').value = "";
            }
        }

        function toggleMaintenanceStatus() {
            siteConfig.maintenance_active = !siteConfig.maintenance_active;
            updateMaintenanceUI();
        }

        function saveMaintenanceConfig() {
            const msg = document.getElementById('maintenance-msg').value;
            siteConfig.message = msg;
            db.collection("config").doc("site_settings").set({ maintenance_active: siteConfig.maintenance_active, message: msg }, { merge: true }).then(() => showToast("Saved!", "success"));
        }

        function updatePricingUI() {
            if(siteConfig.prices) {
                document.getElementById('price-html').value = siteConfig.prices.html || 199;
                document.getElementById('price-frontend').value = siteConfig.prices.frontend ||599;
                document.getElementById('price-ai').value = siteConfig.prices.ai || 999;
            }
        }

        function savePricingConfig() {
            const htmlPrice = parseFloat(document.getElementById('price-html').value);
            const frontendPrice = parseFloat(document.getElementById('price-frontend').value);
            const aiPrice = parseFloat(document.getElementById('price-ai').value);
            siteConfig.prices = { html: htmlPrice, frontend: frontendPrice, ai: aiPrice };
            db.collection("config").doc("site_settings").update({ prices: siteConfig.prices }).then(() => showToast("Prices updated!", "success"));
        }

        // --- PAYMENT METHODS CONFIG (UPDATED) ---
         function getPaymentIcon(id) {
            const idLower = id.toLowerCase();
            if(idLower.includes('tng') || idLower.includes('wallet') || idLower.includes('grab')) return 'ri-wallet-3-line';
            if(idLower.includes('fpx') || idLower.includes('bank') || idLower.includes('maybank')) return 'ri-safe-2-line';
            if(idLower.includes('qr') || idLower.includes('pay') || idLower.includes('bill')) return 'ri-qr-code-line';
            if(idLower.includes('crypto') || idLower.includes('bitcoin')) return 'ri-btc-line';
            if(idLower.includes('card') || idLower.includes('credit')) return 'ri-bank-card-line';
            return 'ri-money-dollar-circle-line';
        }

        function updatePaymentMethodsUI() {
            const methods = siteConfig.payment_methods && siteConfig.payment_methods.length >0 
                            ? siteConfig.payment_methods 
                            : DEFAULT_PAYMENT_METHODS;

            const container = document.getElementById('payment-methods-list');
            container.innerHTML = '';

            if(methods.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-secondary);">No payment methods configured.</div>';
                return;
            }

            let html = `
                <div class="table-responsive">
                    <table style="width:100%; border-collapse: collapse; margin-top:10px;">
                        <thead>
                            <tr style="background:var(--bg-input);">
                                <th style="padding:10px; text-align:left; font-size:0.75rem;">Icon</th>
                                <th style="padding:10px; text-align:left; font-size:0.75rem;">Method Name</th>
                                <th style="padding:10px; text-align:left; font-size:0.75rem;">ID</th>
                                <th style="padding:10px; text-align:left; font-size:0.75rem;">Payment URL</th>
                                <th style="padding:10px; text-align:center; font-size:0.75rem;">Status</th>
                                <th style="padding:10px; text-align:right; font-size:0.75rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            methods.forEach((pm, index) => {
                const statusBadge = pm.active 
                    ? `<span class="status-badge status-active"><i class="ri-checkbox-circle-line" style="margin-right:4px; font-size: 0.8rem;"></i> Active</span>` 
                    : `<span class="status-badge status-inactive"><i class="ri-close-circle-line" style="margin-right:4px; font-size: 0.8rem;"></i> Disabled</span>`;
                
                const icon = getPaymentIcon(pm.id);

                html += `
                    <tr style="border-bottom:1px solid var(--border-color);">
                        <td style="padding:10px; text-align:center; vertical-align:middle;">
                            <i class="${icon}" style="font-size: 1.2rem; color: var(--text-main);"></i>
                        </td>
                        <td style="padding:10px; font-weight:600;">${pm.name}</td>
                        <td style="padding:10px; font-family:monospace; font-size:0.85rem;">${pm.id}</td>
                        <td style="padding:10px; font-size:0.9rem;">
                            <div class="pay-url-text" title="${pm.url}">${pm.url}</div>
                        </td>
                        <td style="padding:10px; text-align:center;">${statusBadge}</td>
                        <td style="padding:10px; text-align:right;">
                            <button class="action-btn" onclick="openEditPaymentModal(${index})" title="Edit details">
                                <i class="ri-edit-line"></i> Edit
                            </button>
                            <button class="action-btn" onclick="togglePaymentMethod(${index})">${pm.active ? 'Disable' : 'Enable'}</button>
                            <button class="action-btn" style="color:var(--danger);" onclick="deletePaymentMethod(${index})" title="Delete Gateway">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function openEditPaymentModal(index) {
            const currentMethods = siteConfig.payment_methods && siteConfig.payment_methods.length > 0 
                                ? siteConfig.payment_methods 
                                : DEFAULT_PAYMENT_METHODS;

            const method = currentMethods[index];
            currentPaymentEditIndex = index;

            document.getElementById('edit-pay-name').value = method.name;
            document.getElementById('edit-pay-id').value = method.id;
            document.getElementById('edit-pay-url').value = method.url;

            document.getElementById('editPaymentModal').classList.add('open');
        }

        function addPaymentMethod() {
            const name = document.getElementById('new-pay-name').value.trim();
            const id = document.getElementById('new-pay-id').value.trim().toLowerCase();
            let url = document.getElementById('new-pay-url').value.trim();

            if(!name || !id || !url) return showToast("All fields are required.", "error");
            
            if(url && !url.startsWith('http')) {
                url = 'https://' + url;
            }

            const currentMethods = siteConfig.payment_methods && siteConfig.payment_methods.length > 0 
                                ? siteConfig.payment_methods 
                                : DEFAULT_PAYMENT_METHODS;

            if(currentMethods.some(m => m.id === id)) {
                return showToast("Method ID already exists.", "error");
            }

            const newMethod = {
                id: id,
                name: name,
                url: url,
                active: true
            };

            currentMethods.push(newMethod);
            savePaymentMethods(currentMethods);
        }

        function updatePaymentMethod() {
            const index = currentPaymentEditIndex;
            if(index === -1) return;

            const name = document.getElementById('edit-pay-name').value.trim();
            let url = document.getElementById('edit-pay-url').value.trim();

            if(!name || !url) return showToast("Fields cannot be empty", "error");
             if(url && !url.startsWith('http')) {
                url = 'https://' + url;
            }

            const currentMethods = siteConfig.payment_methods && siteConfig.payment_methods.length > 0 
                                ? siteConfig.payment_methods 
                                : DEFAULT_PAYMENT_METHODS;

            currentMethods[index].name = name;
            currentMethods[index].url = url;

            savePaymentMethods(currentMethods);
            closeModal('editPaymentModal');
        }

        function togglePaymentMethod(index) {
            const currentMethods = siteConfig.payment_methods && siteConfig.payment_methods.length > 0 
                                ? siteConfig.payment_methods 
                                : DEFAULT_PAYMENT_METHODS;
            currentMethods[index].active = !currentMethods[index].active;
            savePaymentMethods(currentMethods);
        }

        function deletePaymentMethod(index) {
            if(!confirm("Delete this payment gateway?")) return;
            const currentMethods = siteConfig.payment_methods && siteConfig.payment_methods.length > 0 
                                ? siteConfig.payment_methods 
                                : DEFAULT_PAYMENT_METHODS;
            currentMethods.splice(index,1);
            savePaymentMethods(currentMethods);
        }

        function savePaymentMethods(methodsArray) {
            db.collection("config").doc("site_settings").update({ payment_methods: methodsArray })
                .then(() => {
                    showToast("Payment methods updated!", "success");
                    document.getElementById('new-pay-name').value = '';
                    document.getElementById('new-pay-id').value = '';
                    document.getElementById('new-pay-url').value = '';
                })
                .catch(err => showToast(err.message, "error"));
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            const navItems = Array.from(document.querySelectorAll('.sidebar .nav-item'));
            const mapping = ['dashboard','orders','users','tasks','support','vouchers','promos','content-requests','logs','maintenance','content'];
            const index = mapping.indexOf(tabId);
            if(index !== -1 && navItems[index]) navItems[index].classList.add('active');
            
            if(window.innerWidth <= 768) toggleSidebar();
            if(tabId === 'logs') loadLogsTab(currentLogFilter || 'all');
        }

        // --- USER MANAGEMENT MODALS ---
        function openCreateUserModal() {
            document.getElementById('create-name').value = '';
            document.getElementById('create-email').value = '';
            document.getElementById('create-password').value = '';
            document.getElementById('create-phone').value = '';
            document.getElementById('create-role').value = 'user';
            document.getElementById('create-emp-id').value = '';
            document.getElementById('create-company-name').value = '';
            document.getElementById('emp-id-error').style.display = 'none';
            toggleCompanyField();
            document.getElementById('createUserModal').classList.add('open');
        }

        function toggleCompanyField() {
            // Logic to show/hide Company Name field based on role
            const role = document.getElementById('create-role').value;
            const wrapper = document.getElementById('create-company-name-wrapper');
            if (role === 'user') {
                wrapper.style.display = 'block';
            } else {
                wrapper.style.display = 'none';
                document.getElementById('create-company-name').value = ''; // Clear if hidden
            }
        }
        
        // Also add listener to Edit Modal role change
        document.getElementById('edit-role').addEventListener('change', function() {
            const role = this.value;
            const wrapper = document.getElementById('edit-company-name-wrapper');
            const subWrapper = document.getElementById('edit-subscription-management');
            
            if (role === 'user') {
                wrapper.style.display = 'block';
                subWrapper.style.display = 'block';
            } else {
                wrapper.style.display = 'none';
                subWrapper.style.display = 'none';
                document.getElementById('create-company-name').value = '';
            }
        });

        function checkEmpIdUnique(val) {
            const exists = allUsers.some(u => u.employeeId === val);
            const err = document.getElementById('emp-id-error');
            if(exists) {
                err.style.display = 'block';
                return false;
            } else {
                err.style.display = 'none';
                return true;
            }
        }

        function createNewUser() {
            const empId = document.getElementById('create-emp-id').value.trim();
            const name = document.getElementById('create-name').value;
            const email = document.getElementById('create-email').value;
            const password = document.getElementById('create-password').value;
            const phone = document.getElementById('create-phone').value;
            const role = document.getElementById('create-role').value;
            const companyName = document.getElementById('create-company-name').value;

            if(!checkEmpIdUnique(empId)) return showToast("Employee ID already exists.", "error");
            if(!empId || !name || !email || !password) return showToast("All fields are required.", "error");

            const userData = {
                employeeId: empId,
                name: name,
                email: email,
                phone: phone,
                role: role,
                jobTitle: role === 'superadmin' ? 'Super Admin' : '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (role === 'user' && companyName) {
                userData.companyName = companyName;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return db.collection("users").doc(user.uid).set(userData);
                })
                .then(() => {
                    closeModal('createUserModal');
                    showToast("User Created Successfully!", "success");
                })
                .catch((error) => {
                    showToast("Error creating user: " + error.message, "error");
                });
        }

        function requestAdminReset() {
            if(confirm("Send a password reset request to SuperAdmin?")) {
                const ticketData = {
                    name: currentAdminEmail,
                    email: currentAdminEmail,
                    phone: "",
                    type: "Password Reset Request",
                    message: `Admin ${currentAdminEmail} is requesting a password reset. Please reset my credentials.`,
                    status: 'Open',
                    source: "internal",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    adminNote: '',
                    targetName: "Super Admin",
                    adminEmail: currentAdminEmail,
                    resolvedBy: null,
                    resolvedAt: null
                };

                db.collection("tickets").add(ticketData).then(() => {
                    showToast("Reset Request Sent to SuperAdmin", "success");
                }).catch(err => showToast("Error: " + err.message, "error"));
            }
        }

        function openInternalTicketModal() {
            document.getElementById('ticket-message').value = '';
            document.getElementById('ticket-target-user-select').value = '';
            document.getElementById('ticket-target-user-name').value = '';
            document.getElementById('ticket-type').value = 'Internal Bug';

            const select = document.getElementById('ticket-target-user-select');
            let optionsHTML = '<option value="">General (Myself)</option>';
            allUsers.forEach(u => {
                optionsHTML += `<option value="${u.id}" data-name="${u.name}" data-email="${u.email}" data-phone="${u.phone}">${u.name}</option>`;
            });
            select.innerHTML = optionsHTML;

            document.getElementById('internalTicketModal').classList.add('open');
        }

        document.getElementById('ticket-target-user-select').addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const name = selectedOption.getAttribute('data-name');
            document.getElementById('ticket-target-user-name').value = name || "";
        });

        function submitInternalTicket() {
            const type = document.getElementById('ticket-type').value;
            const message = document.getElementById('ticket-message').value;
            const targetUserId = document.getElementById('ticket-target-user-select').value;
            const targetName = document.getElementById('ticket-target-user-name').value;
            
            let targetEmail = currentAdminEmail; 
            let targetPhone = "";
            let source = "internal";
            
            if (targetUserId) {
                const targetUser = allUsers.find(u => u.id === targetUserId);
                if(targetUser) {
                    targetEmail = targetUser.email;
                    targetPhone = targetUser.phone;
                }
            }

            const ticketData = {
                name: currentAdminEmail,
                email: currentAdminEmail,
                phone: "", 
                type: type,
                message: message,
                status: 'Open',
                source: "internal",
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                adminNote: '',
                targetName: targetName || "",
                targetEmail: targetEmail,
                targetPhone: targetPhone,
                adminEmail: currentAdminEmail,
                resolvedBy: null,
                resolvedAt: null
            };

            db.collection("tickets").add(ticketData).then(() => {
                closeModal('internalTicketModal');
                showToast("Internal Ticket Created Successfully!", "success");
            }).catch(err => showToast("Error creating ticket: " + err.message, "error"));
        }

        function openEditUser(uid) {
            const userObj = allUsers.find(u => u.id === uid);
            if(!userObj) return;
            const data = userObj;
            const isTargetSuperAdmin = (data.role === 'superadmin');
            const isCurrentUserAdmin = (!isSuperAdmin);

            document.getElementById('edit-permission-warning').style.display = 'none';
            document.getElementById('edit-user-actions').style.display = 'flex';
            document.getElementById('client-website-management').style.display = 'none';
            document.getElementById('edit-subscription-management').style.display = 'none';
            document.getElementById('edit-company-name-wrapper').style.display = 'none';
            document.querySelectorAll('#editUserModal input, #editUserModal select, #editUserModal button:not(.modal-close-btn)').forEach(el => el.disabled = false);

            if(isCurrentUserAdmin) {
                document.getElementById('edit-permission-warning').style.display = 'block';
                document.getElementById('edit-permission-warning').querySelector('.alert-text').innerHTML = "Access Restricted. Contact SuperAdmin.";
                document.getElementById('edit-user-actions').style.display = 'none';
                
                document.getElementById('edit-uid').value = uid;
                document.getElementById('edit-name').value = data.name || '';
                document.getElementById('edit-phone').value = data.phone || '';
                document.getElementById('edit-role').value = data.role || 'user';
                document.getElementById('edit-emp-id').value = data.employeeId || '';
                document.getElementById('edit-jobtitle').value = data.jobTitle || '';
                document.getElementById('edit-company-name').value = data.companyName || '';
                
                document.querySelectorAll('#editUserModal input, #editUserModal select').forEach(el => el.disabled = true);
                document.getElementById('editUserModal').classList.add('open');
                return;
            }

            document.getElementById('edit-uid').value = uid;
            document.getElementById('edit-name').value = data.name || '';
            document.getElementById('edit-phone').value = data.phone || '';
            document.getElementById('edit-role').value = data.role || 'user';
            document.getElementById('edit-emp-id').value = data.employeeId || '';
            document.getElementById('edit-company-name').value = data.companyName || '';
            
            const roleSelect = document.getElementById('edit-role');
            const jobTitleInput = document.getElementById('edit-jobtitle');
            const nameInput = document.getElementById('edit-name');
            const phoneInput = document.getElementById('edit-phone');
            const empIdInput = document.getElementById('edit-emp-id');
            const helperLabel = document.getElementById('jobtitle-helper');
            const restrictionMsg = document.getElementById('edit-restriction-msg');

            nameInput.disabled = false;
            phoneInput.disabled = false;
            empIdInput.disabled = false;
            roleSelect.disabled = false;
            jobTitleInput.disabled = false;
            jobTitleInput.value = data.jobTitle || "";
            helperLabel.style.display = 'inline';
            restrictionMsg.style.display = 'none';

            // Handle Company Name Visibility
            if (data.role === 'user') {
                document.getElementById('edit-company-name-wrapper').style.display = 'block';
                document.getElementById('edit-subscription-management').style.display = 'block';
            }

            // Handle Website Link Display for Clients
            const linkSection = document.getElementById('client-website-management');
            const linkInput = document.getElementById('edit-website-link');
            const linkStatusDiv = document.getElementById('link-removal-status');
            const btnRemove = document.getElementById('btn-request-remove-link');
            const btnApprove = document.getElementById('btn-approve-remove-link');
            
            linkStatusDiv.style.display = 'none';
            btnRemove.style.display = 'none';
            btnApprove.style.display = 'none';

            if (data.role === 'user') {
                linkSection.style.display = 'block';
                linkInput.value = data.websiteLink || '';
                
                if(data.websiteLink) {
                    if(data.linkStatus === 'pending_removal') {
                        linkStatusDiv.style.display = 'block';
                        if(isSuperAdmin) btnApprove.style.display = 'inline-block';
                        linkInput.disabled = true;
                    } else {
                        if(!isSuperAdmin) btnRemove.style.display = 'inline-block';
                    }
                } else {
                    // No link
                }
            } else {
                linkSection.style.display = 'none';
            }

            // Handle Subscription Inputs
            if(data.role === 'user') {
                document.getElementById('edit-plan-type').value = data.planType || 'frontend';
                if(data.expiryDate) {
                    const date = data.expiryDate.toDate();
                    // Format for date input (YYYY-MM-DD)
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() +1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    document.getElementById('edit-expiry-date').value = `${yyyy}-${mm}-${dd}`;
                } else {
                    document.getElementById('edit-expiry-date').value = '';
                }
            }
            
            document.getElementById('editUserModal').classList.add('open');
        }

        function saveUser() {
            const uid = document.getElementById('edit-uid').value;
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            const role = document.getElementById('edit-role').value;
            const empId = document.getElementById('edit-emp-id').value;
            const companyName = document.getElementById('edit-company-name').value;
            
            if (!isSuperAdmin && role === 'superadmin') {
                showToast("You do not have permission to modify SuperAdmin accounts.", "error");
                return;
            }

            if(!name || !phone) return showToast("Fields cannot be empty", "error");

            const existingUser = allUsers.find(u => u.id !== uid && u.employeeId === empId);
            if(existingUser) {
                showToast("Employee ID already exists.", "error");
                return;
            }
            
            const updateData = { name: name, phone: phone, role: role, employeeId: empId };

            if (isSuperAdmin) {
                updateData.jobTitle = document.getElementById('edit-jobtitle').value;
            }

            if (role === 'user') {
                updateData.companyName = companyName;
                
                // SUBSCRIPTION LOGIC
                const planType = document.getElementById('edit-plan-type').value;
                const expiryDateStr = document.getElementById('edit-expiry-date').value;
                
                updateData.planType = planType;
                
                if(expiryDateStr) {
                    updateData.expiryDate = firebase.firestore.Timestamp.fromDate(new Date(expiryDateStr));
                } else {
                    updateData.expiryDate = firebase.firestore.FieldValue.delete();
                }

            } else {
                updateData.companyName = firebase.firestore.FieldValue.delete();
                updateData.planType = firebase.firestore.FieldValue.delete();
                updateData.expiryDate = firebase.firestore.FieldValue.delete();
            }

            db.collection("users").doc(uid).update(updateData).then(() => { closeModal('editUserModal'); showToast("User updated", "success"); }).catch(err => showToast(err.message, "error"));
        }

        function resetUserPass(email) {
            if(confirm(`Reset password for ${email}?`)) {
                auth.sendPasswordResetEmail(email).then(() => showToast("Reset email sent.", "success")).catch(err => showToast(err.message, "error"));
            }
        }

        function openTicketModal(ticketId) {
            // This function is now handled by openContentReqModal if it's a content request
            // But for standard tickets, we do this:
            const isContentReq = contentReqCache.find(r => r.id === ticketId);
            if(isContentReq) {
                openContentReqModal(ticketId);
                return;
            }

            const ticketObj = ticketCache.find(t => t.id === ticketId);
            if(!ticketObj) return;
            const data = ticketObj.data;

            document.getElementById('ticket-id').value = ticketId;
            document.getElementById('ticket-status-select').value = data.status || 'Open';
            document.getElementById('ticket-admin-note').value = data.adminNote || '';
            
            // Populate Assignee Select
            const assignSelect = document.getElementById('ticket-assignee-select');
            assignSelect.value = data.assignedTo || "";

            document.getElementById('view-ticket-id').innerText = ticketId;
            document.getElementById('view-ticket-customer').innerText = `${data.name} (${data.email})`;
            document.getElementById('view-ticket-message').innerText = data.message;

            const resolvedContainer = document.getElementById('view-resolved-by-container');
            const resolvedByDiv = document.getElementById('view-ticket-resolved-by');
            const resolvedAtDiv = document.getElementById('view-ticket-resolved-at');

            if(data.status === 'Resolved' && (data.resolvedBy || data.adminNote)) {
                resolvedContainer.style.display = 'block';
                resolvedByDiv.innerText = data.resolvedBy || 'Admin';
                if(data.resolvedAt) {
                    resolvedAtDiv.innerText = new Date(data.resolvedAt.toDate()).toLocaleString();
                } else {
                    resolvedAtDiv.innerText = '';
                }
            } else {
                resolvedContainer.style.display = 'none';
            }

            // Ensure Price Input is removed for standard tickets
            const priceInput = document.getElementById('content-req-price');
            if(priceInput) priceInput.parentElement.remove();
            
            // Ensure Assignee is shown
            document.getElementById('ticket-assignee-select').parentElement.style.display = 'block';

            document.getElementById('ticketModal').classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }
    </script>
</body>
</html>
