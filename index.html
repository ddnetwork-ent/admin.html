<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal v9.5 | DDNetwork One</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            /* Theme Colors - High Contrast */
            --bg-body: #050505;
            --bg-panel: #09090b;
            --bg-card: #121214;
            --bg-input: #1c1c1f;
            --border: #27272a;
            --border-light: #3f3f46;
            --text-main: #ededed;
            --text-muted: #a1a1aa;
            --text-dark: #52525b;
            
            /* Accents */
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.15);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ticket: #8b5cf6; 
            --info: #0ea5e9;
            
            --font: 'Inter', sans-serif;
            --sidebar-width: 260px;
            --header-height: 64px;
        }

        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg-body); 
            color: var(--text-main); 
            font-family: var(--font); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }
        
        /* UTILITIES */
        .hidden { display: none !important; }
        .flex { display: flex; } 
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; } 
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; } 
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.85rem; }
        .font-bold { font-weight: 700; }
        .text-muted { color: var(--text-muted); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* BUTTONS */
        .btn {
            padding: 0.6rem 1rem; 
            border-radius: 8px; 
            border: 1px solid transparent; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
            transition: all 0.2s; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
            color: white;
            background: var(--bg-input);
        }
        .btn:hover { filter: brightness(1.2); }
        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary); color: white; border: 1px solid var(--primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        .btn-success { background: var(--success); color: white; border: 1px solid var(--success); }
        .btn-danger { background: var(--danger); color: white; border: 1px solid var(--danger); }
        .btn-info { background: var(--info); color: white; border: 1px solid var(--info); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: white; background: rgba(255,255,255,0.05); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.75rem; }
        
        .btn-icon { 
            padding: 0.5rem; 
            border-radius: 8px; 
            background: transparent; 
            color: var(--text-muted); 
            cursor: pointer; 
            border: none; 
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.1); }
        .btn-icon.spin:hover i { animation: spin 1s linear infinite; }

        /* FORMS */
        input, select, textarea {
            width: 100%; 
            padding: 0.75rem 0.9rem; 
            background: var(--bg-input); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: white; 
            font-family: inherit; 
            font-size: 0.9rem; 
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px var(--primary-glow); 
            background: #000;
        }
        input[readonly], textarea[readonly] { 
            background: #18181b; 
            cursor: default; 
            border-color: transparent; 
            color: var(--text-muted); 
        }
        label { display: block; margin-bottom: 0.4rem; color: var(--text-muted); font-size: 0.75rem; font-weight: 600; letter-spacing: 0.3px; }

        /* AUTH SCREEN */
        #auth-screen { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 50% 50%, #1e1e24 0%, #000 100%); 
            z-index: 3000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem;
        }
        .auth-card { 
            width: 100%; max-width: 400px; 
            padding: 2.5rem; 
            background: var(--bg-card); 
            border-radius: 24px; 
            border: 1px solid var(--border); 
            text-align: center; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }
        .auth-card img { height: 50px; margin-bottom: 1.5rem; }

        /* LAYOUT STRUCTURE */
        #dashboard { display: flex; width: 100%; height: 100vh; overflow: hidden; position: relative; }
        
        /* SIDEBAR OVERLAY (Mobile) */
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            z-index: 850; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* SIDEBAR */
        aside { 
            width: var(--sidebar-width); 
            background: var(--bg-panel); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            z-index: 900; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed; top: var(--header-height); bottom: 0; left: 0;
        }

        /* HEADER */
        header {
            height: var(--header-height);
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 950;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-brand { font-weight: 800; font-size: 1.1rem; color: white; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .header-brand img { height: 24px; filter: brightness(0) invert(1); }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; position: relative; }
        .notification-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-panel); }
        .notif-dropdown {
            position: absolute; top: 115%; right: 0; width: 300px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; margin-top: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            display: none; flex-direction: column; padding: 0;
            z-index: 1000; max-height: 400px; overflow-y: auto;
        }
        .notif-dropdown.show { display: flex; }
        .notif-item { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .notif-item:hover { background: rgba(255,255,255,0.03); }
        .notif-item strong { color: white; display: block; margin-bottom: 2px; font-size: 0.85rem; }
        .notif-item div { color: var(--text-muted); font-size: 0.8rem; line-height: 1.4; }
        .notif-time { font-size: 0.7rem; color: #555; margin-top: 4px; display: block; }

        /* Sidebar Navigation */
        .user-mini-profile { padding: 1.5rem; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); }
        .u-info { display: flex; align-items: center; gap: 12px; }
        .u-avatar { 
            width: 40px; height: 40px; 
            background: linear-gradient(135deg, var(--primary), #6366f1); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            font-size: 1.2rem; 
            color: white; 
        }
        .u-details h4 { font-size: 0.95rem; color: white; font-weight: 700; margin-bottom: 2px; }
        .u-details p { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }

        .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-section-title { 
            padding: 1rem 1.5rem 0.5rem; 
            font-size: 0.7rem; 
            color: var(--text-dark); 
            text-transform: uppercase; 
            font-weight: 700; 
            letter-spacing: 0.8px; 
        }
        .nav-item { 
            padding: 0.85rem 1.5rem; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: 0.2s; 
            border-left: 3px solid transparent; 
            font-weight: 500;
            margin-right: 0.5rem;
            border-radius: 0 6px 6px 0;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { 
            background: var(--primary-glow); 
            color: var(--primary); 
            border-left-color: var(--primary); 
            font-weight: 600;
        }
        .nav-item i { font-size: 1.2rem; }

        /* MAIN CONTENT */
        main { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            background: var(--bg-body); 
            padding: 1.5rem; 
            position: relative; 
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
            width: 100%;
        }

        /* DASHBOARD CARDS */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 1rem; 
            margin-bottom: 2rem; 
        }
        .stat-card { 
            background: var(--bg-card); 
            padding: 1.25rem; 
            border-radius: 16px; 
            border: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 1rem;
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--border-light); }
        .stat-icon { 
            width: 48px; height: 48px; 
            border-radius: 12px; 
            background: rgba(255,255,255,0.05); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
            color: var(--text-main);
        }
        .stat-info { display: flex; flex-direction: column; }
        .stat-val { font-size: 1.5rem; font-weight: 800; color: white; line-height: 1; margin-bottom: 2px; }
        .stat-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* LIST GROUP */
        .list-group { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border); padding: 1.5rem; }
        .list-group h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .activity-item { display: flex; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
        .activity-item:last-child { border: none; }
        .activity-icon { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
        .activity-content h5 { font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 2px; }
        .activity-content p { font-size: 0.8rem; color: var(--text-muted); }
        .activity-time { margin-left: auto; font-size: 0.75rem; color: var(--text-dark); white-space: nowrap; }

        /* TABLES */
        .table-container { 
            background: var(--bg-card); 
            border-radius: 16px; 
            border: 1px solid var(--border); 
            overflow: hidden; 
            margin-bottom: 2rem; 
        }
        .table-header { 
            padding: 1rem 1.5rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255,255,255,0.02); 
            flex-wrap: wrap; gap: 10px;
        }
        .table-header h3 { font-size: 1rem; font-weight: 700; }
        .table-responsive { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { 
            text-align: left; 
            padding: 1rem; 
            color: var(--text-muted); 
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            background: rgba(0,0,0,0.2); 
            white-space: nowrap;
        }
        td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* KANBAN / TASKS */
        .kanban-board { 
            display: flex; 
            gap: 1rem; 
            height: calc(100% - 60px); 
            min-height: 600px; 
            overflow-x: auto; 
            padding-bottom: 1rem;
        }
        .kanban-col { 
            min-width: 300px; 
            width: 300px; 
            background: var(--bg-panel); 
            border-radius: 16px; 
            padding: 1rem; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0;
        }
        .kanban-header { 
            font-weight: 700; 
            margin-bottom: 1rem; 
            padding-bottom: 1rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .task-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; padding-right: 4px; min-height: 100px; }
        .task-card { 
            background: var(--bg-card); 
            padding: 1rem; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            transition: 0.2s; 
            position: relative; 
            border-left: 4px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .task-card:hover { transform: translateY(-2px); border-color: var(--text-muted); }
        .task-card.priority-High { border-left-color: var(--danger); }
        .task-card.priority-Medium { border-left-color: var(--warning); }
        .task-card.priority-Low { border-left-color: var(--success); }
        .task-card.type-ticket { border-top: 3px solid var(--ticket); }
        .task-card.type-task { border-top: 3px solid var(--info); }
        
        .task-title { font-weight: 600; margin-bottom: 4px; font-size: 0.9rem; color: white; line-height: 1.3; }
        .task-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .task-actions { 
            display: flex; 
            gap: 4px; 
            margin-top: 8px; 
            padding-top: 8px; 
            border-top: 1px solid rgba(255,255,255,0.05); 
        }
        .move-btn {
            flex: 1; padding: 4px; font-size: 0.7rem; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text-muted); border-radius: 4px; cursor: pointer;
        }
        .move-btn:hover { background: var(--bg-input); color: white; }
        
        .task-meta { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); align-items: center; }

        /* MODAL */
        .modal-overlay { 
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px); 
            z-index: 2000; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        .modal { 
            background: var(--bg-card); 
            width: 100%; 
            max-width: 500px; 
            border-radius: 20px; 
            border: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            max-height: 90vh; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .modal-header { 
            padding: 1.25rem; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: rgba(255,255,255,0.02); 
            border-radius: 20px 20px 0 0; 
        }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: white; }
        .modal-body { padding: 1.25rem; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; border-radius: 0 0 20px 20px; background: rgba(0,0,0,0.2); }

        /* TOAST */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: var(--bg-card); 
            color: white; 
            padding: 0.8rem 1.2rem; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transform: translateX(120%); 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            min-width: 280px; pointer-events: auto;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; letter-spacing: 0.5px; }
        .badge-admin { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-crew { background: rgba(59, 130, 246, 0.15); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-user { background: rgba(255,255,255,0.1); color: white; }
        .badge-voucher { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }

        /* CONFIG TAB SPECIFICS */
        .config-section { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 16px; 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .config-header { 
            font-size: 1rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            padding-bottom: 1rem; 
            border-bottom: 1px solid var(--border); 
            color: var(--text-main);
            display: flex; justify-content: space-between; align-items: center;
        }
        .toggle-switch {
            position: relative; display: inline-block; width: 44px; height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); transition: .4s; border-radius: 34px; border: 1px solid var(--border);
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); border-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .gateway-card { background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 0.5rem; }

        /* Loading State */
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* VOUCHER FILTER STYLES */
        .filter-group { display: flex; gap: 0.5rem; align-items: center; }
        .filter-select { width: auto; padding: 0.4rem 2rem; font-size: 0.85rem; }

        /* --- MOBILE RESPONSIVENESS TWEAKS --- */
        @media(min-width: 1025px) {
            aside { transform: translateX(0) !important; width: var(--sidebar-width); }
            main { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding: 2rem; }
            .sidebar-overlay { display: none !important; }
        }

        @media(max-width: 1024px) {
            aside { transform: translateX(-100%); width: 280px; box-shadow: 20px 0 40px rgba(0,0,0,0.5); }
            aside.mobile-open { transform: translateX(0); }
            main { margin-left: 0 !important; width: 100% !important; padding: 1rem; padding-top: 5rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .price-grid { grid-template-columns: 1fr; }
            .header-brand span { display: none; }
        }
    </style>
</head>
<body>

    <div class="toast-container" id="toastContainer"></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/ddnetwork/refs/heads/main/DDN%20Logo%20NoBG.png" alt="Logo">
            <h2 class="mb-4" style="color:white">Admin Portal v9.5</h2>
            <form id="loginForm">
                <input type="text" id="loginInput" class="mb-4" placeholder="Email or Crew ID" required>
                <input type="password" id="loginPass" class="mb-4" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Secure Login</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- GLOBAL HEADER -->
        <header>
            <div class="header-left">
                <button class="btn-icon" onclick="toggleSidebar()"><i class="ri-menu-line" style="font-size: 1.5rem;"></i></button>
                <div class="header-brand">
                    <img src="https://raw.githubusercontent.com/ddnetwork-ent/ddnetwork/refs/heads/main/DDN%20Logo%20NoBG.png">
                    <span>DDN v9.5</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon spin" onclick="location.reload()" title="Force Refresh"><i class="ri-refresh-line"></i></button>
                <button class="btn-icon" onclick="toggleNotifications()">
                    <i class="ri-notification-3-line" style="font-size: 1.3rem;"></i>
                    <span class="notification-dot" id="notifDot"></span>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="p-4 text-center" style="color:var(--text-muted)">Loading activity logs...</div>
                    </div>
                </button>
                <div class="u-avatar" style="width:32px; height:32px; font-size:0.9rem;" id="header-avatar">A</div>
            </div>
        </header>

        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div class="user-mini-profile">
                <div class="u-info">
                    <div class="u-avatar" id="side-avatar">A</div>
                    <div class="u-details">
                        <h4 id="side-name">Loading...</h4>
                        <p id="side-job">Loading...</p>
                    </div>
                </div>
            </div>
            
            <div class="nav-scroll">
                <div class="nav-item active" onclick="nav('overview')"><i class="ri-dashboard-line"></i> Overview</div>
                
                <div class="nav-section-title">Operations</div>
                <div class="nav-item" onclick="nav('orders')"><i class="ri-shopping-bag-3-line"></i> Orders</div>
                <div class="nav-item" onclick="nav('clients')"><i class="ri-user-line"></i> Clients</div>
                <div class="nav-item" id="nav-crew" onclick="nav('crew')"><i class="ri-team-line"></i> Internal Crew</div>
                <div class="nav-item" onclick="nav('tasks')"><i class="ri-task-line"></i> Tasks & Cases</div>
                <div class="nav-item" onclick="nav('support')"><i class="ri-customer-service-2-line"></i> Support</div>
                <div class="nav-item" onclick="nav('vouchers')"><i class="ri-ticket-2-line"></i> Vouchers</div>
                
                <div class="nav-section-title">Management</div>
                <div class="nav-item" onclick="nav('content')"><i class="ri-layout-masonry-line"></i> Content & Pkg</div>
                <div class="nav-item" onclick="nav('config')"><i class="ri-settings-4-line"></i> System Config</div>
                
                <div class="nav-section-title">Personal</div>
                <div class="nav-item" onclick="nav('my-profile')"><i class="ri-user-settings-line"></i> My Profile</div>
            </div>

            <div style="padding: 1.5rem; border-top: 1px solid var(--border);">
                <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="handleLogout()"><i class="ri-logout-box-r-line"></i> Logout</button>
            </div>
        </aside>

        <main id="main"></main>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Title</div>
                <button class="btn-icon" onclick="closeModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <script>
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
            authDomain: "ddnetwork-database.firebaseapp.com",
            projectId: "ddnetwork-database",
            storageBucket: "ddnetwork-database.firebasestorage.app",
            messagingSenderId: "699127560990",
            appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
        };
        let db, auth, currentUser, userData = null;
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth(); } catch(e) { console.log("Firebase init error", e); }

        // --- AUTO CREATE CONFIG ON LOAD ---
        async function initializeDatabase() {
            const configRef = db.collection("config").doc("site_settings");
            const doc = await configRef.get();
            
            if (!doc.exists) {
                console.log("Config not found, creating default...");
                await configRef.set({
                    maintenance_active: false,
                    maintenance_message: "We are currently performing scheduled maintenance.",
                    prices: { html: 199, frontend: 599 },
                    packageDetails: {
                        frontend: ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"],
                        ai: ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"]
                    },
                    discountActive: false,
                    discountPercent: 0.1,
                    payment_methods: [
                        { id: 'tng', name: 'TNG eWallet', url: 'https://payment.tngdigital.com.my/sc/bDLob7YcpG', active: true },
                        { id: 'fpx', name: 'Online Banking (FPX)', url: 'https://toyyibpay.com', active: true }
                    ]
                });
                showToast("Database initialized!", "success");
            }
        }

        // --- LOGGING HELPER ---
        function logActivity(msg) {
            if(!currentUser) return;
            db.collection("activity_logs").add({
                message: msg,
                actor: userData.email,
                actorName: userData.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => console.error("Log error:", e));
        }

        function formatDateTime(timestamp) {
            if(!timestamp) return '-';
            const d = timestamp instanceof Date ? timestamp : timestamp.toDate();
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        // --- SMART ID GENERATOR ---
        async function getNextId(type) {
            if(type === 'crew') {
                 try {
                     const snap = await db.collection("users").where("crewId", "!=", null).get();
                     let existingIds = [];
                     snap.forEach(doc => {
                         const id = doc.data().crewId;
                         if(id) existingIds.push(parseInt(id));
                     });
                     existingIds.sort((a,b) => a-b);
                     let nextId = 1;
                     if(existingIds.length > 0) {
                         for(let i=0; i<existingIds.length; i++) {
                             if(existingIds[i] === nextId) {
                                 nextId++;
                             } else {
                                 break;
                             }
                         }
                     }
                     return String(nextId).padStart(3, '0');
                 } catch(e) { return "001"; }
            }
            return null;
        }

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('loginInput').value.trim();
            const pass = document.getElementById('loginPass').value;
            const isCrewId = /^\d{3,}$/.test(input);
            let emailToUse = input;
            if (isCrewId) {
                const snap = await db.collection("users").where("crewId", "==", input).get();
                if (snap.empty) return showToast("Crew ID not found.", "error");
                emailToUse = snap.docs[0].data().email;
            }
            auth.signInWithEmailAndPassword(emailToUse, pass).catch(err => showToast(err.message, "error"));
        });

        auth.onAuthStateChanged((user) => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    if(doc.exists && (doc.data().role === 'admin' || doc.data().role === 'crew')) {
                        currentUser = user;
                        userData = doc.data();
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        
                        document.getElementById('side-name').innerText = userData.name;
                        document.getElementById('side-job').innerText = userData.jobTitle || userData.role;
                        document.getElementById('side-avatar').innerText = userData.name.charAt(0).toUpperCase();
                        document.getElementById('header-avatar').innerText = userData.name.charAt(0).toUpperCase();

                        if(userData.role !== 'admin') document.getElementById('nav-crew').classList.add('hidden');
                        else document.getElementById('nav-crew').classList.remove('hidden');

                        nav('overview');
                        initializeDatabase(); // Ensure DB is initialized
                    } else {
                        showToast("Access Denied", "error"); auth.signOut();
                    }
                });
            }
        });

        function handleLogout() { auth.signOut().then(() => location.reload()); }

        // --- NOTIFICATIONS ---
        function toggleNotifications() {
            const el = document.getElementById('notifDropdown');
            el.classList.toggle('show');
        }
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('notifDropdown');
            const btn = document.querySelector('.header-actions .btn-icon');
            if (!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('show');
        });

        function listenForNotifications() {
            db.collection("activity_logs").orderBy("timestamp", "desc").limit(10).onSnapshot(snap => {
                const container = document.getElementById('notifDropdown');
                if(snap.empty) {
                    container.innerHTML = '<div class="p-4 text-center" style="color:var(--text-muted)">No recent activity</div>';
                    document.getElementById('notifDot').style.display = 'none';
                    return;
                }
                document.getElementById('notifDot').style.display = 'block';
                container.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="notif-item">
                        <strong>${d.actorName || d.actor}</strong>
                        <div>${d.message}</div>
                        <span class="notif-time">${formatDateTime(d.timestamp)}</span>
                    </div>`;
                }).join('');
            });
        }

        // --- NAVIGATION ---
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            if(window.innerWidth <= 1024) {
                sb.classList.toggle('mobile-open');
                ov.classList.toggle('active');
            } else {
                const mn = document.getElementById('main');
                sb.classList.toggle('collapsed');
                mn.classList.toggle('expanded');
            }
        }

        function nav(page) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const active = document.querySelector(`.nav-item[onclick="nav('${page}')"]`);
            if(active) active.classList.add('active');
            if(window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('mobile-open');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
            
            const main = document.getElementById('main');
            main.innerHTML = '';

            switch(page) {
                case 'overview': renderOverview(); break;
                case 'orders': renderOrders(); break;
                case 'clients': renderClients(); break;
                case 'crew': renderCrew(); break;
                case 'tasks': renderTasks(); break;
                case 'support': renderSupport(); break;
                case 'vouchers': renderVouchers(); break;
                case 'content': renderContent(); break;
                case 'config': renderConfig(); break;
                case 'my-profile': renderMyProfile(); break;
            }
        }

        // --- UTILS ---
        function isAdmin() { return userData && userData.role === 'admin'; }
        function showModal(title, body, footer='') {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalFooter').innerHTML = footer;
            document.getElementById('modalOverlay').classList.add('open');
        }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
        function showToast(msg, type='info') {
            const t = document.createElement('div'); t.className = `toast ${type}`;
            const icon = type=='success'?'ri-checkbox-circle-fill':(type=='error'?'ri-error-warning-fill':'ri-information-fill');
            t.innerHTML = `<i class="${icon}" style="font-size:1.2rem; color: ${type=='success'?'var(--success)':(type=='error'?'var(--danger)':'white')}"></i> <span>${msg}</span>`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(()=>t.classList.add('show'), 10);
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 400); }, 3500);
        }

        // ---1. OVERVIEW (No Charts) ---
        function renderOverview() {
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4" style="flex-wrap: wrap; gap:10px;">
                    <h2 style="font-size:1.5rem; font-weight:800; letter-spacing:-1px;">Dashboard Overview</h2>
                    <button class="btn btn-secondary btn-sm"><i class="ri-download-cloud-2-line"></i> Export Report</button>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="list-group">
                        <h3><i class="ri-pulse-line" style="color:var(--success)"></i> Quick Actions</h3>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">
                            <button class="btn btn-secondary" onclick="nav('orders')"><i class="ri-shopping-bag-line"></i> New Order</button>
                            <button class="btn btn-secondary" onclick="nav('support')"><i class="ri-ticket-line"></i> Check Tickets</button>
                            <button class="btn btn-secondary" onclick="nav('vouchers')"><i class="ri-gift-line"></i> Assign Voucher</button>
                            <button class="btn btn-secondary" onclick="nav('crew')"><i class="ri-user-add-line"></i> Add Crew</button>
                        </div>
                    </div>
                    <div class="list-group">
                        <h3><i class="ri-history-line" style="color:var(--primary)"></i> Recent Activity</h3>
                        <div id="activity-feed">Loading...</div>
                    </div>
                </div>
            `;
            listenForNotifications();

            const promises = [
                db.collection("tickets").where("status", "in", ["Open", "In Progress"]).get(),
                db.collection("users").where("role", "==", "user").get(),
                db.collection("orders").where("status", "==", "Pending").get(),
                db.collection("orders").where("status", "==", "Paid").get()
            ];

            Promise.all(promises).then(([tSnap, uSnap, oSnapP, oSnapPaid]) => {
                const stats = [
                    { label: "Active Cases", val: tSnap.size, icon: "ri-customer-service-2-line", color: "var(--ticket)" },
                    { label: "Total Clients", val: uSnap.size, icon: "ri-user-smile-line", color: "var(--primary)" },
                    { label: "Pending Orders", val: oSnapP.size, icon: "ri-shopping-basket-2-line", color: "var(--text-muted)" },
                    { label: "Revenue (Est.)", val: `RM ${oSnapPaid.size * 300}`, icon: "ri-wallet-3-line", color: "var(--success)" }
                ];
                document.getElementById('stats-grid').innerHTML = stats.map(s => `
                    <div class="stat-card">
                        <div class="stat-icon" style="color:${s.color}; background:${s.color}15"><i class="${s.icon}"></i></div>
                        <div class="stat-info">
                            <div class="stat-val">${s.val}</div>
                            <div class="stat-label">${s.label}</div>
                        </div>
                    </div>
                `).join('');

                // Populate Activity Feed
                db.collection("activity_logs").orderBy("timestamp", "desc").limit(5).onSnapshot(snap => {
                    const feed = document.getElementById('activity-feed');
                    if(feed) {
                        feed.innerHTML = snap.docs.map(doc => {
                            const d = doc.data();
                            return `<div class="activity-item">
                                <div class="activity-icon"><i class="ri-shield-flash-line" style="color:var(--primary)"></i></div>
                                <div class="activity-content">
                                    <h5>${d.message}</h5>
                                    <p>${d.actorName || d.actor}</p>
                                </div>
                                <div class="activity-time">${formatDateTime(d.timestamp)}</div>
                            </div>`;
                        }).join('');
                    }
                });
            });
        }

        // --- 2. ORDERS (UPDATED FOR PROMO DISPLAY) ---
        function renderOrders() {
            document.getElementById('main').innerHTML += `
                <div class="table-container">
                    <div class="table-header">
                        <h3>Order Management</h3>
                        <input type="text" id="orderSearch" placeholder="Search ID, Name..." style="width:200px;" onkeyup="filterTable('orders-tbody', this.value)">
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Package</th>
                                    <th>Voucher Used</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody"></tbody>
                        </table>
                    </div>
                </div>`;
            
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
                document.getElementById('orders-tbody').innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    
                    // Requirement 2: Show if customer used promo
                    let voucherBadge = '<span style="color:var(--text-dark)">None</span>';
                    if (d.voucherCode) {
                        voucherBadge = `<span class="badge badge-voucher"><i class="ri-coupon-line"></i> ${d.voucherCode}</span>`;
                    }

                    let statusColor = '#71717a';
                    if(d.status === 'Completed') statusColor = 'var(--success)';
                    if(d.status === 'Paid') statusColor = 'var(--primary)';
                    if(d.status === 'Cancelled') statusColor = 'var(--danger)';
                    
                    return `<tr>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td><strong>${d.customerName}</strong></td>
                        <td>${d.package}</td>
                        <td>${voucherBadge}</td>
                        <td>${d.total}</td>
                        <td><span class="badge" style="background:${statusColor}20; color:${statusColor}; border:1px solid ${statusColor}40">${d.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewOrder('${doc.id}')">${isAdmin() ? 'Manage' : 'View'}</button>
                            ${isAdmin() ? `<button class="btn btn-sm btn-danger" onclick="deleteOrder('${doc.id}')"><i class="ri-delete-bin-line"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        function viewOrder(id) {
            db.collection("orders").doc(id).get().then(doc => {
                const d = doc.data();
                const isFullEdit = isAdmin();
                const readonlyAttr = isFullEdit ? '' : 'readonly';
                
                // Show voucher in modal as well
                const voucherDisplay = d.voucherCode 
                    ? `<div class="mb-4"><label>Voucher Used</label><input readonly value="${d.voucherCode}" style="color:var(--warning); border-color:var(--warning)"></div>` 
                    : '';

                showModal(`${isFullEdit ? 'Edit' : 'View'} Order #${id.substr(0,8)}`, `
                    ${voucherDisplay}
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><label class="text-muted text-sm">Name</label><input ${readonlyAttr} id="o-name" value="${d.customerName}"></div>
                        <div><label class="text-muted text-sm">Email</label><input ${readonlyAttr} id="o-email" value="${d.customerEmail}"></div>
                        <div><label class="text-muted text-sm">Phone</label><input ${readonlyAttr} id="o-phone" value="${d.customerPhone||''}"></div>
                        <div><label class="text-muted text-sm">Total</label><input ${readonlyAttr} value="${d.total}"></div>
                    </div>
                    <label class="mt-4 mb-2 block">Update Status</label>
                    <select id="upd-status">
                        <option value="Pending" ${d.status=='Pending'?'selected':''}>Pending</option>
                        <option value="Paid" ${d.status=='Paid'?'selected':''}>Paid</option>
                        <option value="Completed" ${d.status=='Completed'?'selected':''}>Completed</option>
                        <option value="Cancelled" ${d.status=='Cancelled'?'selected':''}>Cancelled</option>
                    </select>
                `, isFullEdit ? `<button class="btn btn-primary" onclick="updateOrderDetails('${id}')">Save Changes</button>` : '');
            });
        }

        function updateOrderDetails(id) {
            if(!isAdmin()) return;
            db.collection("orders").doc(id).update({
                customerName: document.getElementById('o-name').value,
                customerEmail: document.getElementById('o-email').value,
                customerPhone: document.getElementById('o-phone').value,
                status: document.getElementById('upd-status').value
            }).then(() => { 
                closeModal(); showToast("Order Updated Successfully", "success"); logActivity(`Updated full details for Order #${id.substr(0,6)}`);
            });
        }

        function deleteOrder(id) {
            if(confirm("Delete this order?")) {
                db.collection("orders").doc(id).delete().then(() => showToast("Order Deleted", "success"));
            }
        }

        // --- 3. CLIENTS ---
        function renderClients() {
            document.getElementById('main').innerHTML += `
                <div class="table-container">
                    <div class="table-header">
                        <h3>Client Directory</h3>
                        <input type="text" id="clientSearch" placeholder="Search..." style="width:200px;" onkeyup="filterTable('client-tbody', this.value)">
                    </div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Name</th><th>Company</th><th>Contact</th><th>Voucher</th><th>Actions</th></tr></thead><tbody id="client-tbody"></tbody></table>
                    </div>
                </div>`;
            
            db.collection("users").where("role", "==", "user").onSnapshot(snap => {
                document.getElementById('client-tbody').innerHTML = snap.docs.map(doc => {
                    const u = doc.data();
                    const vStatus = u.personalVoucher ? u.personalVoucher.status : 'None';
                    const vCode = u.personalVoucher ? u.personalVoucher.code : '-';
                    return `<tr>
                        <td>${u.name}</td><td>${u.company||'-'}</td><td>${u.email}<br><small style="color:var(--text-dark)">${u.phone||''}</small></td>
                        <td>${vStatus !== 'None' ? `<span class="badge" style="background:${vStatus==='active'?'var(--success)':'var(--text-dark)'}">${vCode}</span>` : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editClient('${doc.id}')">${isAdmin() ? 'Edit' : 'View'}</button>
                            ${isAdmin() ? `<button class="btn btn-sm btn-danger" onclick="resetPassword('${u.email}')">Reset PW</button>` : ''}
                            <button class="btn btn-sm btn-primary" onclick="openAssignVoucherModal('${doc.id}', '${u.name}')">Assign Voucher</button>
                        </td>
                    </tr>`;
                }).join('');
            });
        }
        function editClient(uid) {
            db.collection("users").doc(uid).get().then(doc => {
                const u = doc.data();
                const isFullEdit = isAdmin();
                const readonlyAttr = isFullEdit ? '' : 'readonly';
                showModal(isFullEdit ? "Edit Client" : "Client Details", `
                    <label>Name</label><input ${readonlyAttr} id="e-name" class="mb-4" value="${u.name}">
                    <label>Email</label><input readonly id="e-email" class="mb-4" value="${u.email}">
                    <label>Phone</label><input ${readonlyAttr} id="e-phone" class="mb-4" value="${u.phone||''}">
                    <label>Company</label><input ${readonlyAttr} id="e-comp" class="mb-4" value="${u.company||''}">
                `, isFullEdit ? `<button class="btn btn-primary" onclick="saveClient('${uid}')">Update</button>` : '');
            });
        }
        function saveClient(uid) {
            if(!isAdmin()) return;
            db.collection("users").doc(uid).update({ 
                name: document.getElementById('e-name').value, 
                phone: document.getElementById('e-phone').value, 
                company: document.getElementById('e-comp').value 
            }).then(() => { closeModal(); showToast("Client Updated", "success"); logActivity("Updated client details"); });
        }
        function resetPassword(email) {
            if(confirm(`Send reset email to ${email}?`)) {
                auth.sendPasswordResetEmail(email).then(() => showToast("Reset email sent", "success"));
            }
        }

        // --- 4. CREW MANAGEMENT ---
        function renderCrew() {
            if(!isAdmin()) return;
            document.getElementById('main').innerHTML += `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Internal Crew</h2>
                    <button class="btn btn-primary" onclick="openAddCrewModal()"><i class="ri-add-line"></i> Add Crew</button>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>Crew ID</th><th>Name</th><th>Email</th><th>Role</th><th>Job Title</th><th>Actions</th></tr></thead><tbody id="crew-tbody"></tbody></table>
                    </div>
                </div>`;
            db.collection("users").where("role", "in", ["admin", "crew"]).onSnapshot(snap => {
                document.getElementById('crew-tbody').innerHTML = snap.docs.map(doc => {
                    const u = doc.data();
                    return `<tr>
                        <td style="font-family:monospace; color:var(--primary)">${u.crewId || 'N/A'}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge badge-${u.role}">${u.role}</span></td>
                        <td>${u.jobTitle||'-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editCrew('${doc.id}')"><i class="ri-pencil-line"></i></button>
                            ${doc.id !== currentUser.uid ? `<button class="btn btn-sm btn-danger" onclick="deleteUser('${doc.id}', 'Crew')"><i class="ri-delete-bin-line"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            });
        }
        
        async function openAddCrewModal() {
            const newCrewId = await getNextId('crew');
            showModal("Add New Crew", `
                <div class="mb-4"><label>Crew ID</label><input id="c-id" value="${newCrewId}" readonly></div>
                <div class="mb-4"><label>Full Name</label><input id="c-name"></div>
                <div class="mb-4"><label>Email Address</label><input type="email" id="c-email"></div>
                <div class="flex gap-4 mb-4">
                    <div style="flex:1"><label>Role</label>
                        <select id="c-role">
                            <option value="crew">Crew</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div style="flex:1"><label>Job Title</label><input id="c-job"></div>
                </div>
                <div class="mb-4"><label>Temporary Password</label><input type="password" id="c-pass" placeholder="Set password"></div>
            `, `<button class="btn btn-primary" onclick="saveCrew('${newCrewId}')">Create Crew</button>`);
        }

        async function saveCrew(newId) {
            const name = document.getElementById('c-name').value;
            const email = document.getElementById('c-email').value;
            const pass = document.getElementById('c-pass').value;
            const role = document.getElementById('c-role').value;
            const job = document.getElementById('c-job').value;

            if(!name || !email || !pass) return showToast("Please fill all fields", "error");

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(userCredential.user.uid).set({
                    crewId: newId,
                    name: name,
                    email: email,
                    role: role,
                    jobTitle: job,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal();
                showToast("Crew created successfully", "success");
                logActivity(`Created new crew member: ${name} (${newId})`);
            } catch(e) {
                showToast(e.message, "error");
            }
        }

        function editCrew(uid) {
            db.collection("users").doc(uid).get().then(doc => {
                const u = doc.data();
                showModal("Edit Crew Member", `
                    <div class="mb-4"><label>Crew ID</label><input id="e-c-id" value="${u.crewId}"></div>
                    <div class="mb-4"><label>Full Name</label><input id="e-c-name" value="${u.name}"></div>
                    <div class="mb-4"><label>Job Title</label><input id="e-c-job" value="${u.jobTitle||''}"></div>
                    <div class="mb-4"><label>Role</label>
                        <select id="e-c-role">
                            <option value="crew" ${u.role==='crew'?'selected':''}>Crew</option>
                            <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                        </select>
                    </div>
                `, `<button class="btn btn-primary" onclick="updateCrewData('${uid}')">Save</button>`);
            });
        }

        function updateCrewData(uid) {
            db.collection("users").doc(uid).update({
                crewId: document.getElementById('e-c-id').value,
                name: document.getElementById('e-c-name').value,
                jobTitle: document.getElementById('e-c-job').value,
                role: document.getElementById('e-c-role').value
            }).then(() => {
                closeModal();
                showToast("Crew details updated", "success");
                logActivity(`Updated crew member details`);
            });
        }

        function deleteUser(uid, type) {
            if(confirm(`Permanently delete this ${type}?`)) {
                db.collection("users").doc(uid).delete().then(() => showToast(`${type} Deleted`, "success"));
            }
        }

        // --- 5. TASKS (IMPROVED) ---
        function renderTasks() {
            // Fetch all relevant data
            const tasksPromise = db.collection("tasks").orderBy("timestamp", "desc").get();
            const ticketsPromise = db.collection("tickets").orderBy("timestamp", "desc").get();

            Promise.all([tasksPromise, ticketsPromise]).then(([tSnap, tkSnap]) => {
                
                // Helper to get badge color
                const getPrioColor = (p) => p === 'High' ? 'var(--danger)' : (p === 'Medium' ? 'var(--warning)' : 'var(--success)');

                // Initialize columns
                const cols = {
                    'available': [], // Unassigned tickets/tasks
                    'my-tasks': [],   // Assigned to me
                    'in-progress': [], // Assigned to me (In Progress)
                    'done': []        // Closed/Done
                };

                // Process Tasks
                tSnap.forEach(doc => {
                    const t = doc.data();
                    const item = { id: doc.id, ...t, type: 'task' };
                    if(!t.assignedTo) cols['available'].push(item);
                    else if(t.assignedTo === currentUser.uid) {
                        if(t.status === 'Done') cols['done'].push(item);
                        else if(t.status === 'In Progress') cols['in-progress'].push(item);
                        else cols['my-tasks'].push(item);
                    } else if(isAdmin()) {
                         // Admins see everything in 'available' or correct columns, simplified here:
                         // If assigned to others, admin sees in 'available' or a separate col. 
                         // For this UI, let's put others' tasks in 'my-tasks' for Admin to view.
                         if(t.status === 'Done') cols['done'].push(item);
                         else cols['my-tasks'].push(item);
                    }
                });

                // Process Tickets
                tkSnap.forEach(doc => {
                    const t = doc.data();
                    const item = { id: doc.id, ...t, type: 'ticket' };
                    if(!t.assignedTo) cols['available'].push(item);
                    else if(t.assignedTo === currentUser.uid || isAdmin()) {
                         const status = t.status; // Open, In Progress, Closed
                         if(status === 'Closed') cols['done'].push(item);
                         else if(status === 'In Progress') cols['in-progress'].push(item);
                         else cols['my-tasks'].push(item);
                    }
                });

                // Generate HTML
                const boardHtml = `
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 style="font-size:1.25rem; font-weight:700;">Task Board</h2>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="createTask()"><i class="ri-add-line"></i> New Task</button>
                            <button class="btn btn-secondary" onclick="renderTasks()"><i class="ri-refresh-line"></i></button>
                        </div>
                    </div>
                    <div class="kanban-board">
                        <!-- COL 1: AVAILABLE -->
                        <div class="kanban-col">
                            <div class="kanban-header">Available Requests <span id="count-avail" class="badge" style="background:var(--bg-input)">0</span></div>
                            <div class="task-list" id="list-avail"></div>
                        </div>
                        <!-- COL 2: MY TASKS -->
                        <div class="kanban-col">
                            <div class="kanban-header">My Tasks (To Do) <span id="count-myt" class="badge" style="background:var(--bg-input)">0</span></div>
                            <div class="task-list" id="list-myt"></div>
                        </div>
                        <!-- COL 3: IN PROGRESS -->
                        <div class="kanban-col">
                            <div class="kanban-header">In Progress <span id="count-prog" class="badge" style="background:var(--bg-input)">0</span></div>
                            <div class="task-list" id="list-prog"></div>
                        </div>
                        <!-- COL 4: DONE -->
                        <div class="kanban-col">
                            <div class="kanban-header">Done / Closed <span id="count-done" class="badge" style="background:var(--bg-input)">0</span></div>
                            <div class="task-list" id="list-done"></div>
                        </div>
                    </div>
                `;
                document.getElementById('main').innerHTML += boardHtml;

                // Render Helper
                const renderItem = (item, containerId, btnHtml) => {
                    const div = document.createElement('div');
                    div.className = `task-card priority-${item.priority || 'Medium'} type-${item.type}`;
                    div.innerHTML = `
                        <div class="task-title">
                            ${item.type === 'ticket' ? '<i class="ri-customer-service-2-line" style="color:var(--ticket)"></i> ' : '<i class="ri-task-line" style="color:var(--info)"></i> '}
                            ${item.title || (item.type==='ticket' ? item.ticketId : '')}
                        </div>
                        <div class="task-desc">${item.desc || item.message || 'No description'}</div>
                        <div class="task-meta">
                            <span class="badge" style="background:#333">${item.type}</span>
                            <span style="color:${getPrioColor(item.priority)}">${item.priority || 'Med'}</span>
                        </div>
                        <div class="task-actions">
                            ${btnHtml}
                        </div>
                    `;
                    document.getElementById(containerId).appendChild(div);
                };

                // 1. Render Available (Accept Action)
                document.getElementById('count-avail').innerText = cols['available'].length;
                cols['available'].forEach(item => {
                    renderItem(item, 'list-avail', `<button class="move-btn" style="background:var(--success)20; color:var(--success); border-color:var(--success)" onclick="acceptTask('${item.type}', '${item.id}')">Accept Task</button>`);
                });

                // 2. Render My Tasks (Start Action)
                document.getElementById('count-myt').innerText = cols['my-tasks'].length;
                cols['my-tasks'].forEach(item => {
                    renderItem(item, 'list-myt', `
                        <button class="move-btn" onclick="updateTaskStatus('${item.type}', '${item.id}', 'In Progress')">Start <i class="ri-arrow-right-line"></i></button>
                    `);
                });

                // 3. Render In Progress (Done/Back Action)
                document.getElementById('count-prog').innerText = cols['in-progress'].length;
                cols['in-progress'].forEach(item => {
                    renderItem(item, 'list-prog', `
                        <button class="move-btn" onclick="updateTaskStatus('${item.type}', '${item.id}', 'To Do')"><i class="ri-arrow-left-line"></i></button>
                        <button class="move-btn" onclick="updateTaskStatus('${item.type}', '${item.id}', 'Done')"><i class="ri-check-line"></i> Done</button>
                    `);
                });

                // 4. Render Done (Archive/Delete)
                document.getElementById('count-done').innerText = cols['done'].length;
                cols['done'].forEach(item => {
                    renderItem(item, 'list-done', `<small style="color:var(--success)">Completed</small>`);
                });

            });
        }

        function acceptTask(type, id) {
            if(confirm("Accept this task? It will be moved to your list.")) {
                const updates = { assignedTo: currentUser.uid, assignedToName: userData.name };
                if(type === 'task') {
                    updates.status = 'To Do';
                    db.collection("tasks").doc(id).update(updates);
                } else {
                    updates.status = 'Open';
                    db.collection("tickets").doc(id).update(updates);
                }
                showToast("Task Accepted", "success");
                logActivity(`Accepted ${type} #${id}`);
            }
        }

        function updateTaskStatus(type, id, status) {
            const dbStatus = status === 'Done' && type === 'ticket' ? 'Closed' : status;
            db.collection(type === 'task' ? 'tasks' : 'tickets').doc(id).update({ 
                status: dbStatus 
            }).then(() => {
                showToast(`Moved to ${dbStatus}`, "success");
                logActivity(`Updated ${type} status to ${dbStatus}`);
            });
        }

        function createTask() {
            showModal("New Task", `
                <label class="mb-4 block">Title</label><input id="t-title" class="mb-4">
                <label class="mb-4 block">Description</label><textarea id="t-desc" class="mb-4" rows="3"></textarea>
                <div class="flex gap-4 mb-4">
                    <div style="flex:1"><label class="mb-2 block">Priority</label><select id="t-prio"><option>Low</option><option>Medium</option><option>High</option></select></div>
                </div>
            `, `<button class="btn btn-primary" onclick="saveTask()">Create Task</button>`);
        }
        function saveTask() {
            db.collection("tasks").add({ 
                title: document.getElementById('t-title').value, 
                desc: document.getElementById('t-desc').value,
                assignedTo: null, // Unassigned initially
                priority: document.getElementById('t-prio').value, 
                status: 'To Do', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            }).then(() => { closeModal(); showToast("Task Created", "success"); logActivity("Created new task"); });
        }

        // --- 6. SUPPORT (LEGACY) ---
        function renderSupport() {
            document.getElementById('main').innerHTML += `
                <button class="btn btn-secondary mb-4" onclick="openCreateTicket()"><i class="ri-add-line"></i> Create New Ticket</button>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>ID</th><th>Date</th><th>Client</th><th>Issue</th><th>Assigned To</th><th>Status</th><th>Action</th></tr></thead><tbody id="supp-tbody"></tbody></table>
                    </div>
                </div>`;
            db.collection("tickets").orderBy("timestamp", "desc").onSnapshot(snap => {
                document.getElementById('supp-tbody').innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    let statusBadge = '';
                    if(d.status === 'Closed') statusBadge = 'var(--text-dark)';
                    else if(d.status === 'In Progress') statusBadge = 'var(--primary)';
                    else statusBadge = 'var(--warning)';

                    return `<tr>
                        <td style="font-family:monospace; color:var(--ticket)">${d.ticketId || doc.id}</td>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td>${d.name}</td><td>${d.type}</td>
                        <td>${d.assignedToName || 'Unassigned'}</td>
                        <td><span class="badge" style="background:${statusBadge}20; color:${statusBadge}">${d.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewTicket('${doc.id}')">Manage</button>
                            ${isAdmin() ? `<button class="btn btn-sm btn-danger" onclick="deleteItem('ticket','${doc.id}')"><i class="ri-delete-bin-line"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        async function openCreateTicket() {
            const newId = await getNextId('ticket');
            showModal("Create Support Ticket", `
                <div class="mb-4"><label>Generated ID</label><input value="${newId}" readonly></div>
                <div class="mb-4"><label>Client Name</label><input id="tk-name"></div>
                <div class="mb-4"><label>Issue Type</label><select id="tk-type"><option>Technical</option><option>Billing</option><option>Other</option></select></div>
                <div class="mb-4"><label>Details</label><textarea id="tk-msg"></textarea></div>
            `, `<button class="btn btn-primary" onclick="saveNewTicket('${newId}')">Create</button>`);
        }

        function saveNewTicket(id) {
            db.collection("tickets").doc(id).set({ 
                ticketId: id, 
                name: document.getElementById('tk-name').value, 
                type: document.getElementById('tk-type').value, 
                message: document.getElementById('tk-msg').value, 
                status: 'Open', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            }).then(() => closeModal());
        }

        function viewTicket(id) {
            db.collection("tickets").doc(id).get().then(doc => {
                const d = doc.data();
                db.collection("users").where("role", "in", ["admin", "crew"]).get().then(snap => {
                    const crewOpts = snap.docs.map(c => `<option value="${c.id}" ${d.assignedTo===c.id?'selected':''}>${c.data().name}</option>`).join('');
                    
                    showModal(`Ticket: ${d.ticketId || id}`, `
                        <p class="mb-4 p-4" style="background:var(--bg-panel); border-radius:8px; border:1px solid var(--border)">${d.message}</p>
                        <div class="flex gap-4 mb-4">
                            <div style="flex:1"><label>Status</label>
                                <select id="tk-status">
                                    <option value="Open" ${d.status=='Open'?'selected':''}>Open</option>
                                    <option value="In Progress" ${d.status=='In Progress'?'selected':''}>In Progress</option>
                                    <option value="Closed" ${d.status=='Closed'?'selected':''}>Closed</option>
                                </select>
                            </div>
                            <div style="flex:1"><label>Assign To Crew</label>
                                <select id="tk-assign">
                                    <option value="">Unassigned</option>
                                    ${crewOpts}
                                </select>
                            </div>
                        </div>
                    `, `<button class="btn btn-primary" onclick="saveTicketDetails('${id}')">Save Changes</button>`);
                });
            });
        }
        function saveTicketDetails(id) {
            const newStatus = document.getElementById('tk-status').value;
            const newAssignId = document.getElementById('tk-assign').value;
            const newAssignName = newAssignId ? document.getElementById('tk-assign').options[document.getElementById('tk-assign').selectedIndex].text : "";
            
            db.collection("tickets").doc(id).update({
                status: newStatus,
                assignedTo: newAssignId || null,
                assignedToName: newAssignName
            }).then(() => { closeModal(); showToast("Ticket Updated", "success"); logActivity(`Updated Ticket #${id}`); });
        }

        // --- 7. VOUCHERS ---
        let currentVoucherFilter = 'All'; 

        async function renderVouchers() {
            if(!isAdmin()) return;
            document.getElementById('main').innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 style="font-size:1.25rem; font-weight:700;">Voucher Management</h3>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="openAssignVoucherModal(null, null)"><i class="ri-add-line"></i> Assign New</button>
                        <button class="btn btn-secondary" onclick="renderVouchers()"><i class="ri-refresh-line"></i> Sync Data</button>
                    </div>
                </div>
                
                <div class="table-container" style="min-height: 200px; display:flex; justify-content:center; align-items:center;">
                    <div id="voucher-loader" class="loading-spinner"></div>
                </div>

                <div class="table-container hidden" id="active-vouchers-container">
                    <div class="table-header"><h3>Active Vouchers</h3></div>
                    <div class="table-responsive">
                        <table><thead><tr><th>User</th><th>Code</th><th>Status</th><th>Value</th><th>Expiry</th><th>Actions</th></tr></thead><tbody id="vouch-active"></tbody></table>
                    </div>
                </div>

                <div class="table-container hidden" id="history-vouchers-container">
                    <div class="table-header">
                        <div class="flex items-center gap-4">
                            <h3>Voucher History</h3>
                            <div class="filter-group">
                                <select id="voucher-filter" class="filter-select" onchange="updateHistoryFilter(this.value)">
                                    <option value="All">Show All</option>
                                    <option value="Redeemed">Redeemed Only</option>
                                    <option value="Expired">Expired Only</option>
                                    <option value="Disabled">Disabled Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Code</th><th>User</th><th>Status</th><th>Date Moved</th><th>Actions</th></tr></thead><tbody id="vouch-history"></tbody></table>
                    </div>
                </div>
            `;

            await syncVoucherLogic();

            document.getElementById('voucher-loader').parentElement.classList.add('hidden');
            document.getElementById('active-vouchers-container').classList.remove('hidden');
            document.getElementById('history-vouchers-container').classList.remove('hidden');

            // Render Active
            db.collection("users").where("personalVoucher", "!=", null).onSnapshot(snap => {
                const tbody = document.getElementById('vouch-active');
                if(!tbody) return;
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const u = doc.data();
                    const v = u.personalVoucher;
                    const vStatus = v.status ? v.status : 'Active';
                    let statusColor = 'var(--success)';
                    const statusLower = vStatus.toLowerCase();
                    if (statusLower === 'suspended') statusColor = 'var(--danger)';
                    
                    tbody.innerHTML += `<tr>
                        <td>${u.name}</td>
                        <td style="font-family:monospace; color:var(--primary)">${v.code}</td>
                        <td>
                            <span class="badge" style="background:${statusColor}20; color:${statusColor}; border:1px solid ${statusColor}40">
                                ${vStatus}
                            </span>
                        </td>
                        <td>${v.type=='fixed'?'RM '+v.value:v.value*100+'%'}</td>
                        <td>${v.expiryDate ? new Date(v.expiryDate.seconds*1000).toLocaleDateString() : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editVoucher('${doc.id}', '${v.code}')">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="markRedeem('${doc.id}', '${v.code}')"><i class="ri-check-double-line"></i> Mark Redeemed</button>
                            <button class="btn btn-sm btn-danger" onclick="disableVoucher('${doc.id}', '${v.code}')"><i class="ri-delete-bin-line"></i> Disable</button>
                        </td>
                    </tr>`;
                });
            });

            // Render History
            const updateHistoryListener = (filterVal) => {
                db.collection("vouchers_history").orderBy("movedAt", "desc").limit(50).onSnapshot(snap => {
                    const tbody = document.getElementById('vouch-history');
                    if(!tbody) return;
                    tbody.innerHTML = '';
                    snap.forEach(doc => {
                        const v = doc.data();
                        if(filterVal !== 'All' && v.status !== filterVal) return;

                        let actionBtn = '';
                        if (v.status === 'Redeemed') actionBtn = `<small style="color:var(--text-dark)">Locked</small>`;
                        else actionBtn = `<button class="btn btn-sm btn-success" onclick="restoreVoucher('${v.code}', '${v.ownerUid}')">Restore</button>`;
                        
                        let statusColor = 'var(--text-dark)';
                        if (v.status === 'Redeemed') statusColor = 'var(--success)';
                        if (v.status === 'Expired') statusColor = 'var(--warning)'; 
                        if (v.status === 'Disabled') statusColor = 'var(--text-dark)';

                        tbody.innerHTML += `<tr>
                            <td style="font-family:monospace">${v.code}</td>
                            <td>${v.assignedToName || '-'}</td>
                            <td><span class="badge" style="background:${statusColor}20; color:${statusColor}">${v.status}</span></td>
                            <td>${v.movedAt ? formatDateTime(v.movedAt) : '-'}</td>
                            <td>${actionBtn}</td>
                        </tr>`;
                    });
                });
            };
            updateHistoryListener(currentVoucherFilter);
        }

        window.updateHistoryFilter = (val) => {
            currentVoucherFilter = val;
        };

        async function syncVoucherLogic() {
            const usersSnap = await db.collection("users").where("personalVoucher", "!=", null).get();
            if(usersSnap.empty) return;

            let movedCount = 0;
            for (const userDoc of usersSnap.docs) {
                const uid = userDoc.id;
                const uData = userDoc.data();
                const vouch = uData.personalVoucher;
                const code = vouch.code;
                
                let moveToHistory = false;
                let statusReason = "";

                if(vouch.expiryDate) {
                    const expDate = vouch.expiryDate.toDate ? vouch.expiryDate.toDate() : new Date(vouch.expiryDate);
                    if(new Date() > expDate) {
                        moveToHistory = true;
                        statusReason = "Expired";
                    }
                }

                const currentStatus = (vouch.status || '').toLowerCase();
                if (currentStatus === 'redeemed' && !moveToHistory) {
                    moveToHistory = true;
                    statusReason = "Redeemed";
                } else if (currentStatus === 'disabled' && !moveToHistory) {
                    moveToHistory = true;
                    statusReason = "Disabled";
                }

                if(moveToHistory) {
                    await db.collection("vouchers_history").doc(code).set({
                        ...vouch,
                        ownerUid: uid,
                        assignedToName: uData.name,
                        status: statusReason,
                        movedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection("users").doc(uid).update({
                        personalVoucher: firebase.firestore.FieldValue.delete()
                    });
                    console.log(`Moved ${code} to history as ${statusReason}`);
                    movedCount++;
                }
            }
            if(movedCount > 0) showToast(`Synced ${movedCount} vouchers to history`, "success");
        }

        function editVoucher(uid, code) {
            db.collection("users").doc(uid).get().then(doc => {
                const v = doc.data().personalVoucher;
                const exp = v.expiryDate ? new Date(v.expiryDate.seconds*1000).toISOString().split('T')[0] : '';
                const currentStatus = v.status ? v.status : 'Active';
                
                showModal(`Edit Voucher ${code}`, `
                    <label>Code</label><input id="e-v-code" value="${v.code}" class="mb-4">
                    <label>Status</label>
                    <select id="e-v-status" class="mb-4">
                        <option value="Active" ${currentStatus==='Active'?'selected':''}>Active</option>
                        <option value="Suspended" ${currentStatus==='Suspended'?'selected':''}>Suspended</option>
                    </select>
                    <label>Value</label><input type="number" id="e-v-val" value="${v.value}" class="mb-4">
                    <label>Expiry Date</label><input type="date" id="e-v-exp" value="${exp}" class="mb-4">
                `, `<button class="btn btn-primary" onclick="saveEditVoucher('${uid}')">Save</button>`);
            });
        }

        function saveEditVoucher(uid) {
            const newCode = document.getElementById('e-v-code').value.toUpperCase();
            const newStatus = document.getElementById('e-v-status').value;
            
            db.collection("users").doc(uid).get().then(doc => {
                const v = doc.data().personalVoucher;
                db.collection("users").doc(uid).update({
                    personalVoucher: { 
                        ...v, 
                        code: newCode, 
                        value: parseFloat(document.getElementById('e-v-val').value), 
                        expiryDate: document.getElementById('e-v-exp').value ? new Date(document.getElementById('e-v-exp').value) : null,
                        status: newStatus 
                    }
                }).then(() => { closeModal(); showToast("Voucher Updated", "success"); logActivity(`Edited voucher ${newCode}`); });
            });
        }

        async function markRedeem(uid, code) {
            if(!confirm(`Mark voucher ${code} as Redeemed? This will move it to History.`)) return;
            
            const userDoc = await db.collection("users").doc(uid).get();
            const uData = userDoc.data();
            const vouch = uData.personalVoucher;

            await db.collection("vouchers_history").doc(code).set({
                ...vouch,
                ownerUid: uid,
                assignedToName: uData.name,
                status: "Redeemed",
                movedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
            showToast("Voucher Redeemed", "success");
            logActivity(`Marked voucher ${code} as Redeemed`);
        }

        async function disableVoucher(uid, code) {
            if(!confirm(`Disable voucher ${code}? This will move it to History.`)) return;
            
            const userDoc = await db.collection("users").doc(uid).get();
            const uData = userDoc.data();
            const vouch = uData.personalVoucher;

            await db.collection("vouchers_history").doc(code).set({
                ...vouch,
                ownerUid: uid,
                assignedToName: uData.name,
                status: "Disabled",
                movedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
            showToast("Voucher Disabled", "info");
            logActivity(`Disabled voucher ${code}`);
        }

        function openAssignVoucherModal(uid, userName) {
            const promise = uid ? Promise.resolve(null) : db.collection("users").where("role", "==", "user").get();
            promise.then(snap => {
                let userSelect = '';
                if(snap) {
                    userSelect = `<label>Select Client</label><select id="v-user" class="mb-4">${snap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('')}</select>`;
                } else {
                    userSelect = `<input type="hidden" id="v-user" value="${uid}">`;
                }
                const autoCode = `GIFT-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
                showModal("Assign Voucher", `
                    ${userSelect}
                    <div class="mb-4"><label>Code</label><input id="v-code" value="${autoCode}"></div>
                    <div class="flex gap-4 mb-4">
                        <div style="flex:1"><label>Type</label><select id="v-val-type"><option value="fixed">Fixed (RM)</option><option value="percent">Percent (%)</option></select></div>
                        <div style="flex:1"><label>Value</label><input type="number" id="v-val"></div>
                    </div>
                    <label>Expiry Date</label><input type="date" id="v-exp" class="mb-4">
                `, `<button class="btn btn-primary" onclick="submitAssignVoucher()">Assign</button>`);
            });
        }
        function submitAssignVoucher() {
            const uid = document.getElementById('v-user').value;
            const code = document.getElementById('v-code').value.toUpperCase();
            db.collection("users").doc(uid).update({ personalVoucher: {
                code: code, type: document.getElementById('v-val-type').value, value: parseFloat(document.getElementById('v-val').value), expiryDate: document.getElementById('v-exp').value ? new Date(document.getElementById('v-exp').value) : null, status: 'active', auditLog: [{ action: 'Created', by: userData.email, date: new Date().toISOString() }]
            }}).then(() => { closeModal(); showToast(`Voucher ${code} Assigned!`, "success"); logActivity(`Assigned voucher ${code}`); });
        }

        function restoreVoucher(code, ownerUid) {
            if(!confirm("Restore this voucher? It will move back to Active list.")) return;
            db.collection("vouchers_history").doc(code).get().then(hist => {
                if(!hist.exists) return showToast("Error", "error");
                const v = hist.data();
                db.collection("users").doc(ownerUid).update({ personalVoucher: { ...v, status: 'active' } }).then(() => {
                    db.collection("vouchers_history").doc(code).delete().then(() => { showToast("Voucher Restored", "success"); logActivity(`Restored voucher ${code}`); });
                });
            });
        }

        // --- 8. CONTENT & PACKAGES (SYNCED) ---
        function renderContent() {
            if(!isAdmin()) return;
            
            db.collection("config").doc("site_settings").get().then(doc => {
                const siteData = doc.exists ? doc.data() : {};
                const packages = siteData.packageDetails || {};
                
                const frontendFeatures = (packages.frontend && packages.frontend.features) 
                    ? packages.frontend.features 
                    : ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"];
                const aiFeatures = (packages.ai && packages.ai.features)
                    ? packages.ai.features
                    : ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"];

                document.getElementById('main').innerHTML += `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:700;">Content & Packages</h2>
                    <button class="btn btn-primary" onclick="saveContentChanges()"><i class="ri-save-line"></i> Save Changes</button>
                </div>
                
                <div class="config-section">
                    <h3 style="margin-bottom:1rem;">Frontend Package Features</h3>
                    <p class="mb-4 text-sm text-muted">Edit the feature list displayed on the main website.</p>
                    <textarea id="content-frontend" rows="6">${frontendFeatures.join('\n')}</textarea>
                </div>

                <div class="config-section">
                    <h3 style="margin-bottom:1rem;">AI Package Features</h3>
                    <p class="mb-4 text-sm text-muted">Edit the feature list displayed on the main website.</p>
                    <textarea id="content-ai" rows="6">${aiFeatures.join('\n')}</textarea>
                </div>
            `;
            });
        }

        function saveContentChanges() {
            const frontendLines = document.getElementById('content-frontend').value.split('\n').filter(l => l.trim() !== '');
            const aiLines = document.getElementById('content-ai').value.split('\n').filter(l => l.trim() !== '');

            db.collection("config").doc("site_settings").get().then(doc => {
                const data = doc.exists ? doc.data() : {};
                const newPkgDetails = data.packageDetails || {};
                
                newPkgDetails.frontend = { features: frontendLines };
                newPkgDetails.ai = { features: aiLines };

                db.collection("config").doc("site_settings").update({
                    packageDetails: newPkgDetails
                }).then(() => {
                    showToast("Content updated successfully!", "success");
                    logActivity("Updated website content features");
                });
            });
        }

        // --- 9. CONFIG (SYNCED) ---
        function renderConfig() {
            if(!isAdmin()) return;
            document.getElementById('main').innerHTML = `
                <h2 style="font-size:1.25rem; font-weight:700; margin-bottom:1.5rem;">System Configuration</h2>
                
                <!-- Maintenance -->
                <div class="config-section">
                    <div class="config-header flex justify-between">
                        <span>Maintenance Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="maint-toggle" onchange="toggleMaintenance()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p class="text-muted text-sm mb-4">Toggle a warning banner on the main site and restrict access.</p>
                    <div class="mb-4">
                        <label>Maintenance Message</label>
                        <textarea id="maint-msg" class="mb-2" rows="3">We are currently performing scheduled maintenance.</textarea>
                        <button class="btn btn-sm btn-secondary" onclick="saveMaintMsg()">Update Message</button>
                    </div>
                </div>

                <!-- Dynamic Pricing -->
                <div class="config-section">
                    <div class="config-header">Dynamic Pricing Override</div>
                    <p class="text-muted text-sm mb-4">Base prices for different modules (Syncs with Main Site).</p>
                    <div class="price-grid">
                        <div>
                            <label>HTML Package Price</label>
                            <div class="flex gap-2">
                                <input id="price-html" type="number">
                                <button class="btn btn-primary" onclick="savePrice('html', 'price-html')">Save</button>
                            </div>
                        </div>
                        <div>
                            <label>Frontend Package Price</label>
                            <div class="flex gap-2">
                                <input id="price-fe" type="number">
                                <button class="btn btn-primary" onclick="savePrice('frontend', 'price-fe')">Save</button>
                            </div>
                        </div>
                        <div>
                            <label>AI/Data Price (Base)</label>
                            <div class="flex gap-2">
                                <input id="price-ai" type="number">
                                <button class="btn btn-primary" onclick="savePrice('ai', 'price-ai')">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Gateways -->
                <div class="config-section">
                    <div class="config-header flex justify-between">
                        <span>Payment Gateways</span>
                        <button class="btn btn-sm btn-primary" onclick="addGateway()"><i class="ri-add-line"></i> Add Gateway</button>
                    </div>
                    <div id="gateway-list" class="flex flex-col gap-4"></div>
                </div>
            `;

            db.collection("config").doc("site_settings").get().then(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    if(d.maintenance_active) document.getElementById('maint-toggle').checked = true;
                    if(d.maintenance_message) document.getElementById('maint-msg').value = d.maintenance_message;
                    
                    if(d.prices) {
                        if(d.prices.html) document.getElementById('price-html').value = d.prices.html;
                        if(d.prices.frontend) document.getElementById('price-fe').value = d.prices.frontend;
                        if(d.prices.ai) document.getElementById('price-ai').value = d.prices.ai;
                    }
                    
                    if(d.payment_methods) {
                        const list = document.getElementById('gateway-list');
                        list.innerHTML = '';
                        d.payment_methods.forEach((gw, idx) => {
                            list.innerHTML += `
                            <div class="gateway-card">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="color:var(--primary)">${gw.name}</strong>
                                    <span class="badge ${gw.active?'badge-success':'badge-danger'}" style="${gw.active?'background:rgba(16,185,129,0.1);color:#10b981':'background:rgba(239,68,68,0.1);color:#ef4444'}">${gw.active?'Active':'Inactive'}</span>
                                </div>
                                <div class="text-sm text-muted" style="word-break:break-all;">${gw.link || 'No Link'}</div>
                                <div style="display:flex; gap:8px; margin-top:8px;">
                                    <button class="btn btn-sm btn-secondary" onclick="editGateway(${idx})"><i class="ri-pencil-line"></i></button>
                                    <button class="btn btn-sm btn-secondary" onclick="toggleGatewayStatus(${idx})"><i class="ri-refresh-line"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteGateway(${idx})"><i class="ri-delete-bin-line"></i></button>
                                </div>
                            </div>`;
                        });
                    }
                }
            });
        }

        function toggleMaintenance() {
            const isActive = document.getElementById('maint-toggle').checked;
            db.collection("config").doc("site_settings").update({ maintenance_active: isActive }).then(() => {
                showToast(`Maintenance Mode ${isActive ? 'Enabled' : 'Disabled'}`, isActive?'warning':'success');
                logActivity(`Toggled maintenance mode to ${isActive}`);
            });
        }
        function saveMaintMsg() {
            db.collection("config").doc("site_settings").update({ maintenance_message: document.getElementById('maint-msg').value }).then(() => showToast("Message Saved", "success"));
        }
        function savePrice(key, elemId) {
            const val = parseFloat(document.getElementById(elemId).value);
            if(!val) return showToast("Invalid price", "error");
            db.collection("config").doc("site_settings").update({ [`prices.${key}`]: val }).then(() => showToast("Price Updated", "success"));
        }
        
        function addGateway() {
            showModal("Add Payment Gateway", `
                <label>Gateway Name</label><input id="gw-name" class="mb-4">
                <label>Payment Link / URL</label><input id="gw-link" class="mb-4">
            `, `<button class="btn btn-primary" onclick="saveNewGateway()">Add</button>`);
        }
        async function saveNewGateway() {
            const name = document.getElementById('gw-name').value;
            const link = document.getElementById('gw-link').value;
            const doc = await db.collection("config").doc("site_settings").get();
            const list = doc.exists && doc.data().payment_methods ? doc.data().payment_methods : [];
            list.push({ name, link, active: true });
            await db.collection("config").doc("site_settings").update({ payment_methods: list });
            closeModal();
            renderConfig();
        }
        
        function editGateway(idx) {
            db.collection("config").doc("site_settings").get().then(doc => {
                const list = doc.data().payment_methods;
                const gw = list[idx];
                showModal("Edit Payment Gateway", `
                    <label>Gateway Name</label><input id="e-gw-name" value="${gw.name}" class="mb-4">
                    <label>Payment Link / URL</label><input id="e-gw-link" value="${gw.link}" class="mb-4">
                `, `<button class="btn btn-primary" onclick="saveEditedGateway(${idx})">Save</button>`);
            });
        }
        
        async function saveEditedGateway(idx) {
            const name = document.getElementById('e-gw-name').value;
            const link = document.getElementById('e-gw-link').value;
            
            const doc = await db.collection("config").doc("site_settings").get();
            const list = doc.data().payment_methods;
            
            list[idx].name = name;
            list[idx].link = link;
            
            await db.collection("config").doc("site_settings").update({ payment_methods: list });
            closeModal();
            renderConfig();
            showToast("Gateway Updated", "success");
            logActivity(`Edited payment gateway: ${name}`);
        }
        
        async function toggleGatewayStatus(idx) {
            const doc = await db.collection("config").doc("site_settings").get();
            const list = doc.data().payment_methods;
            list[idx].active = !list[idx].active;
            await db.collection("config").doc("site_settings").update({ payment_methods: list });
            renderConfig();
        }
        async function deleteGateway(idx) {
            if(!confirm("Delete gateway?")) return;
            const doc = await db.collection("config").doc("site_settings").get();
            const list = doc.data().payment_methods;
            list.splice(idx, 1);
            await db.collection("config").doc("site_settings").update({ payment_methods: list });
            renderConfig();
        }

        // --- 10. PROFILE ---
        function renderMyProfile() {
            document.getElementById('main').innerHTML += `
                <div class="p-4" style="background:var(--bg-card); border:1px solid var(--border); border-radius:16px; max-width:500px; margin:0 auto;">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="u-avatar" style="width:50px; height:50px; font-size:1.5rem;">${userData.name.charAt(0)}</div>
                        <div>
                            <h2 style="font-size:1.25rem;">${userData.name}</h2>
                            <span class="badge badge-${userData.role}">${userData.role}</span>
                        </div>
                    </div>
                    <div class="mb-4"><label class="text-muted">Name</label><input value="${userData.name}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Email</label><input value="${userData.email}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Crew ID</label><input value="${userData.crewId || 'N/A'}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Job Title</label><input value="${userData.jobTitle||'N/A'}" readonly></div>
                </div>`;
        }

        function filterTable(id, text) {
            const trs = document.querySelectorAll(`#${id} tr`);
            text = text.toLowerCase();
            trs.forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(text)?'':'none');
        }
    </script>
</body>
</html>
